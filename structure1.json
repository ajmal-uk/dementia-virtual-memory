{
  "lib": {
    "admin": {
      "settings_screen.dart": {
        "_text": "import 'package:firebase_auth/firebase_auth.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport '../welcome_page.dart';\n\nclass AdminSettingsScreen extends StatefulWidget {\n  const AdminSettingsScreen({super.key});\n\n  @override\n  State<AdminSettingsScreen> createState() => _AdminSettingsScreenState();\n}\n\nclass _AdminSettingsScreenState extends State<AdminSettingsScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  final _emailController = TextEditingController();\n  final _adminPasswordController = TextEditingController();\n  final _apiUrlController = TextEditingController();\n\n  String? _currentApiUrl;\n  final String _apiDocId = 'qHsy9xZJJanFlWFDx7ag';\n\n  @override\n  void initState() {\n    super.initState();\n    _fetchApiUrl();\n  }\n\n  Future<void> _fetchApiUrl() async {\n    try {\n      final doc = await _firestore.collection('api').doc(_apiDocId).get();\n      if (doc.exists) {\n        setState(() {\n          _currentApiUrl = doc.data()?['apiURL'];\n          _apiUrlController.text = _currentApiUrl ?? '';\n        });\n      } else {\n        debugPrint('API document not found.');\n      }\n    } catch (e) {\n      debugPrint('Error fetching API URL: $e');\n    }\n  }\n\n  Future<void> _updateApiUrl() async {\n    final newUrl = _apiUrlController.text.trim();\n    if (newUrl.isEmpty) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Please enter a valid API URL')),\n      );\n      return;\n    }\n\n    try {\n      // only update the existing document (no creation)\n      await _firestore.collection('api').doc(_apiDocId).update({\n        'apiURL': newUrl,\n      });\n\n      setState(() {\n        _currentApiUrl = newUrl;\n      });\n\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('API URL updated successfully')),\n      );\n    } catch (e) {\n      // if document doesn't exist, show error instead of creating\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Error updating API URL: $e')),\n      );\n    }\n  }\n\n  Future<void> _logout() async {\n    await _auth.signOut();\n    Navigator.pushReplacement(\n      context,\n      MaterialPageRoute(builder: (context) => const WelcomePage()),\n    );\n  }\n\n  Future<void> _addAdmin() async {\n    final email = _emailController.text.trim();\n    final password = _adminPasswordController.text.trim();\n\n    if (email.isEmpty || password.isEmpty) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Please fill in all fields')),\n      );\n      return;\n    }\n\n    try {\n      final credential = await _auth.createUserWithEmailAndPassword(\n        email: email,\n        password: password,\n      );\n      final uid = credential.user?.uid;\n      if (uid != null) {\n        await _firestore.collection('admin').doc(uid).set({\n          'email': email,\n          'createdAt': Timestamp.now(),\n        });\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Admin added successfully')),\n        );\n      }\n    } catch (e) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Error adding admin: $e')),\n      );\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text('Settings'), backgroundColor: Colors.blue),\n      body: ListView(\n        padding: const EdgeInsets.all(16),\n        children: [\n          // Logout card\n          Card(\n            elevation: 4,\n            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n            child: ListTile(\n              leading: const Icon(Icons.logout, color: Colors.red),\n              title: const Text('Logout', style: TextStyle(fontWeight: FontWeight.bold)),\n              trailing: const Icon(Icons.arrow_forward_ios),\n              onTap: _logout,\n            ),\n          ),\n\n          const SizedBox(height: 8),\n\n          // Add Admin section\n          Card(\n            elevation: 4,\n            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n            child: ExpansionTile(\n              leading: const Icon(Icons.add_moderator, color: Colors.green),\n              title: const Text('Add Admin', style: TextStyle(fontWeight: FontWeight.bold)),\n              children: [\n                Padding(\n                  padding: const EdgeInsets.all(16),\n                  child: Column(\n                    children: [\n                      TextField(\n                        controller: _emailController,\n                        decoration: const InputDecoration(labelText: 'Email'),\n                      ),\n                      TextField(\n                        controller: _adminPasswordController,\n                        obscureText: true,\n                        decoration: const InputDecoration(labelText: 'Password'),\n                      ),\n                      const SizedBox(height: 16),\n                      ElevatedButton(\n                        onPressed: _addAdmin,\n                        child: const Text('Add Admin'),\n                      ),\n                    ],\n                  ),\n                ),\n              ],\n            ),\n          ),\n\n          const SizedBox(height: 8),\n\n          // Update API URL section\n          Card(\n            elevation: 4,\n            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n            child: ExpansionTile(\n              leading: const Icon(Icons.api, color: Colors.blue),\n              title: const Text('Change API URL', style: TextStyle(fontWeight: FontWeight.bold)),\n              subtitle: Text(_currentApiUrl ?? 'No API URL set'),\n              children: [\n                Padding(\n                  padding: const EdgeInsets.all(16),\n                  child: Column(\n                    children: [\n                      TextField(\n                        controller: _apiUrlController,\n                        decoration: const InputDecoration(labelText: 'New API URL'),\n                      ),\n                      const SizedBox(height: 16),\n                      ElevatedButton(\n                        onPressed: _updateApiUrl,\n                        child: const Text('Update API URL'),\n                      ),\n                    ],\n                  ),\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n",
        "_encoding": "utf-8"
      }
    },
    "user": {
      "caretaker": {
        "caretaker_detail_screen.dart": {
          "_text": "// lib/user/caretaker/caretaker_detail_screen.dart\nimport 'package:flutter/material.dart';\nimport 'package:url_launcher/url_launcher.dart';\n\nclass CaretakerDetailScreen extends StatelessWidget {\n  final String caretakerUid;\n  final Map<String, dynamic> caretakerData;\n  final VoidCallback onConnect;\n\n  const CaretakerDetailScreen({\n    super.key,\n    required this.caretakerUid,\n    required this.caretakerData,\n    required this.onConnect,\n  });\n\n  Widget _buildNurseBadge() {\n    return Positioned(\n      top: 0,\n      right: 0,\n      child: Container(\n        padding: const EdgeInsets.all(4),\n        decoration: const BoxDecoration(\n          color: Colors.blue,\n          shape: BoxShape.circle,\n        ),\n        child: const Icon(\n          Icons.local_hospital,\n          size: 16,\n          color: Colors.white,\n        ),\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isNurse = caretakerData['caregiverType'] == 'nurse';\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(caretakerData['fullName'] ?? 'Caretaker'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              Center(\n                child: Stack(\n                  children: [\n                    CircleAvatar(\n                      radius: 60,\n                      backgroundColor: Colors.grey[300],\n                      backgroundImage: (caretakerData['profileImageUrl'] != null &&\n                              caretakerData['profileImageUrl'].toString().isNotEmpty)\n                          ? NetworkImage(caretakerData['profileImageUrl'])\n                          : null,\n                      child: (caretakerData['profileImageUrl'] == null ||\n                              caretakerData['profileImageUrl'].toString().isEmpty)\n                          ? const Icon(Icons.person, size: 60, color: Colors.blueAccent)\n                          : null,\n                    ),\n                    if (isNurse) _buildNurseBadge(),\n                  ],\n                ),\n              ),\n              const SizedBox(height: 16),\n              Center(\n                child: Column(\n                  children: [\n                    Text(\n                      caretakerData['fullName'] ?? 'Unnamed',\n                      style: const TextStyle(\n                          fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n                    ),\n                    Text(\n                      '@${caretakerData['username'] ?? ''}',\n                      style: const TextStyle(fontSize: 16, color: Colors.grey),\n                    ),\n                  ],\n                ),\n              ),\n              const SizedBox(height: 24),\n              Card(\n                elevation: 3,\n                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                child: Padding(\n                  padding: const EdgeInsets.all(16.0),\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      _buildInfoRow(context, Icons.info_outline, 'Bio', caretakerData['bio'] ?? ''),\n                      _buildInfoRow(context, Icons.location_city, 'City', caretakerData['city'] ?? ''),\n                      _buildInfoRow(context, Icons.phone, 'Phone', caretakerData['phoneNo'] ?? ''),\n                      if (isNurse) ...[\n                        _buildInfoRow(context, Icons.work_history, 'Experience Years',\n                            '${caretakerData['experienceYears'] ?? 0} years'),\n                        _buildInfoRow(context, Icons.description, 'Experience Bio',\n                            caretakerData['experienceBio'] ?? ''),\n                        _buildInfoRow(context, Icons.school, 'Nursing Qualification',\n                            caretakerData['graduationOnNursing'] ?? ''),\n                        if (caretakerData['graduationCertificateUrl']?.isNotEmpty ?? false)\n                          _buildInfoRow(\n                              context, Icons.picture_as_pdf, 'Certificate', 'View Certificate'),\n                      ] else\n                        _buildInfoRow(\n                            context, Icons.family_restroom, 'Relation', caretakerData['relation'] ?? ''),\n                    ],\n                  ),\n                ),\n              ),\n              const SizedBox(height: 24),\n              Row(\n                children: [\n                  Expanded(\n                    child: ElevatedButton.icon(\n                      onPressed: () async {\n                        final phone = caretakerData['phoneNo'];\n                        if (phone != null && phone.isNotEmpty) {\n                          final url = Uri.parse('tel:$phone');\n                          if (await canLaunchUrl(url)) {\n                            await launchUrl(url);\n                          } else if (context.mounted) {\n                            ScaffoldMessenger.of(context).showSnackBar(\n                              const SnackBar(content: Text('Could not launch phone app')),\n                            );\n                          }\n                        }\n                      },\n                      icon: const Icon(Icons.phone, color: Colors.white),\n                      label: const Text('Call', style: TextStyle(color: Colors.white)),\n                      style: ElevatedButton.styleFrom(backgroundColor: Colors.green),\n                    ),\n                  ),\n                  const SizedBox(width: 16),\n                  Expanded(\n                    child: ElevatedButton.icon(\n                      onPressed: onConnect,\n                      icon: const Icon(Icons.link, color: Colors.white),\n                      label: const Text('Connect', style: TextStyle(color: Colors.white)),\n                      style: ElevatedButton.styleFrom(backgroundColor: Colors.blueAccent),\n                    ),\n                  ),\n                ],\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  /// ✅ FIXED: Added BuildContext as a parameter so `ScaffoldMessenger.of(context)` works\n  Widget _buildInfoRow(BuildContext context, IconData icon, String label, String value) {\n    return Padding(\n      padding: const EdgeInsets.symmetric(vertical: 8.0),\n      child: Row(\n        children: [\n          Icon(icon, color: Colors.blueAccent),\n          const SizedBox(width: 8),\n          Expanded(\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text(label, style: const TextStyle(fontWeight: FontWeight.bold)),\n                if (label == 'Certificate')\n                  GestureDetector(\n                    onTap: () async {\n                      final url = Uri.parse(caretakerData['graduationCertificateUrl']);\n                      if (await canLaunchUrl(url)) {\n                        await launchUrl(url);\n                      } else {\n                        ScaffoldMessenger.of(context).showSnackBar(\n                          const SnackBar(content: Text('Could not open certificate')),\n                        );\n                      }\n                    },\n                    child: Text(\n                      value,\n                      style: const TextStyle(\n                        color: Colors.blue,\n                        decoration: TextDecoration.underline,\n                      ),\n                    ),\n                  )\n                else\n                  Text(value),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "caretaker_requests_screen.dart": {
          "_text": "// lib/user/caretaker/caretaker_requests_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:logger/logger.dart';\n\nimport 'caretaker_detail_screen.dart';\n\nfinal logger = Logger();\n\nclass CaretakerRequestsScreen extends StatefulWidget {\n  const CaretakerRequestsScreen({super.key});\n\n  @override\n  State<CaretakerRequestsScreen> createState() => _CaretakerRequestsScreenState();\n}\n\nclass _CaretakerRequestsScreenState extends State<CaretakerRequestsScreen> {\n  final _firestore = FirebaseFirestore.instance;\n  List<QueryDocumentSnapshot> _pendingRequests = [];\n  bool _isLoading = true;\n\n  @override\n  void initState() {\n    super.initState();\n    _loadPendingRequests();\n  }\n\n  Future<void> _loadPendingRequests() async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) {\n      setState(() => _isLoading = false);\n      return;\n    }\n\n    try {\n      // NOTE: Ensure a composite index is created in Firestore for the 'connections' collection\n      // on fields: user_uid (Ascending), status (Ascending)\n      // If index error occurs, create it via the link in the error log.\n      // To avoid index on orderBy, we fetch without orderBy and sort in code.\n      final connectionsQuery = await _firestore\n          .collection('connections')\n          .where('user_uid', isEqualTo: uid)\n          .where('status', isEqualTo: 'pending')\n          .get();\n\n      // Sort in code: descending by timestamp\n      final sortedDocs = connectionsQuery.docs.toList()\n        ..sort((a, b) {\n          final aTimestamp = a.data()['timestamp'] as Timestamp? ?? Timestamp(0, 0);\n          final bTimestamp = b.data()['timestamp'] as Timestamp? ?? Timestamp(0, 0);\n          return bTimestamp.compareTo(aTimestamp);\n        });\n\n      final pendingUids = sortedDocs.map((doc) => doc.data()['caretaker_uid'] as String?).whereType<String>().toSet().toList();\n\n      if (pendingUids.isEmpty) {\n        setState(() => _isLoading = false);\n        return;\n      }\n\n      // Fetch caretakers\n      final query = await _firestore\n          .collection('caretaker')\n          .where('uid', whereIn: pendingUids)\n          .get();\n\n      setState(() {\n        _pendingRequests = query.docs;\n        _isLoading = false;\n      });\n    } catch (e) {\n      logger.e('Error loading pending requests: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error loading requests: $e')),\n        );\n      }\n      setState(() => _isLoading = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Pending Requests'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : _pendingRequests.isEmpty\n              ? const Center(child: Text('No pending requests'))\n              : RefreshIndicator(\n                  onRefresh: _loadPendingRequests,\n                  child: ListView.builder(\n                    itemCount: _pendingRequests.length,\n                    itemBuilder: (context, index) {\n                      final caretaker = _pendingRequests[index].data() as Map<String, dynamic>;\n                      final caretakerUid = _pendingRequests[index].id;\n                      return Card(\n                        elevation: 2,\n                        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                        child: ListTile(\n                          onTap: () {\n                            Navigator.push(\n                              context,\n                              MaterialPageRoute(\n                                builder: (context) => CaretakerDetailScreen(\n                                  caretakerUid: caretakerUid,\n                                  caretakerData: caretaker,\n                                  onConnect: () {}, // No connect for pending\n                                ),\n                              ),\n                            );\n                          },\n                          leading: CircleAvatar(\n                            backgroundColor: Colors.grey[300],\n                            backgroundImage: (caretaker['profileImageUrl'] != null &&\n                                    caretaker['profileImageUrl'].toString().isNotEmpty)\n                                ? NetworkImage(caretaker['profileImageUrl'])\n                                : null,\n                            child: (caretaker['profileImageUrl'] == null ||\n                                    caretaker['profileImageUrl'].toString().isEmpty)\n                                ? const Icon(Icons.person, color: Colors.blueAccent)\n                                : null,\n                          ),\n                          title: Text(caretaker['fullName'] ?? ''),\n                          subtitle: Text('@${caretaker['username'] ?? ''} - Pending'),\n                        ),\n                      );\n                    },\n                  ),\n                ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "caretaker_screen.dart": {
          "_text": "// lib/user/caretaker/caretaker_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:logger/logger.dart';\nimport 'package:url_launcher/url_launcher.dart';\n\nimport '../../utils/notification_helper.dart';\nimport 'caretaker_detail_screen.dart';\nimport 'caretaker_requests_screen.dart';\nimport 'connection_history_screen.dart';\n\nfinal logger = Logger();\n\nclass CaretakerScreen extends StatefulWidget {\n  const CaretakerScreen({super.key});\n\n  @override\n  State<CaretakerScreen> createState() => _CaretakerScreenState();\n}\n\nclass _CaretakerScreenState extends State<CaretakerScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  final _searchController = TextEditingController();\n  String _search = '';\n\n  @override\n  void initState() {\n    super.initState();\n    _searchController.addListener(() => setState(() => _search = _searchController.text.toLowerCase()));\n  }\n\n  // REAL-TIME STREAMS\n\n  // Stream for user's connection status\n  Stream<DocumentSnapshot> _getUserStream() {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return Stream.empty();\n    return _firestore.collection('user').doc(uid).snapshots();\n  }\n\n  // Stream for available caretakers\n  Stream<QuerySnapshot> _getAvailableCaretakersStream() {\n    return _firestore\n        .collection('caretaker')\n        .where('isBanned', isEqualTo: false)\n        .where('isConnected', isEqualTo: false)\n        .snapshots();\n  }\n\n  // Stream for connection details (if connected)\n  Stream<DocumentSnapshot?> _getConnectionStream(String? connectionId) {\n    if (connectionId == null) return Stream.value(null);\n    return _firestore.collection('connections').doc(connectionId).snapshots();\n  }\n\n  Stream<DocumentSnapshot?> _getConnectedCaretakerStream(String? caretakerUid) {\n    if (caretakerUid == null) return Stream.value(null);\n    return _firestore.collection('caretaker').doc(caretakerUid).snapshots();\n  }\n\n  // ACTIONS\n\n  Future<void> _sendRequest(String caretakerUid) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return;\n\n    try {\n      // Check if there's already a pending request\n      final existingRequests = await _firestore\n          .collection('connections')\n          .where('user_uid', isEqualTo: uid)\n          .where('caretaker_uid', isEqualTo: caretakerUid)\n          .where('status', whereIn: ['pending', 'accepted'])\n          .get();\n\n      if (existingRequests.docs.isNotEmpty) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('You already have a request or connection with this caretaker')),\n          );\n        }\n        return;\n      }\n\n      // Check if caretaker is already connected to someone else\n      final caretakerDoc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n      final isCaretakerConnected = caretakerDoc.data()?['isConnected'] == true;\n\n      if (isCaretakerConnected) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('This caretaker is already connected to another user')),\n          );\n        }\n        return;\n      }\n\n      final ref = await _firestore.collection('connections').add({\n        'user_uid': uid,\n        'caretaker_uid': caretakerUid,\n        'status': 'pending',\n        'timestamp': Timestamp.now(),\n        'confirmedBy': null,\n        'requestedBy': uid,\n      });\n\n      // Notify caretaker\n      final playerIds = List<String>.from(\n        caretakerDoc.data()?['playerIds'] ?? [],\n      );\n      await sendNotification(playerIds, 'New connection request from user');\n\n      // Add to notifications subcollection with connectionId\n      await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .add({\n            'type': 'connection_request',\n            'message': 'Connection request from user',\n            'from': uid,\n            'to': caretakerUid,\n            'createdAt': Timestamp.now(),\n            'isRead': false,\n            'connectionId': ref.id,\n          });\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Request sent!')));\n      }\n    } catch (e) {\n      logger.e('Error sending request: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  Future<void> _requestUnbind(String connectionId, String caretakerUid) async {\n    if (!mounted) return;\n\n    try {\n      await _firestore\n          .collection('connections')\n          .doc(connectionId)\n          .update({\n            'status': 'unbind_requested',\n            'requestedBy': _auth.currentUser?.uid,\n          });\n\n      // Notify caretaker\n      final caretakerDoc = await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .get();\n      final playerIds = List<String>.from(\n        caretakerDoc.data()?['playerIds'] ?? [],\n      );\n      await sendNotification(playerIds, 'Unbind request from user');\n\n      await _firestore\n          .collection('caretaker')\n          .doc(caretakerUid)\n          .collection('notifications')\n          .add({\n            'type': 'unbind_request',\n            'message': 'Unbind request from user',\n            'from': _auth.currentUser?.uid,\n            'to': caretakerUid,\n            'createdAt': Timestamp.now(),\n            'isRead': false,\n            'connectionId': connectionId,\n          });\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Unbind request sent')));\n      }\n    } catch (e) {\n      logger.e('Error requesting unbind: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  Future<void> _confirmUnbind(String connectionId, String caretakerUid) async {\n    if (!mounted) return;\n\n    try {\n      await _firestore\n          .collection('connections')\n          .doc(connectionId)\n          .update({\n            'status': 'unbound',\n          });\n\n      final uid = _auth.currentUser?.uid;\n      if (uid != null) {\n        await _firestore.collection('user').doc(uid).update({\n          'isConnected': false,\n          'currentConnectionId': null,\n        });\n      }\n\n      await _firestore.collection('caretaker').doc(caretakerUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Unbound successfully')));\n      }\n    } catch (e) {\n      logger.e('Error confirming unbind: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  Future<void> _cancelUnbindRequest(String connectionId) async {\n    if (!mounted) return;\n\n    try {\n      await _firestore\n          .collection('connections')\n          .doc(connectionId)\n          .update({\n            'status': 'accepted',\n            'requestedBy': null,\n          });\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Unbind request cancelled')));\n      }\n    } catch (e) {\n      logger.e('Error cancelling unbind request: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));\n      }\n    }\n  }\n\n  Widget _buildNurseBadge() {\n    return Positioned(\n      top: 0,\n      right: 0,\n      child: Container(\n        padding: const EdgeInsets.all(4),\n        decoration: const BoxDecoration(\n          color: Colors.blue,\n          shape: BoxShape.circle,\n        ),\n        child: const Icon(\n          Icons.local_hospital,\n          size: 16,\n          color: Colors.white,\n        ),\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Caretakers'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.pending_actions),\n            onPressed: () => Navigator.push(\n              context,\n              MaterialPageRoute(builder: (context) => const CaretakerRequestsScreen()),\n            ),\n          ),\n          IconButton(\n            icon: const Icon(Icons.history),\n            onPressed: () => Navigator.push(\n              context,\n              MaterialPageRoute(builder: (context) => const ConnectionHistoryScreen()),\n            ),\n          ),\n        ],\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: StreamBuilder<DocumentSnapshot>(\n          stream: _getUserStream(),\n          builder: (context, userSnapshot) {\n            if (userSnapshot.connectionState == ConnectionState.waiting) {\n              return const Center(child: CircularProgressIndicator());\n            }\n\n            if (userSnapshot.hasError) {\n              return Center(child: Text('Error: ${userSnapshot.error}'));\n            }\n\n            final userData = userSnapshot.data?.data() as Map<String, dynamic>?;\n            final isConnected = userData?['isConnected'] == true;\n            final currentConnectionId = userData?['currentConnectionId'] as String?;\n\n            if (isConnected && currentConnectionId != null) {\n              return _buildConnectedState(currentConnectionId);\n            } else {\n              return _buildAvailableCaretakers();\n            }\n          },\n        ),\n      ),\n    );\n  }\n\n  Widget _buildConnectedState(String connectionId) {\n    return StreamBuilder<DocumentSnapshot?>(\n      stream: _getConnectionStream(connectionId),\n      builder: (context, connectionSnapshot) {\n        if (connectionSnapshot.connectionState == ConnectionState.waiting) {\n          return const Center(child: CircularProgressIndicator());\n        }\n\n        if (connectionSnapshot.hasError || connectionSnapshot.data == null) {\n          return Center(child: Text('Error loading connection: ${connectionSnapshot.error}'));\n        }\n\n        final connectionData = connectionSnapshot.data?.data() as Map<String, dynamic>?;\n        final status = connectionData?['status'] as String?;\n        final requestedBy = connectionData?['requestedBy'] as String?;\n        final caretakerUid = connectionData?['caretaker_uid'] as String?;\n\n        if (caretakerUid == null) {\n          return const Center(child: Text('Error: Invalid connection'));\n        }\n\n        // Handle different connection statuses\n        if (status == 'unbind_requested') {\n          final isRequestedByMe = requestedBy == _auth.currentUser?.uid;\n          if (isRequestedByMe) {\n            return _buildUnbindPendingState(caretakerUid, connectionId);\n          } else {\n            return _buildUnbindRequestedState(caretakerUid, connectionId);\n          }\n        } else if (status == 'unbound') {\n          // Auto-refresh to available caretakers\n          WidgetsBinding.instance.addPostFrameCallback((_) {\n            setState(() {});\n          });\n          return const Center(child: Text('Connection unbound'));\n        }\n\n        // Normal connected state\n        return StreamBuilder<DocumentSnapshot?>(\n          stream: _getConnectedCaretakerStream(caretakerUid),\n          builder: (context, caretakerSnapshot) {\n            if (caretakerSnapshot.connectionState == ConnectionState.waiting) {\n              return const Center(child: CircularProgressIndicator());\n            }\n\n            if (caretakerSnapshot.hasError || caretakerSnapshot.data == null) {\n              return Center(child: Text('Error loading caretaker: ${caretakerSnapshot.error}'));\n            }\n\n            final caretakerData = caretakerSnapshot.data?.data() as Map<String, dynamic>?;\n            return _buildConnectedCaretakerUI(caretakerData!, caretakerUid, connectionId);\n          },\n        );\n      },\n    );\n  }\n\n  Widget _buildConnectedCaretakerUI(Map<String, dynamic> caretakerData, String caretakerUid, String connectionId) {\n    final isNurse = caretakerData['caregiverType'] == 'nurse';\n\n    return SingleChildScrollView(\n      child: Column(\n        crossAxisAlignment: CrossAxisAlignment.stretch,\n        children: [\n          // Header with avatar - Improved with shadow and better padding\n          Container(\n            padding: const EdgeInsets.all(24),\n            decoration: BoxDecoration(\n              color: Colors.blueAccent,\n              borderRadius: const BorderRadius.vertical(bottom: Radius.circular(30)),\n              boxShadow: [\n                BoxShadow(\n                  color: Colors.blueAccent.withOpacity(0.3),\n                  blurRadius: 10,\n                  offset: const Offset(0, 4),\n                ),\n              ],\n            ),\n            child: Column(\n              children: [\n                Center(\n                  child: Stack(\n                    children: [\n                      CircleAvatar(\n                        radius: 40,\n                        backgroundColor: Colors.grey[300],\n                        backgroundImage: (caretakerData['profileImageUrl'] != null &&\n                                caretakerData['profileImageUrl'].toString().isNotEmpty)\n                            ? NetworkImage(caretakerData['profileImageUrl'])\n                            : null,\n                        child: (caretakerData['profileImageUrl'] == null ||\n                                caretakerData['profileImageUrl'].toString().isEmpty)\n                            ? const Icon(Icons.person, size: 60, color: Colors.blueAccent)\n                            : null,\n                      ),\n                      if (isNurse) _buildNurseBadge(),\n                    ],\n                  ),\n                ),\n                const SizedBox(height: 16),\n                Text(\n                  caretakerData['fullName'] ?? 'Unnamed',\n                  style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.white),\n                ),\n                Text(\n                  '@${caretakerData['username'] ?? ''}',\n                  style: const TextStyle(fontSize: 16, color: Colors.white70),\n                ),\n              ],\n            ),\n          ),\n\n          // Details Card - Improved elevation and padding\n          Padding(\n            padding: const EdgeInsets.all(16.0),\n            child: Card(\n              elevation: 4,\n              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n              child: Padding(\n                padding: const EdgeInsets.all(16.0),\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    _buildInfoRow(Icons.info_outline, 'Bio', caretakerData['bio'] ?? ''),\n                    _buildInfoRow(Icons.location_city, 'City', caretakerData['city'] ?? ''),\n                    _buildInfoRow(Icons.phone, 'Phone', caretakerData['phoneNo'] ?? ''),\n                    if (isNurse) ...[\n                      _buildInfoRow(Icons.work_history, 'Experience Years', '${caretakerData['experienceYears'] ?? 0} years'),\n                      _buildInfoRow(Icons.description, 'Experience Bio', caretakerData['experienceBio'] ?? ''),\n                      _buildInfoRow(Icons.school, 'Nursing Qualification', caretakerData['graduationOnNursing'] ?? ''),\n                      if (caretakerData['graduationCertificateUrl']?.isNotEmpty ?? false)\n                        _buildInfoRow(Icons.picture_as_pdf, 'Certificate', caretakerData['graduationCertificateUrl']),\n                    ] else\n                      _buildInfoRow(Icons.family_restroom, 'Relation', caretakerData['relation'] ?? ''),\n                  ],\n                ),\n              ),\n            ),\n          ),\n\n          // Actions - Improved button styles\n          Padding(\n            padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),\n            child: Column(\n              children: [\n                ElevatedButton.icon(\n                  onPressed: () async {\n                    final phone = caretakerData['phoneNo'];\n                    if (phone != null && phone.isNotEmpty) {\n                      final url = Uri.parse('tel:$phone');\n                      final can = await canLaunchUrl(url);\n                      if (can) {\n                        await launchUrl(url);\n                      } else if (mounted) {\n                        ScaffoldMessenger.of(context).showSnackBar(\n                          const SnackBar(content: Text('Could not launch phone app')),\n                        );\n                      }\n                    }\n                  },\n                  icon: const Icon(Icons.phone),\n                  label: const Text('Call Caretaker'),\n                  style: ElevatedButton.styleFrom(\n                    backgroundColor: Colors.green,\n                    minimumSize: const Size(double.infinity, 50),\n                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  ),\n                ),\n                const SizedBox(height: 16),\n                ElevatedButton.icon(\n                  onPressed: () => _requestUnbind(connectionId, caretakerUid),\n                  icon: const Icon(Icons.link_off),\n                  label: const Text('Request Unbind'),\n                  style: ElevatedButton.styleFrom(\n                    backgroundColor: Colors.red,\n                    minimumSize: const Size(double.infinity, 50),\n                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  ),\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _buildInfoRow(IconData icon, String label, String value) {\n    return Padding(\n      padding: const EdgeInsets.symmetric(vertical: 8.0),\n      child: Row(\n        children: [\n          Icon(icon, color: Colors.blueAccent),\n          const SizedBox(width: 8),\n          Expanded(\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text(label, style: const TextStyle(fontWeight: FontWeight.bold)),\n                if (label == 'Certificate')\n                  GestureDetector(\n                    onTap: () async {\n                      final url = Uri.parse(value);\n                      if (await canLaunchUrl(url)) {\n                        await launchUrl(url);\n                      } else {\n                        ScaffoldMessenger.of(context).showSnackBar(\n                          const SnackBar(content: Text('Could not open certificate')),\n                        );\n                      }\n                    },\n                    child: const Text(\n                      'View Certificate',\n                      style: TextStyle(color: Colors.blue, decoration: TextDecoration.underline),\n                    ),\n                  )\n                else\n                  Text(value),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _buildUnbindPendingState(String caretakerUid, String connectionId) {\n    return Center(\n      child: Padding(\n        padding: const EdgeInsets.all(24.0),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            const Icon(Icons.pending, size: 64, color: Colors.orange),\n            const SizedBox(height: 16),\n            const Text(\n              'Unbind Request Pending',\n              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.orange),\n            ),\n            const SizedBox(height: 8),\n            const Text(\n              'Waiting for caretaker to confirm the unbind request',\n              textAlign: TextAlign.center,\n              style: TextStyle(color: Colors.grey),\n            ),\n            const SizedBox(height: 20),\n            StreamBuilder<DocumentSnapshot?>(\n              stream: _getConnectedCaretakerStream(caretakerUid),\n              builder: (context, snapshot) {\n                if (snapshot.hasData) {\n                  final data = snapshot.data?.data() as Map<String, dynamic>?;\n                  return Text(\n                    'Caretaker: ${data?['fullName'] ?? 'Unknown'}',\n                    style: const TextStyle(fontSize: 16),\n                  );\n                }\n                return const SizedBox();\n              },\n            ),\n            const SizedBox(height: 20),\n            ElevatedButton(\n              onPressed: () => _cancelUnbindRequest(connectionId),\n              style: ElevatedButton.styleFrom(backgroundColor: Colors.blue),\n              child: const Text('Cancel Request', style: TextStyle(color: Colors.white)),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildUnbindRequestedState(String caretakerUid, String connectionId) {\n    return Center(\n      child: Padding(\n        padding: const EdgeInsets.all(24.0),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            const Icon(Icons.warning, size: 64, color: Colors.red),\n            const SizedBox(height: 16),\n            const Text(\n              'Unbind Request Received',\n              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.red),\n            ),\n            const SizedBox(height: 8),\n            const Text(\n              'Caretaker has requested to unbind the connection',\n              textAlign: TextAlign.center,\n              style: TextStyle(color: Colors.grey),\n            ),\n            const SizedBox(height: 20),\n            StreamBuilder<DocumentSnapshot?>(\n              stream: _getConnectedCaretakerStream(caretakerUid),\n              builder: (context, snapshot) {\n                if (snapshot.hasData) {\n                  final data = snapshot.data?.data() as Map<String, dynamic>?;\n                  return Text(\n                    'Caretaker: ${data?['fullName'] ?? 'Unknown'}',\n                    style: const TextStyle(fontSize: 16),\n                  );\n                }\n                return const SizedBox();\n              },\n            ),\n            const SizedBox(height: 20),\n            ElevatedButton(\n              onPressed: () => _confirmUnbind(connectionId, caretakerUid),\n              style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n              child: const Text('Confirm Unbind', style: TextStyle(color: Colors.white)),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildAvailableCaretakers() {\n    return Column(\n      children: [\n        // Search Field - Improved with clear button\n        Padding(\n          padding: const EdgeInsets.all(16.0),\n          child: TextField(\n            controller: _searchController,\n            decoration: InputDecoration(\n              hintText: 'Search by username...',\n              filled: true,\n              fillColor: Colors.white,\n              border: OutlineInputBorder(\n                borderRadius: BorderRadius.circular(12),\n                borderSide: BorderSide.none,\n              ),\n              prefixIcon: const Icon(Icons.search, color: Colors.blueAccent),\n              suffixIcon: _search.isNotEmpty\n                  ? IconButton(\n                      icon: const Icon(Icons.clear),\n                      onPressed: () {\n                        _searchController.clear();\n                      },\n                    )\n                  : null,\n            ),\n          ),\n        ),\n\n        // Available Caretakers List - Improved with cards and margins\n        Expanded(\n          child: StreamBuilder<QuerySnapshot>(\n            stream: _getAvailableCaretakersStream(),\n            builder: (context, snapshot) {\n              if (snapshot.connectionState == ConnectionState.waiting) {\n                return const Center(child: CircularProgressIndicator());\n              }\n\n              if (snapshot.hasError) {\n                return Center(child: Text('Error: ${snapshot.error}'));\n              }\n\n              final docs = snapshot.data?.docs ?? [];\n\n              final filteredDocs = docs.where((doc) {\n                final data = doc.data() as Map<String, dynamic>;\n                final username = (data['username'] as String?)?.toLowerCase() ?? '';\n                return username.contains(_search);\n              }).toList();\n\n              if (filteredDocs.isEmpty) {\n                return const Center(\n                  child: Column(\n                    mainAxisAlignment: MainAxisAlignment.center,\n                    children: [\n                      Icon(Icons.person_off, size: 64, color: Colors.grey),\n                      SizedBox(height: 16),\n                      Text(\n                        'No available caretakers at the moment',\n                        style: TextStyle(fontSize: 18, color: Colors.grey),\n                      ),\n                    ],\n                  ),\n                );\n              }\n\n              return RefreshIndicator(\n                onRefresh: () async {\n                  setState(() {});\n                },\n                color: Colors.blueAccent,\n                child: ListView.builder(\n                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n                  itemCount: filteredDocs.length,\n                  itemBuilder: (context, index) {\n                    final doc = filteredDocs[index];\n                    final caretaker = doc.data() as Map<String, dynamic>;\n                    final caretakerUid = doc.id;\n                    final isNurse = caretaker['caregiverType'] == 'nurse';\n\n                    return Card(\n                      elevation: 3,\n                      margin: const EdgeInsets.only(bottom: 16),\n                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                      child: ListTile(\n                        contentPadding: const EdgeInsets.all(16),\n                        onTap: () async {\n                          if (mounted) {\n                            await Navigator.push(\n                              context,\n                              MaterialPageRoute(\n                                builder: (context) => CaretakerDetailScreen(\n                                  caretakerUid: caretakerUid,\n                                  caretakerData: caretaker,\n                                  onConnect: () => _sendRequest(caretakerUid),\n                                ),\n                              ),\n                            );\n                          }\n                        },\n                        leading: Stack(\n                          children: [\n                            CircleAvatar(\n                              backgroundColor: Colors.grey[300],\n                              backgroundImage: (caretaker['profileImageUrl'] != null &&\n                                      caretaker['profileImageUrl'].toString().isNotEmpty)\n                                  ? NetworkImage(caretaker['profileImageUrl'])\n                                  : null,\n                              child: (caretaker['profileImageUrl'] == null ||\n                                      caretaker['profileImageUrl'].toString().isEmpty)\n                                  ? const Icon(Icons.person, color: Colors.blueAccent)\n                                  : null,\n                            ),\n                            if (isNurse) _buildNurseBadge(),\n                          ],\n                        ),\n                        title: Text('${caretaker['fullName'] ?? 'Unnamed'} (@${caretaker['username'] ?? ''})'),\n                        subtitle: Text(\n                          isNurse\n                              ? 'Experience: ${caretaker['experienceYears'] ?? 0} years | ${caretaker['city'] ?? ''}'\n                              : 'Relation: ${caretaker['relation'] ?? 'Unknown'} | ${caretaker['city'] ?? ''}',\n                        ),\n                        trailing: Row(\n                          mainAxisSize: MainAxisSize.min,\n                          children: [\n                            IconButton(\n                              icon: const Icon(Icons.phone, color: Colors.green),\n                              onPressed: () async {\n                                final phone = caretaker['phoneNo'];\n                                if (phone != null && phone.isNotEmpty) {\n                                  final url = Uri.parse('tel:$phone');\n                                  final can = await canLaunchUrl(url);\n                                  if (can) {\n                                    await launchUrl(url);\n                                  } else if (mounted) {\n                                    ScaffoldMessenger.of(context).showSnackBar(\n                                      const SnackBar(content: Text('Could not launch phone app')),\n                                    );\n                                  }\n                                }\n                              },\n                            ),\n                            IconButton(\n                              icon: const Icon(Icons.person_add, color: Colors.blue),\n                              onPressed: () => _sendRequest(caretakerUid),\n                            ),\n                          ],\n                        ),\n                      ),\n                    );\n                  },\n                ),\n              );\n            },\n          ),\n        ),\n      ],\n    );\n  }\n\n  @override\n  void dispose() {\n    _searchController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "connection_history_screen.dart": {
          "_text": "// lib/user/caretaker/connection_history_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:logger/logger.dart';\n\nfinal logger = Logger();\n\nclass ConnectionHistoryScreen extends StatefulWidget {\n  const ConnectionHistoryScreen({super.key});\n\n  @override\n  State<ConnectionHistoryScreen> createState() => _ConnectionHistoryScreenState();\n}\n\nclass _ConnectionHistoryScreenState extends State<ConnectionHistoryScreen> {\n  final _firestore = FirebaseFirestore.instance;\n  List<QueryDocumentSnapshot> _history = [];\n  bool _isLoading = true;\n\n  @override\n  void initState() {\n    super.initState();\n    _loadHistory();\n  }\n\n  Future<void> _loadHistory() async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) {\n      setState(() => _isLoading = false);\n      return;\n    }\n\n    try {\n      // NOTE: Ensure a composite index is created in Firestore for the 'connections' collection\n      // on fields: user_uid (Ascending), status (Ascending)\n      // If index error occurs, create it via the link in the error log.\n      // To avoid index on orderBy, we fetch without orderBy and sort in code.\n      // Adjusted statuses: removed 'expired' as it's not used in the app\n      final query = await _firestore\n          .collection('connections')\n          .where('user_uid', isEqualTo: uid)\n          .where('status', whereIn: ['unbound', 'rejected'])\n          .get();\n\n      // Sort in code: descending by timestamp\n      final sortedDocs = query.docs.toList()\n        ..sort((a, b) {\n          final aTimestamp = a.data()['timestamp'] as Timestamp? ?? Timestamp(0, 0);\n          final bTimestamp = b.data()['timestamp'] as Timestamp? ?? Timestamp(0, 0);\n          return bTimestamp.compareTo(aTimestamp);\n        });\n\n      final historyUids = sortedDocs.map((doc) => doc.data()['caretaker_uid'] as String?).whereType<String>().toSet().toList();\n\n      if (historyUids.isNotEmpty) {\n        final caretakersQuery = await _firestore\n            .collection('caretaker')\n            .where('uid', whereIn: historyUids)\n            .get();\n\n        setState(() {\n          _history = caretakersQuery.docs;\n          _isLoading = false;\n        });\n      } else {\n        setState(() => _isLoading = false);\n      }\n    } catch (e) {\n      logger.e('Error loading history: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error loading history: $e')),\n        );\n      }\n      setState(() => _isLoading = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Connection History'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : _history.isEmpty\n              ? const Center(child: Text('No connection history'))\n              : RefreshIndicator(\n                  onRefresh: _loadHistory,\n                  child: ListView.builder(\n                    itemCount: _history.length,\n                    itemBuilder: (context, index) {\n                      final caretaker = _history[index].data() as Map<String, dynamic>;\n                      return Card(\n                        elevation: 2,\n                        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                        child: ListTile(\n                          leading: CircleAvatar(\n                            backgroundColor: Colors.grey[300],\n                            backgroundImage: (caretaker['profileImageUrl'] != null &&\n                                    caretaker['profileImageUrl'].toString().isNotEmpty)\n                                ? NetworkImage(caretaker['profileImageUrl'])\n                                : null,\n                            child: (caretaker['profileImageUrl'] == null ||\n                                    caretaker['profileImageUrl'].toString().isEmpty)\n                                ? const Icon(Icons.person, color: Colors.blueAccent)\n                                : null,\n                          ),\n                          title: Text(caretaker['fullName'] ?? ''),\n                          subtitle: Text('Past connection: ${caretaker['caregiverType'] ?? ''}'),\n                        ),\n                      );\n                    },\n                  ),\n                ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "diary_album": {
        "album_screen.dart": {
          "_text": "import 'dart:io';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:permission_handler/permission_handler.dart';\nimport 'package:http/http.dart' as http;\nimport 'dart:convert';\nimport 'package:intl/intl.dart';\n\nclass AlbumScreen extends StatefulWidget {\n  const AlbumScreen({super.key});\n\n  @override\n  State<AlbumScreen> createState() => _AlbumScreenState();\n}\n\nclass _AlbumScreenState extends State<AlbumScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  final ImagePicker _picker = ImagePicker();\n  List<QueryDocumentSnapshot> _albums = [];\n  bool _isLoading = true;\n\n  @override\n  void initState() {\n    super.initState();\n    _loadAlbums();\n  }\n\n  Future<void> _loadAlbums() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) {\n      setState(() => _isLoading = false);\n      return;\n    }\n\n    try {\n      final snap = await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('album')\n          .orderBy('createdAt', descending: true)\n          .get();\n\n      setState(() {\n        _albums = snap.docs;\n        _isLoading = false;\n      });\n    } catch (e) {\n      print('Error loading albums: $e');\n      setState(() => _isLoading = false);\n    }\n  }\n\n  Future<void> _showAddOptions() async {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) => SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Take Photo'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickImage(ImageSource.camera);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Upload from Gallery'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickImage(ImageSource.gallery);\n              },\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Future<void> _pickImage(ImageSource source) async {\n    Permission permission = source == ImageSource.camera ? Permission.camera : Permission.photos;\n    if (await permission.request().isGranted) {\n      XFile? image = await _picker.pickImage(source: source);\n      if (image != null && mounted) {\n        if (source == ImageSource.camera) {\n          await _showPreview(image);\n        } else {\n          await _showTitleDesc(image);\n        }\n      }\n    } else {\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Permission denied for ${source == ImageSource.camera ? 'camera' : 'photos'}')),\n      );\n    }\n  }\n\n  Future<void> _showPreview(XFile image) async {\n    bool? confirmed = await showDialog<bool>(\n      context: context,\n      builder: (context) => AlertDialog(\n        content: Image.file(File(image.path)),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Retake'),\n          ),\n          TextButton(\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirmed == true && mounted) {\n      await _showTitleDesc(image);\n    } else if (confirmed == false && mounted) {\n      _pickImage(ImageSource.camera);\n    }\n  }\n\n  Future<void> _showTitleDesc(XFile image) async {\n    final titleController = TextEditingController();\n    final descController = TextEditingController();\n\n    final result = await showDialog<bool>(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Text('Add Details'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(\n              controller: titleController,\n              decoration: const InputDecoration(labelText: 'Title'),\n            ),\n            TextField(\n              controller: descController,\n              decoration: const InputDecoration(labelText: 'Description'),\n            ),\n          ],\n        ),\n        actions: [\n          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),\n          TextButton(onPressed: () => Navigator.pop(context, true), child: const Text('Upload')),\n        ],\n      ),\n    );\n\n    if (result == true && mounted) {\n      if (titleController.text.trim().isEmpty) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Title is required')),\n        );\n        return;\n      }\n\n      try {\n        // Upload to Cloudinary\n        final uri = Uri.parse('https://api.cloudinary.com/v1_1/dts8hgf4f/image/upload');\n        var request = http.MultipartRequest('POST', uri)\n          ..fields['upload_preset'] = 'album_images'\n          ..fields['cloud_name'] = 'dts8hgf4f';\n\n        final file = await http.MultipartFile.fromPath('file', image.path);\n        request.files.add(file);\n\n        final streamedResponse = await request.send();\n        final response = await http.Response.fromStream(streamedResponse);\n\n        if (response.statusCode == 200) {\n          final responseData = json.decode(response.body);\n          final imageUrl = responseData['secure_url'];\n\n          final uid = _auth.currentUser?.uid;\n          if (uid != null) {\n            await _firestore.collection('user').doc(uid).collection('album').add({\n              'title': titleController.text.trim(),\n              'description': descController.text.trim(),\n              'imageUrl': imageUrl,\n              'createdAt': Timestamp.now(),\n            });\n\n            _loadAlbums();\n            ScaffoldMessenger.of(context).showSnackBar(\n              const SnackBar(content: Text('Memory added successfully')),\n            );\n          }\n        } else {\n          throw 'Upload failed: ${response.body}';\n        }\n      } catch (e) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error adding memory: $e')),\n        );\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    if (_isLoading) {\n      return const Center(child: CircularProgressIndicator());\n    }\n\n    Widget content;\n    if (_albums.isEmpty) {\n      content = const Center(child: Text('No memories yet. Add one!'));\n    } else {\n      content = RefreshIndicator(\n        onRefresh: _loadAlbums,\n        child: GridView.builder(\n          padding: const EdgeInsets.all(16),\n          gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n            crossAxisCount: 2,\n            childAspectRatio: 0.7,\n            crossAxisSpacing: 16,\n            mainAxisSpacing: 16,\n          ),\n          itemCount: _albums.length,\n          itemBuilder: (context, index) {\n            final album = _albums[index].data() as Map<String, dynamic>;\n            final createdAt = album['createdAt'] as Timestamp?;\n            String dateStr = '';\n            if (createdAt != null) {\n              dateStr = DateFormat('MMM dd, yyyy HH:mm').format(createdAt.toDate());\n            }\n            return Card(\n              elevation: 4,\n              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n              child: InkWell(\n                onTap: () => Navigator.push(\n                  context,\n                  MaterialPageRoute(\n                    builder: (context) => FullImageScreen(imageUrl: album['imageUrl']),\n                  ),\n                ),\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.stretch,\n                  children: [\n                    Expanded(\n                      child: ClipRRect(\n                        borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),\n                        child: Image.network(\n                          album['imageUrl'],\n                          fit: BoxFit.cover,\n                        ),\n                      ),\n                    ),\n                    Padding(\n                      padding: const EdgeInsets.all(8.0),\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          Text(\n                            album['title'] ?? '',\n                            style: const TextStyle(fontWeight: FontWeight.bold),\n                          ),\n                          Text(\n                            album['description'] ?? '',\n                            maxLines: 2,\n                            overflow: TextOverflow.ellipsis,\n                            style: const TextStyle(fontSize: 12, color: Colors.grey),\n                          ),\n                          Text(\n                            dateStr,\n                            style: const TextStyle(fontSize: 10, color: Colors.grey),\n                          ),\n                        ],\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            );\n          },\n        ),\n      );\n    }\n\n    return Stack(\n      children: [\n        content,\n        Positioned(\n          bottom: 16,\n          right: 16,\n          child: FloatingActionButton(\n            onPressed: _showAddOptions,\n            child: const Icon(Icons.add),\n          ),\n        ),\n      ],\n    );\n  }\n}\n\nclass FullImageScreen extends StatelessWidget {\n  final String imageUrl;\n  const FullImageScreen({super.key, required this.imageUrl});\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.black,\n      body: GestureDetector(\n        onTap: () => Navigator.pop(context),\n        child: Center(\n          child: Image.network(imageUrl),\n        ),\n      ),\n      floatingActionButton: FloatingActionButton(\n        mini: true,\n        onPressed: () => Navigator.pop(context),\n        child: const Icon(Icons.close),\n      ),\n      floatingActionButtonLocation: FloatingActionButtonLocation.endTop,\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "diary_album_screen.dart": {
          "_text": "import 'package:flutter/material.dart';\nimport 'diary_screen.dart';\nimport 'album_screen.dart';\n\nclass DiaryAlbumScreen extends StatefulWidget {\n  const DiaryAlbumScreen({super.key});\n\n  @override\n  State<DiaryAlbumScreen> createState() => _DiaryAlbumScreenState();\n}\n\nclass _DiaryAlbumScreenState extends State<DiaryAlbumScreen> with SingleTickerProviderStateMixin {\n  late TabController _tabController;\n\n  @override\n  void initState() {\n    super.initState();\n    _tabController = TabController(length: 2, vsync: this);\n  }\n\n  @override\n  void dispose() {\n    _tabController.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: PreferredSize(\n        preferredSize: const Size.fromHeight(48), // height just for the TabBar\n        child: AppBar(\n          backgroundColor: Colors.blueAccent,\n          automaticallyImplyLeading: false, // no back button\n          titleSpacing: 0, // removes extra title padding\n          title: TabBar(\n            controller: _tabController,\n            indicatorColor: Colors.white,\n            labelColor: Colors.white,\n            unselectedLabelColor: Colors.white70,\n            tabs: const [\n              Tab(text: 'Diary'),\n              Tab(text: 'Album'),\n            ],\n          ),\n        ),\n      ),\n      body: TabBarView(\n        controller: _tabController,\n        children: const [\n          DiaryScreen(),\n          AlbumScreen(),\n        ],\n      ),\n    );\n  }\n}\n",
          "_encoding": "utf-8"
        },
        "diary_screen.dart": {
          "_text": "// lib/user/diary/diary_screen.dart\n// lib/user/diary/diary_screen.dart\nimport 'dart:async';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:fluttertoast/fluttertoast.dart';\nimport 'package:intl/intl.dart';\n\nclass DiaryScreen extends StatefulWidget {\n  const DiaryScreen({super.key});\n\n  @override\n  State<DiaryScreen> createState() => _DiaryScreenState();\n}\n\nclass _DiaryScreenState extends State<DiaryScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  List<QueryDocumentSnapshot> _diaries = [];\n  bool _isLoading = true;\n  bool _hasError = false;\n  DateTime _currentDate = DateTime.now();\n  bool _hasToday = false;\n  final int _charLimit = 2000;\n  Timer? _debounce;\n  late TextEditingController _todayController;\n  bool _showedLimitToast = false;\n  late PageController _pageController;\n\n  @override\n  void initState() {\n    super.initState();\n    _todayController = TextEditingController();\n    _todayController.addListener(() {\n      setState(() {});\n    });\n    _pageController = PageController();\n    _loadDiaries();\n  }\n\n  Future<void> _loadDiaries() async {\n    if (!mounted) return;\n\n    setState(() {\n      _isLoading = true;\n      _hasError = false;\n    });\n\n    try {\n      final uid = _auth.currentUser?.uid;\n      if (uid != null) {\n        final snap = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('diary')\n            .orderBy('createdAt', descending: true)\n            .get();\n\n        if (!mounted) return;\n\n        setState(() {\n          _diaries = snap.docs.reversed.toList(); // oldest first\n          _currentDate = DateTime.now();\n          final todayStr = DateFormat('yyyy-MM-dd').format(_currentDate);\n          _hasToday = _diaries.any((doc) => doc.id == todayStr);\n\n          String todayContent = '';\n          if (_hasToday) {\n            final todayDoc = _diaries.firstWhere((doc) => doc.id == todayStr);\n            todayContent = todayDoc['content'] ?? '';\n          }\n          _todayController.text = todayContent;\n          _showedLimitToast = false;\n          _isLoading = false;\n        });\n\n        WidgetsBinding.instance.addPostFrameCallback((_) {\n          if (_pageController.hasClients) {\n            _pageController.jumpToPage(\n                _diaries.length + (_hasToday ? 0 : 1) - 1);\n          }\n        });\n      } else {\n        setState(() {\n          _isLoading = false;\n          _hasError = true;\n        });\n      }\n    } catch (e) {\n      print('Error loading diaries: $e');\n      if (mounted) {\n        setState(() {\n          _isLoading = false;\n          _hasError = true;\n        });\n      }\n    }\n  }\n\n  Future<void> _saveContent(String dateStr, String content) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return;\n\n    try {\n      final docRef = _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('diary')\n          .doc(dateStr);\n\n      final doc = await docRef.get();\n\n      await docRef.set({\n        'content': content,\n        'updatedAt': Timestamp.now(),\n        if (!doc.exists) 'createdAt': Timestamp.now(), // only for new docs\n      }, SetOptions(merge: true));\n    } catch (e) {\n      if (mounted) {\n        Fluttertoast.showToast(msg: 'Error saving diary: $e');\n      }\n    }\n  }\n\n  Widget _buildPage(DateTime date, String content, {bool editable = false}) {\n    final dateStr = DateFormat('yyyy-MM-dd').format(date);\n    final controller = editable ? _todayController : TextEditingController(text: content);\n\n    return Container(\n      decoration: BoxDecoration(\n        color: Colors.white,\n        borderRadius: BorderRadius.circular(8),\n        boxShadow: [\n          BoxShadow(\n            color: Colors.black.withOpacity(0.2),\n            blurRadius: 10,\n            offset: const Offset(5, 5),\n          ),\n        ],\n        border: Border.all(color: Colors.grey.shade300),\n      ),\n      padding: const EdgeInsets.all(16),\n      child: Column(\n        crossAxisAlignment: CrossAxisAlignment.start,\n        children: [\n          Text(\n            DateFormat('MMMM dd, yyyy').format(date),\n            style: const TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.bold,\n                color: Colors.blueAccent),\n          ),\n          const SizedBox(height: 16),\n          Expanded(\n            child: editable\n                ? TextField(\n                    controller: controller,\n                    maxLines: null,\n                    decoration: InputDecoration(\n                      hintText: 'Write your diary here...',\n                      border: InputBorder.none,\n                      counterText:\n                          '${_todayController.text.length}/$_charLimit',\n                      counterStyle: TextStyle(\n                          color: _todayController.text.length == _charLimit\n                              ? Colors.red\n                              : Colors.grey),\n                    ),\n                    onChanged: (text) {\n                      _debounce?.cancel();\n                      if (text.length > _charLimit) {\n                        _todayController.text = text.substring(0, _charLimit);\n                        _todayController.selection = TextSelection.collapsed(\n                            offset: _charLimit);\n                        if (!_showedLimitToast) {\n                          Fluttertoast.showToast(\n                              msg:\n                                  'Try to compress the content in the diary');\n                          _showedLimitToast = true;\n                        }\n                      } else {\n                        if (text.length < _charLimit) _showedLimitToast = false;\n                      }\n                      _debounce = Timer(const Duration(milliseconds: 500),\n                          () => _saveContent(dateStr, _todayController.text));\n                    },\n                  )\n                : Text(\n                    content.isEmpty ? 'No content' : content,\n                    style: const TextStyle(fontSize: 16),\n                  ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    if (_isLoading) {\n      return const Scaffold(\n          body: Center(\n              child: CircularProgressIndicator(color: Colors.blueAccent)));\n    }\n\n    if (_hasError) {\n      return Scaffold(\n        body: Center(\n          child: Column(\n            mainAxisAlignment: MainAxisAlignment.center,\n            children: [\n              const Icon(Icons.error, size: 64, color: Colors.red),\n              const SizedBox(height: 16),\n              const Text('Error loading diary',\n                  style: TextStyle(fontSize: 18, color: Colors.red)),\n              const SizedBox(height: 16),\n              ElevatedButton(\n                onPressed: _loadDiaries,\n                style: ElevatedButton.styleFrom(backgroundColor: Colors.blueAccent),\n                child: const Text('Retry', style: TextStyle(color: Colors.white)),\n              ),\n            ],\n          ),\n        ),\n      );\n    }\n\n    final itemCount = _diaries.length + (_hasToday ? 0 : 1);\n\n    return Scaffold(\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: itemCount == 0\n            ? const Center(\n                child: Text(\n                  'No diaries yet. Start writing today!',\n                  style: TextStyle(fontSize: 18, color: Colors.grey),\n                ),\n              )\n            : RefreshIndicator(\n                onRefresh: _loadDiaries,\n                color: Colors.blueAccent,\n                child: PageView.builder(\n                  controller: _pageController,\n                  itemCount: itemCount,\n                  itemBuilder: (context, index) {\n                    if (index == itemCount - 1 && !_hasToday) {\n                      return Transform(\n                        transform: Matrix4.identity()..setEntry(3, 2, 0.001),\n                        child: _buildPage(_currentDate, '', editable: true),\n                      );\n                    }\n\n                    final doc = _diaries[index];\n                    final dateStr = doc.id;\n                    final date = DateTime.parse(dateStr);\n                    final content = doc['content'] as String? ?? '';\n                    final isToday =\n                        dateStr == DateFormat('yyyy-MM-dd').format(_currentDate);\n\n                    return Transform(\n                      transform: Matrix4.identity()..setEntry(3, 2, 0.001),\n                      child: _buildPage(date, content, editable: isToday),\n                    );\n                  },\n                  physics: const BouncingScrollPhysics(),\n                ),\n              ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _debounce?.cancel();\n    _todayController.dispose();\n    _pageController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "family": {
        "family_add_screen.dart": {
          "_text": "// lib/user/family/family_add_screen.dart\nimport 'dart:io';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:cloudinary_public/cloudinary_public.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:logger/logger.dart';\nimport 'package:permission_handler/permission_handler.dart';\nimport 'package:image/image.dart' as img;\n\nfinal logger = Logger();\n\nclass AddScreen extends StatefulWidget {\n  const AddScreen({super.key});\n\n  @override\n  State<AddScreen> createState() => _AddScreenState();\n}\n\nclass _AddScreenState extends State<AddScreen> {\n  final _nameController = TextEditingController();\n  final _relationController = TextEditingController();\n  final _phoneController = TextEditingController();\n  File? _image;\n  final _picker = ImagePicker();\n  final cloudinary = CloudinaryPublic('dts8hgf4f', 'family_members');\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  bool _isSaving = false;\n\n  Future<void> _pickImage() async {\n    final status = await Permission.photos.request();\n    if (!status.isGranted) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Photo permission denied')),\n        );\n      }\n      return;\n    }\n    try {\n      final picked = await _picker.pickImage(source: ImageSource.gallery);\n      if (picked != null && mounted) {\n        setState(() => _image = File(picked.path));\n      }\n    } catch (e) {\n      logger.e('Error picking image: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error picking image: $e')),\n        );\n      }\n    }\n  }\n\n  static Uint8List _processImage(Uint8List bytes) {\n    final image = img.decodeImage(bytes);\n    if (image == null) return bytes;\n\n    img.Image resized = image;\n    const maxSize = 512;\n    if (image.width > maxSize || image.height > maxSize) {\n      if (image.width > image.height) {\n        resized = img.copyResize(image, width: maxSize);\n      } else {\n        resized = img.copyResize(image, height: maxSize);\n      }\n    }\n    return img.encodeJpg(resized, quality: 85);\n  }\n\n  Future<String?> _uploadImage() async {\n    if (_image == null) return '';\n    try {\n      final bytes = await _image!.readAsBytes();\n      final processedBytes = await compute(_processImage, bytes);\n      final r = await cloudinary\n          .uploadFile(CloudinaryFile.fromBytesData(processedBytes, identifier: 'family_member.jpg'))\n          .timeout(const Duration(seconds: 30));\n      return r.secureUrl;\n    } catch (e) {\n      logger.e('Image upload failed: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Image upload failed: $e')),\n        );\n      }\n      return '';\n    }\n  }\n\n  Future<void> _save() async {\n    if (_nameController.text.trim().isEmpty ||\n        _relationController.text.trim().isEmpty ||\n        _phoneController.text.trim().isEmpty) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('All fields are required')),\n        );\n      }\n      return;\n    }\n\n    if (_isSaving) return;\n    setState(() => _isSaving = true);\n\n    if (mounted) {\n      showDialog(\n        barrierDismissible: false,\n        context: context,\n        builder: (_) => const Center(child: CircularProgressIndicator(color: Colors.blueAccent)),\n      );\n    }\n\n    try {\n      final url = await _uploadImage();\n      if (!mounted) return;\n\n      final uid = _auth.currentUser?.uid;\n      if (uid == null) throw Exception('User not logged in');\n\n      await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('family_members')\n          .add({\n        'name': _nameController.text.trim(),\n        'relation': _relationController.text.trim(),\n        'phone': _phoneController.text.trim(),\n        'imageUrl': url ?? '',\n        'createdAt': FieldValue.serverTimestamp(),\n      });\n      if (mounted){\n        Navigator.pop(context); // Close loading dialog\n        Navigator.pop(context); \n      }// Return to family screen\n    } catch (e) {\n      logger.e('Error saving member: $e');\n      if (mounted) {\n        Navigator.pop(context); // Close loading dialog\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error saving: $e')),\n        );\n      }\n    } finally {\n      if (mounted) setState(() => _isSaving = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Add Member'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(24.0),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Member Details',\n              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n            ),\n            const SizedBox(height: 24),\n            _buildTextField(_nameController, 'Name', Icons.person),\n            _buildTextField(_relationController, 'Relation', Icons.family_restroom),\n            _buildTextField(_phoneController, 'Phone', Icons.phone, keyboardType: TextInputType.phone),\n            const SizedBox(height: 24),\n            const Text(\n              'Profile Picture',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n            ),\n            const SizedBox(height: 8),\n            Center(\n              child: GestureDetector(\n                onTap: _pickImage,\n                child: Stack(\n                  children: [\n                    CircleAvatar(\n                      radius: 60,\n                      backgroundColor: Colors.grey[300],\n                      backgroundImage: _image != null ? FileImage(_image!) : null,\n                      child: _image == null ? const Icon(Icons.person, size: 60, color: Colors.blueAccent) : null,\n                    ),\n                    Positioned(\n                      bottom: 0,\n                      right: 0,\n                      child: CircleAvatar(\n                        backgroundColor: Colors.blueAccent,\n                        radius: 20,\n                        child: const Icon(Icons.camera_alt, color: Colors.white, size: 20),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ),\n            const SizedBox(height: 32),\n            _isSaving\n                ? const Center(child: CircularProgressIndicator(color: Colors.blueAccent))\n                : ElevatedButton(\n                    onPressed: _save,\n                    style: ElevatedButton.styleFrom(\n                      backgroundColor: Colors.blueAccent,\n                      padding: const EdgeInsets.symmetric(vertical: 16),\n                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                      minimumSize: const Size(double.infinity, 50),\n                    ),\n                    child: const Text('Add Member', style: TextStyle(fontSize: 18, color: Colors.white)),\n                  ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildTextField(TextEditingController controller, String label, IconData icon, {TextInputType? keyboardType}) {\n    return Padding(\n      padding: const EdgeInsets.only(bottom: 16),\n      child: TextField(\n        controller: controller,\n        decoration: InputDecoration(\n          labelText: label,\n          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n          filled: true,\n          fillColor: Colors.white,\n          prefixIcon: Icon(icon, color: Colors.blueAccent),\n        ),\n        keyboardType: keyboardType,\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _nameController.dispose();\n    _relationController.dispose();\n    _phoneController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "family_edit_screen.dart": {
          "_text": "// lib/user/family/family_edit_screen.dart\nimport 'dart:io';\nimport 'dart:typed_data';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:cloudinary_public/cloudinary_public.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:logger/logger.dart';\nimport 'package:permission_handler/permission_handler.dart';\nimport 'package:image/image.dart' as img;\n\nfinal logger = Logger();\n\nclass EditScreen extends StatefulWidget {\n  final String memberId;\n  final Map<String, dynamic> memberData;\n\n  const EditScreen({super.key, required this.memberId, required this.memberData});\n\n  @override\n  State<EditScreen> createState() => _EditScreenState();\n}\n\nclass _EditScreenState extends State<EditScreen> {\n  final _nameController = TextEditingController();\n  final _relationController = TextEditingController();\n  final _phoneController = TextEditingController();\n  File? _image;\n  String? _existingImageUrl;\n  final _picker = ImagePicker();\n  final cloudinary = CloudinaryPublic('dts8hgf4f', 'family_members');\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  bool _isSaving = false;\n\n  @override\n  void initState() {\n    super.initState();\n    // Initialize text controllers with existing member data\n    _nameController.text = widget.memberData['name'] ?? '';\n    _relationController.text = widget.memberData['relation'] ?? '';\n    _phoneController.text = widget.memberData['phone'] ?? '';\n    _existingImageUrl = widget.memberData['imageUrl'] ?? '';\n  }\n\n  Future<void> _pickImage() async {\n    final status = await Permission.photos.request();\n    if (!status.isGranted) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Photo permission denied')),\n        );\n      }\n      return;\n    }\n    try {\n      final picked = await _picker.pickImage(source: ImageSource.gallery);\n      if (picked != null && mounted) {\n        setState(() => _image = File(picked.path));\n      }\n    } catch (e) {\n      logger.e('Error picking image: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error picking image: $e')),\n        );\n      }\n    }\n  }\n\n  static Uint8List _processImage(Uint8List bytes) {\n    final image = img.decodeImage(bytes);\n    if (image == null) return bytes;\n\n    img.Image resized = image;\n    const maxSize = 512;\n    if (image.width > maxSize || image.height > maxSize) {\n      if (image.width > image.height) {\n        resized = img.copyResize(image, width: maxSize);\n      } else {\n        resized = img.copyResize(image, height: maxSize);\n      }\n    }\n    return img.encodeJpg(resized, quality: 85);\n  }\n\n  Future<String?> _uploadImage() async {\n    if (_image == null) return _existingImageUrl;\n    try {\n      final bytes = await _image!.readAsBytes();\n      final processedBytes = await compute(_processImage, bytes);\n      final r = await cloudinary\n          .uploadFile(CloudinaryFile.fromBytesData(processedBytes, identifier: 'family_member.jpg'))\n          .timeout(const Duration(seconds: 30));\n      return r.secureUrl;\n    } catch (e) {\n      logger.e('Image upload failed: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Image upload failed: $e')),\n        );\n      }\n      return _existingImageUrl;\n    }\n  }\n\n  Future<void> _save() async {\n    if (_nameController.text.trim().isEmpty ||\n        _relationController.text.trim().isEmpty ||\n        _phoneController.text.trim().isEmpty) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('All fields are required')),\n        );\n      }\n      return;\n    }\n\n    if (_isSaving) return;\n    setState(() => _isSaving = true);\n\n    if (mounted) {\n      showDialog(\n        barrierDismissible: false,\n        context: context,\n        builder: (_) => const Center(child: CircularProgressIndicator(color: Colors.blueAccent)),\n      );\n    }\n\n    try {\n      final url = await _uploadImage();\n      if (!mounted) return;\n\n      final uid = _auth.currentUser?.uid;\n      if (uid == null) throw Exception('User not logged in');\n\n      await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('family_members')\n          .doc(widget.memberId)\n          .update({\n        'name': _nameController.text.trim(),\n        'relation': _relationController.text.trim(),\n        'phone': _phoneController.text.trim(),\n        'imageUrl': url ?? '',\n        'updatedAt': FieldValue.serverTimestamp(),\n      });\n\n      Navigator.pop(context); // Close loading dialog\n      Navigator.pop(context); // Return to family screen\n    } catch (e) {\n      logger.e('Error updating member: $e');\n      if (mounted) {\n        Navigator.pop(context); // Close loading dialog\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error updating: $e')),\n        );\n      }\n    } finally {\n      if (mounted) setState(() => _isSaving = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Edit Member'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(24.0),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Edit Member Details',\n              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n            ),\n            const SizedBox(height: 24),\n            _buildTextField(_nameController, 'Name', Icons.person),\n            _buildTextField(_relationController, 'Relation', Icons.family_restroom),\n            _buildTextField(_phoneController, 'Phone', Icons.phone, keyboardType: TextInputType.phone),\n            const SizedBox(height: 24),\n            const Text(\n              'Profile Picture',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n            ),\n            const SizedBox(height: 8),\n            Center(\n              child: GestureDetector(\n                onTap: _pickImage,\n                child: Stack(\n                  children: [\n                    CircleAvatar(\n                      radius: 60,\n                      backgroundColor: Colors.grey[300],\n                      backgroundImage: _image != null\n                          ? FileImage(_image!)\n                          : _existingImageUrl != null && _existingImageUrl!.isNotEmpty\n                              ? NetworkImage(_existingImageUrl!)\n                              : null,\n                      child: _image == null && (_existingImageUrl == null || _existingImageUrl!.isEmpty)\n                          ? const Icon(Icons.person, size: 60, color: Colors.blueAccent)\n                          : null,\n                    ),\n                    Positioned(\n                      bottom: 0,\n                      right: 0,\n                      child: CircleAvatar(\n                        backgroundColor: Colors.blueAccent,\n                        radius: 20,\n                        child: const Icon(Icons.camera_alt, color: Colors.white, size: 20),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ),\n            const SizedBox(height: 32),\n            _isSaving\n                ? const Center(child: CircularProgressIndicator(color: Colors.blueAccent))\n                : ElevatedButton(\n                    onPressed: _save,\n                    style: ElevatedButton.styleFrom(\n                      backgroundColor: Colors.blueAccent,\n                      padding: const EdgeInsets.symmetric(vertical: 16),\n                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                      minimumSize: const Size(double.infinity, 50),\n                    ),\n                    child: const Text('Update Member', style: TextStyle(fontSize: 18, color: Colors.white)),\n                  ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildTextField(TextEditingController controller, String label, IconData icon, {TextInputType? keyboardType}) {\n    return Padding(\n      padding: const EdgeInsets.only(bottom: 16),\n      child: TextField(\n        controller: controller,\n        decoration: InputDecoration(\n          labelText: label,\n          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n          filled: true,\n          fillColor: Colors.white,\n          prefixIcon: Icon(icon, color: Colors.blueAccent),\n        ),\n        keyboardType: keyboardType,\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _nameController.dispose();\n    _relationController.dispose();\n    _phoneController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "family_scanner_screen.dart": {
          "_text": "// lib/user/family/family_scanner_screen.dart\nimport 'dart:convert';\nimport 'dart:io';\nimport 'dart:typed_data';\nimport 'package:camera/camera.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:http/http.dart' as http;\nimport 'package:flutter_animate/flutter_animate.dart';\nimport 'package:confetti/confetti.dart';\nimport 'package:logger/logger.dart';\nimport 'package:image/image.dart' as img;\nimport 'package:permission_handler/permission_handler.dart';\n\nfinal logger = Logger();\n\nclass ScannerScreen extends StatefulWidget {\n  final List<Map<String, dynamic>> members;\n  const ScannerScreen({super.key, required this.members});\n\n  @override\n  State<ScannerScreen> createState() => _ScannerScreenState();\n}\n\nclass _ScannerScreenState extends State<ScannerScreen>\n    with SingleTickerProviderStateMixin {\n  CameraController? _controller;\n  Future<void>? _initializeControllerFuture;\n  XFile? _capturedImage;\n  bool _hasCameraError = false;\n  bool _isLoadingCamera = true;\n  bool _isCapturing = false;\n  bool _isProcessing = false;\n  bool _disposed = false;\n  bool _isFrontCamera = false;\n\n  List<CameraDescription> _cameras = [];\n  final _firestore = FirebaseFirestore.instance;\n\n  Map<String, dynamic>? _resultData;\n  bool _noMatch = false;\n\n  late AnimationController _scanAnimationController;\n  late ConfettiController _confettiController;\n\n  @override\n  void initState() {\n    super.initState();\n    _confettiController =\n        ConfettiController(duration: const Duration(seconds: 3));\n    _scanAnimationController = AnimationController(\n      vsync: this,\n      duration: const Duration(seconds: 2),\n    );\n    _initializeCamera();\n  }\n\n  Future<void> _initializeCamera() async {\n    if (_disposed) return;\n    setState(() {\n      _isLoadingCamera = true;\n      _hasCameraError = false;\n      _capturedImage = null;\n      _resultData = null;\n      _noMatch = false;\n    });\n\n    final status = await Permission.camera.request();\n    if (!status.isGranted) {\n      setState(() {\n        _hasCameraError = true;\n        _isLoadingCamera = false;\n      });\n      return;\n    }\n\n    try {\n      await _controller?.dispose();\n      _cameras = await availableCameras();\n      if (_cameras.isEmpty) {\n        setState(() {\n          _hasCameraError = true;\n          _isLoadingCamera = false;\n        });\n        return;\n      }\n\n      final selectedCamera = _cameras.firstWhere(\n        (camera) =>\n            camera.lensDirection ==\n            (_isFrontCamera\n                ? CameraLensDirection.front\n                : CameraLensDirection.back),\n        orElse: () => _cameras.first,\n      );\n\n      _controller = CameraController(\n        selectedCamera,\n        ResolutionPreset.medium,\n        enableAudio: false,\n        imageFormatGroup: ImageFormatGroup.jpeg,\n      );\n\n      _initializeControllerFuture = _controller!.initialize();\n      await _initializeControllerFuture;\n\n      if (mounted && !_disposed) {\n        setState(() => _isLoadingCamera = false);\n      }\n    } catch (e) {\n      logger.e('Camera init error: $e');\n      setState(() {\n        _hasCameraError = true;\n        _isLoadingCamera = false;\n      });\n    }\n  }\n\n  Future<void> _toggleCamera() async {\n    if (_cameras.length < 2) return;\n    setState(() {\n      _isFrontCamera = !_isFrontCamera;\n    });\n    await _initializeCamera();\n  }\n\n  Future<void> _captureImage() async {\n    if (_controller == null || _isCapturing) return;\n\n    setState(() => _isCapturing = true);\n    try {\n      await _controller!.pausePreview();\n      final image = await _controller!.takePicture();\n\n      final bytes = await File(image.path).readAsBytes();\n      Uint8List processedBytes = _isFrontCamera\n          ? await compute(_flipHorizontal, bytes)\n          : await compute(_resizeAndCompressBytes, bytes);\n\n      await File(image.path).writeAsBytes(processedBytes);\n\n      if (mounted) {\n        setState(() {\n          _capturedImage = image;\n          _isCapturing = false;\n        });\n      }\n      await _controller!.resumePreview();\n    } catch (e) {\n      logger.e('Capture error: $e');\n      setState(() => _isCapturing = false);\n    }\n  }\n\n  static Uint8List _flipHorizontal(Uint8List bytes) {\n    final image = img.decodeImage(bytes);\n    if (image == null) return bytes;\n    final flipped = img.flipHorizontal(image);\n    return _resizeAndCompress(flipped);\n  }\n\n  static Uint8List _resizeAndCompressBytes(Uint8List bytes) {\n    final image = img.decodeImage(bytes);\n    if (image == null) return bytes;\n    return _resizeAndCompress(image);\n  }\n\n  static Uint8List _resizeAndCompress(img.Image image) {\n    const maxSize = 512;\n    img.Image resized = image;\n    if (image.width > maxSize || image.height > maxSize) {\n      resized = img.copyResize(image,\n          width: image.width > image.height ? maxSize : null,\n          height: image.height >= image.width ? maxSize : null);\n    }\n    return img.encodeJpg(resized, quality: 85);\n  }\n\n  Future<void> _sendToApi() async {\n    if (_capturedImage == null || _isProcessing) return;\n    setState(() {\n      _isProcessing = true;\n      _resultData = null;\n      _noMatch = false;\n    });\n    _scanAnimationController.repeat(reverse: true);\n\n    try {\n      final apiSnap =\n          await _firestore.collection('api').doc('qHsy9xZJJanFlWFDx7ag').get();\n      final apiUrl = apiSnap.data()?['apiURL'] as String?;\n      if (apiUrl == null || apiUrl.isEmpty) {\n        setState(() => _noMatch = true);\n        return;\n      }\n\n      final bytes = await _capturedImage!.readAsBytes();\n      final base64Image = base64Encode(bytes);\n\n      final response = await http.post(\n        Uri.parse('$apiUrl/recognize'),\n        body: {\n          'members': jsonEncode(widget.members\n              .map((m) => {\n                    'memberName': m['name'],\n                    'memberRelation': m['relation'],\n                    'memberImage': m['imageUrl'],\n                  })\n              .toList()),\n          'imageUrl': 'data:image/jpeg;base64,$base64Image',\n        },\n      );\n\n      if (response.statusCode == 200) {\n        final result = jsonDecode(response.body);\n        if (result['matchFound']) {\n          _confettiController.play();\n          setState(() {\n            _resultData = result;\n            _noMatch = false;\n          });\n        } else {\n          setState(() => _noMatch = true);\n        }\n      } else {\n        setState(() => _noMatch = true);\n      }\n    } catch (e) {\n      logger.e('API error: $e');\n      setState(() => _noMatch = true);\n    } finally {\n      _scanAnimationController.stop();\n      if (mounted) setState(() => _isProcessing = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.black,\n      body: Stack(\n        children: [\n          _isLoadingCamera\n              ? const Center(child: CircularProgressIndicator(color: Colors.white))\n              : _hasCameraError\n                  ? _buildCameraError()\n                  : _capturedImage == null\n                      ? _buildCameraPreview()\n                      : _buildCapturedImage(),\n          Align(\n            alignment: Alignment.topCenter,\n            child: ConfettiWidget(\n              confettiController: _confettiController,\n              blastDirectionality: BlastDirectionality.explosive,\n              shouldLoop: false,\n            ),\n          ),\n        ],\n      ),\n      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,\n      floatingActionButton: _capturedImage == null && !_isProcessing\n          ? _buildCameraControls()\n          : null,\n    );\n  }\n\n  Widget _buildCameraPreview() {\n    return FutureBuilder(\n      future: _initializeControllerFuture,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.done &&\n            _controller != null) {\n          return CameraPreview(_controller!);\n        }\n        return const Center(child: CircularProgressIndicator(color: Colors.white));\n      },\n    );\n  }\n\n  Widget _buildCameraControls() {\n    return Row(\n      mainAxisAlignment: MainAxisAlignment.center,\n      children: [\n        InkWell(\n          onTap: _toggleCamera,\n          borderRadius: BorderRadius.circular(50),\n          child: Container(\n            padding: const EdgeInsets.all(12),\n            decoration: const BoxDecoration(\n              color: Colors.white24,\n              shape: BoxShape.circle,\n            ),\n            child: const Icon(Icons.cameraswitch, color: Colors.white, size: 30),\n          ),\n        ),\n        const SizedBox(width: 40),\n        GestureDetector(\n          onTap: _isCapturing ? null : _captureImage,\n          child: Container(\n            width: 80,\n            height: 80,\n            decoration: BoxDecoration(\n              shape: BoxShape.circle,\n              border: Border.all(color: Colors.white, width: 4),\n            ),\n            child: Center(\n              child: Container(\n                width: 65,\n                height: 65,\n                decoration: const BoxDecoration(\n                  shape: BoxShape.circle,\n                  color: Colors.white,\n                ),\n              ),\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildCapturedImage() {\n    return Stack(\n      children: [\n        Positioned.fill(\n          child: Image.file(\n            File(_capturedImage!.path),\n            fit: BoxFit.cover,\n          ),\n        ),\n        if (_isProcessing) _buildScanAnimationOverlay(),\n        if (_resultData != null || _noMatch)\n          _buildResultOverlay(),\n        if (!_isProcessing && _resultData == null && !_noMatch)\n          _buildConfirmButtons(),\n      ],\n    );\n  }\n\n  Widget _buildScanAnimationOverlay() {\n    return AnimatedBuilder(\n      animation: _scanAnimationController,\n      builder: (context, child) {\n        return Stack(\n          children: [\n            Container(color: Colors.black38),\n            Align(\n              alignment:\n                  Alignment(0, -1 + 2 * _scanAnimationController.value),\n              child: Container(\n                height: 4,\n                width: double.infinity,\n                color: Colors.blueAccent,\n              ),\n            ),\n            const Center(\n              child: Text(\n                'Scanning...',\n                style: TextStyle(color: Colors.white, fontSize: 20),\n              ),\n            ),\n          ],\n        );\n      },\n    );\n  }\n\n  Widget _buildConfirmButtons() {\n    return Positioned(\n      bottom: 60,\n      left: 0,\n      right: 0,\n      child: Row(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          ElevatedButton.icon(\n            onPressed: _sendToApi,\n            style: ElevatedButton.styleFrom(\n              backgroundColor: Colors.green,\n              padding:\n                  const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n              shape: RoundedRectangleBorder(\n                  borderRadius: BorderRadius.circular(12)),\n            ),\n            icon: const Icon(Icons.check),\n            label: const Text('OK', style: TextStyle(fontSize: 16)),\n          ),\n          const SizedBox(width: 20),\n          ElevatedButton.icon(\n            onPressed: () {\n              setState(() {\n                _capturedImage = null;\n                _resultData = null;\n                _noMatch = false;\n              });\n            },\n            style: ElevatedButton.styleFrom(\n              backgroundColor: Colors.redAccent,\n              padding:\n                  const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n              shape: RoundedRectangleBorder(\n                  borderRadius: BorderRadius.circular(12)),\n            ),\n            icon: const Icon(Icons.refresh),\n            label: const Text('Retake', style: TextStyle(fontSize: 16)),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _buildResultOverlay() {\n    return Center(\n      child: Container(\n        padding: const EdgeInsets.all(20),\n        margin: const EdgeInsets.all(24),\n        decoration: BoxDecoration(\n          color: Colors.white.withOpacity(0.95),\n          borderRadius: BorderRadius.circular(16),\n        ),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            if (_resultData != null)\n              Column(\n                children: [\n                  const Text(\n                    'Match Found!',\n                    style: TextStyle(\n                        fontSize: 22,\n                        color: Colors.blueAccent,\n                        fontWeight: FontWeight.bold),\n                  ),\n                  const SizedBox(height: 10),\n                  if (_resultData!['memberImageUrl'] != null)\n                    ClipRRect(\n                      borderRadius: BorderRadius.circular(8),\n                      child: Image.network(\n                        _resultData!['memberImageUrl'],\n                        height: 100,\n                        width: 100,\n                        fit: BoxFit.cover,\n                      ),\n                    ),\n                  const SizedBox(height: 8),\n                  Text('Name: ${_resultData!['memberName']}'),\n                  Text('Relation: ${_resultData!['memberRelation']}'),\n                  Text(\n                      'Confidence: ${(_resultData!['confidence'] * 100).toStringAsFixed(2)}%'),\n                ],\n              )\n            else\n              const Text(\n                'No Match Found',\n                style: TextStyle(\n                    fontSize: 20,\n                    color: Colors.redAccent,\n                    fontWeight: FontWeight.bold),\n              ),\n            const SizedBox(height: 20),\n            Row(\n              mainAxisAlignment: MainAxisAlignment.center,\n              children: [\n                ElevatedButton.icon(\n                  onPressed: () {\n                    Navigator.pop(context);\n                  },\n                  icon: const Icon(Icons.arrow_back),\n                  label: const Text('Back'),\n                  style: ElevatedButton.styleFrom(\n                      backgroundColor: Colors.grey[800]),\n                ),\n                const SizedBox(width: 20),\n                ElevatedButton.icon(\n                  onPressed: () {\n                    setState(() {\n                      _capturedImage = null;\n                      _resultData = null;\n                      _noMatch = false;\n                    });\n                  },\n                  icon: const Icon(Icons.refresh),\n                  label: const Text('Retake'),\n                  style: ElevatedButton.styleFrom(\n                      backgroundColor: Colors.redAccent),\n                ),\n              ],\n            )\n          ],\n        ),\n      ).animate().fadeIn(duration: 400.ms),\n    );\n  }\n\n  Widget _buildCameraError() {\n    return Center(\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          const Icon(Icons.camera_alt, color: Colors.red, size: 64),\n          const SizedBox(height: 12),\n          const Text('Camera not available',\n              style: TextStyle(color: Colors.white)),\n          const SizedBox(height: 16),\n          ElevatedButton(\n            onPressed: _initializeCamera,\n            style:\n                ElevatedButton.styleFrom(backgroundColor: Colors.blueAccent),\n            child: const Text('Retry'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _disposed = true;\n    _controller?.dispose();\n    _scanAnimationController.dispose();\n    _confettiController.dispose();\n    super.dispose();\n  }\n}\n",
          "_encoding": "utf-8"
        },
        "family_screen.dart": {
          "_text": "// lib/user/family/family_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:logger/logger.dart';\nimport 'package:url_launcher/url_launcher.dart';\nimport 'family_add_screen.dart';\nimport 'family_edit_screen.dart';\nimport 'family_scanner_screen.dart';\n\nfinal logger = Logger();\n\nclass FamilyScreen extends StatefulWidget {\n  const FamilyScreen({super.key});\n\n  @override\n  State<FamilyScreen> createState() => _FamilyScreenState();\n}\n\nclass _FamilyScreenState extends State<FamilyScreen> {\n  final _searchController = TextEditingController();\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n\n  String _search = '';\n  bool _isAdding = false;\n  bool _isScanning = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _searchController.addListener(\n      () => setState(() => _search = _searchController.text.toLowerCase()),\n    );\n  }\n\n  Stream<QuerySnapshot> _getFamilyMembersStream() {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return Stream.empty();\n    return _firestore\n        .collection('user')\n        .doc(uid)\n        .collection('family_members')\n        .orderBy('name')\n        .snapshots();\n  }\n\n  Future<void> _callNumber(String number) async {\n    final uri = Uri(scheme: 'tel', path: number);\n    if (await canLaunchUrl(uri)) {\n      await launchUrl(uri);\n    } else if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Could not launch dialer for $number')),\n      );\n    }\n  }\n\n  Widget _buildMemberImage(String? imageUrl) {\n    if (imageUrl == null || imageUrl.isEmpty) {\n      return const Icon(Icons.person, color: Colors.blueAccent);\n    }\n\n    return ClipOval(\n      child: Image.network(\n        imageUrl,\n        width: 40,\n        height: 40,\n        fit: BoxFit.cover,\n        errorBuilder: (context, error, stackTrace) {\n          return const Icon(Icons.person, color: Colors.blueAccent);\n        },\n        loadingBuilder: (context, child, loadingProgress) {\n          if (loadingProgress == null) return child;\n          return const SizedBox(\n            width: 40,\n            height: 40,\n            child: Center(\n              child: CircularProgressIndicator(\n                strokeWidth: 2,\n                color: Colors.blueAccent,\n              ),\n            ),\n          );\n        },\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Family'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Column(\n        children: [\n          Padding(\n            padding: const EdgeInsets.all(16.0),\n            child: TextField(\n              controller: _searchController,\n              decoration: InputDecoration(\n                hintText: 'Search family members...',\n                filled: true,\n                fillColor: Colors.white,\n                border: OutlineInputBorder(\n                  borderRadius: BorderRadius.circular(12),\n                  borderSide: BorderSide.none,\n                ),\n                prefixIcon: const Icon(Icons.search, color: Colors.blueAccent),\n              ),\n            ),\n          ),\n          Expanded(\n            child: StreamBuilder<QuerySnapshot>(\n              stream: _getFamilyMembersStream(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  return const Center(\n                      child: CircularProgressIndicator(color: Colors.blueAccent));\n                }\n      \n                if (snapshot.hasError) {\n                  logger.e('Error loading family members: ${snapshot.error}');\n                  return Center(\n                    child: Column(\n                      mainAxisAlignment: MainAxisAlignment.center,\n                      children: [\n                        const Icon(Icons.error, size: 64, color: Colors.red),\n                        const SizedBox(height: 16),\n                        const Text(\n                          'Error loading family members',\n                          style: TextStyle(fontSize: 18, color: Colors.red),\n                        ),\n                        const SizedBox(height: 16),\n                        ElevatedButton(\n                          onPressed: () => setState(() {}),\n                          style:\n                              ElevatedButton.styleFrom(backgroundColor: Colors.blueAccent),\n                          child: const Text('Retry', style: TextStyle(color: Colors.white)),\n                        ),\n                      ],\n                    ),\n                  );\n                }\n      \n                final docs = snapshot.data?.docs ?? [];\n                final filteredDocs = docs.where((doc) {\n                  final data = doc.data() as Map<String, dynamic>;\n                  final name = (data['name'] ?? '').toString().toLowerCase();\n                  final relation = (data['relation'] ?? '').toString().toLowerCase();\n                  return name.contains(_search) || relation.contains(_search);\n                }).toList();\n      \n                return Column(\n                  children: [\n                    Expanded(\n                      child: filteredDocs.isEmpty\n                          ? const Center(\n                              child: Column(\n                                mainAxisAlignment: MainAxisAlignment.center,\n                                children: [\n                                  Icon(\n                                    Icons.family_restroom,\n                                    size: 64,\n                                    color: Colors.grey,\n                                  ),\n                                  SizedBox(height: 16),\n                                  Text(\n                                    'No family members yet',\n                                    style: TextStyle(fontSize: 18, color: Colors.grey),\n                                  ),\n                                  SizedBox(height: 8),\n                                  Text(\n                                    'Add your first family member',\n                                    style: TextStyle(fontSize: 14, color: Colors.grey),\n                                  ),\n                                ],\n                              ),\n                            )\n                          : RefreshIndicator(\n                              onRefresh: () async => setState(() {}),\n                              child: ListView.builder(\n                                itemCount: filteredDocs.length,\n                                itemBuilder: (context, index) {\n                                  final doc = filteredDocs[index];\n                                  final member = doc.data() as Map<String, dynamic>;\n                                  return Card(\n                                    elevation: 3,\n                                    shape: RoundedRectangleBorder(\n                                        borderRadius: BorderRadius.circular(12)),\n                                    child: ListTile(\n                                      leading: CircleAvatar(\n                                        backgroundColor: Colors.grey[300],\n                                        child: _buildMemberImage(member['imageUrl']),\n                                      ),\n                                      title: Text(member['name'] ?? 'Unnamed'),\n                                      subtitle: Column(\n                                        crossAxisAlignment: CrossAxisAlignment.start,\n                                        children: [\n                                          Text('Relation: ${member['relation'] ?? ''}'),\n                                          Text('Phone: ${member['phone'] ?? ''}'),\n                                        ],\n                                      ),\n                                      trailing: Row(\n                                        mainAxisSize: MainAxisSize.min,\n                                        children: [\n                                          IconButton(\n                                            icon: const Icon(Icons.edit, color: Colors.blue),\n                                            onPressed: () async {\n                                              final editContext = context; // Capture context\n                                              try {\n                                                await Navigator.push(\n                                                  editContext,\n                                                  MaterialPageRoute(\n                                                    builder: (context) => EditScreen(\n                                                      memberId: doc.id, // Pass the document ID\n                                                      memberData: doc.data() as Map<String, dynamic>, // Pass the member data\n                                                    ),\n                                                  ),\n                                                );\n                                              } catch (e) {\n                                                logger.e('Error navigating to edit screen: $e');\n                                                if (editContext.mounted) {\n                                                  ScaffoldMessenger.of(editContext).showSnackBar(\n                                                    SnackBar(content: Text('Error opening edit screen: $e')),\n                                                  );\n                                                }\n                                              }\n                                            },\n                                          ),\n                                          IconButton(\n                                            icon: const Icon(Icons.delete, color: Colors.red),\n                                            onPressed: () async {\n                                              final deleteContext = context; // Capture context\n                                              final confirm = await showDialog<bool>(\n                                                context: deleteContext,\n                                                builder: (context) => AlertDialog(\n                                                  title: const Text('Delete Family Member'),\n                                                  content: const Text('Are you sure?'),\n                                                  actions: [\n                                                    TextButton(\n                                                      onPressed: () =>\n                                                          Navigator.pop(context, false),\n                                                      child: const Text('Cancel'),\n                                                    ),\n                                                    ElevatedButton(\n                                                      style: ElevatedButton.styleFrom(\n                                                          backgroundColor: Colors.red),\n                                                      onPressed: () => Navigator.pop(context, true),\n                                                      child: const Text(\n                                                        'Delete',\n                                                        style: TextStyle(color: Colors.white)),\n                                                    ),\n                                                  ],\n                                                ),\n                                              );\n                                              if (confirm == true && deleteContext.mounted) {\n                                                try {\n                                                  await doc.reference.delete();\n                                                } catch (e) {\n                                                  logger.e('Error deleting member: $e');\n                                                  if (deleteContext.mounted) {\n                                                    ScaffoldMessenger.of(deleteContext)\n                                                        .showSnackBar(\n                                                      SnackBar(content: Text('Error deleting: $e')),\n                                                    );\n                                                  }\n                                                }\n                                              }\n                                            },\n                                          ),\n                                          IconButton(\n                                            icon: const Icon(Icons.phone, color: Colors.green),\n                                            onPressed: () {\n                                              final phone = member['phone'];\n                                              if (phone != null && phone.isNotEmpty) {\n                                                _callNumber(phone);\n                                              }\n                                            },\n                                          ),\n                                        ],\n                                      ),\n                                    ),\n                                  );\n                                },\n                              ),\n                            ),\n                    ),\n                    // Move buttons inside StreamBuilder to access snapshot\n                    Padding(\n                      padding: const EdgeInsets.all(16.0),\n                      child: Row(\n                        mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                        children: [\n                          _isAdding\n                              ? const CircularProgressIndicator(color: Colors.orange)\n                              : FloatingActionButton.extended(\n                                  backgroundColor: Colors.orange,\n                                  icon: const Icon(Icons.add, color: Colors.white),\n                                  label: const Text('Add Member',\n                                      style: TextStyle(color: Colors.white)),\n                                  onPressed: () async {\n                                    final addContext = context; // Capture context\n                                    setState(() => _isAdding = true);\n                                    try {\n                                      await Navigator.push(\n                                        addContext,\n                                        MaterialPageRoute(\n                                          builder: (context) => const AddScreen(),\n                                        ),\n                                      );\n                                    } catch (e) {\n                                      logger.e('Error navigating to add screen: $e');\n                                      if (addContext.mounted) {\n                                        ScaffoldMessenger.of(addContext).showSnackBar(\n                                          SnackBar(\n                                              content: Text('Error opening add screen: $e')),\n                                        );\n                                      }\n                                    } finally {\n                                      if (mounted) setState(() => _isAdding = false);\n                                    }\n                                  },\n                                ),\n                          _isScanning\n                              ? const CircularProgressIndicator(color: Colors.orange)\n                              : FloatingActionButton.extended(\n                                  backgroundColor: Colors.orange,\n                                  icon: const Icon(Icons.camera_alt, color: Colors.white),\n                                  label:\n                                      const Text('Scan', style: TextStyle(color: Colors.white)),\n                                  onPressed: () async {\n                                    final scanContext = context; // Capture context\n                                    setState(() => _isScanning = true);\n                                    try {\n                                      final result = await Navigator.push(\n                                        scanContext,\n                                        MaterialPageRoute(\n                                          builder: (context) => ScannerScreen(\n                                            members: snapshot.data?.docs.map((doc) {\n                                                  final data = doc.data() as Map<String, dynamic>;\n                                                  return {\n                                                    'name': data['name'] ?? '',\n                                                    'relation': data['relation'] ?? '',\n                                                    'imageUrl': data['imageUrl'] ?? '',\n                                                  };\n                                                }).toList() ?? [],\n                                          ),\n                                        ),\n                                      );\n                                      if (result != null && result['matchFound'] && scanContext.mounted) {\n                                        ScaffoldMessenger.of(scanContext).showSnackBar(\n                                          SnackBar(\n                                            content: Text('Match found: ${result['memberName']}'),\n                                          ),\n                                        );\n                                      }\n                                    } catch (e) {\n                                      logger.e('Error navigating to ScannerScreen: $e');\n                                      if (scanContext.mounted) {\n                                        ScaffoldMessenger.of(scanContext).showSnackBar(\n                                          SnackBar(content: Text('Error opening scanner: $e')),\n                                        );\n                                      }\n                                    } finally {\n                                      if (mounted) setState(() => _isScanning = false);\n                                    }\n                                  },\n                                ),\n                        ],\n                      ),\n                    ),\n                  ],\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _searchController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "home": {
        "add_task_page.dart": {
          "_text": "// lib/user/home/add_task_page.dart\n// lib/user/home/add_task_page.dart\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\n\nclass AddTaskPage extends StatefulWidget {\n  final bool isTemplate;\n  const AddTaskPage({super.key, this.isTemplate = false});\n\n  @override\n  State<AddTaskPage> createState() => _AddTaskPageState();\n}\n\nclass _AddTaskPageState extends State<AddTaskPage> {\n  final TextEditingController _taskController = TextEditingController();\n  final TextEditingController _descController = TextEditingController();\n  String _recurring = 'None';\n  DateTime? _dueDate;\n  DateTime? _reminderTime;\n  TimeOfDay? _dailyDueTime;\n  TimeOfDay? _dailyReminderTime;\n\n  Future<void> _pickDueDate() async {\n    final picked = await showDatePicker(\n      context: context,\n      initialDate: DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (picked != null && mounted) {\n      final time = await showTimePicker(\n        context: context,\n        initialTime: TimeOfDay.now(),\n      );\n      if (time != null && mounted) {\n        setState(() {\n          _dueDate = DateTime(\n            picked.year,\n            picked.month,\n            picked.day,\n            time.hour,\n            time.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickReminderTime() async {\n    final pickedDate = await showDatePicker(\n      context: context,\n      initialDate: DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (pickedDate != null && mounted) {\n      final pickedTime = await showTimePicker(\n        context: context,\n        initialTime: TimeOfDay.now(),\n      );\n      if (pickedTime != null && mounted) {\n        setState(() {\n          _reminderTime = DateTime(\n            pickedDate.year,\n            pickedDate.month,\n            pickedDate.day,\n            pickedTime.hour,\n            pickedTime.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickDailyDueTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyDueTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyDueTime = picked);\n  }\n\n  Future<void> _pickDailyReminderTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyReminderTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyReminderTime = picked);\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    if (widget.isTemplate) {\n      _recurring = 'Daily';\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isDaily = _recurring == 'Daily';\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(isDaily || widget.isTemplate ? 'Add Daily Template' : 'Add Task'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\n                'Task Details',\n                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 24),\n              TextField(\n                controller: _taskController,\n                decoration: InputDecoration(\n                  labelText: 'Task Name',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.task),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: _descController,\n                decoration: InputDecoration(\n                  labelText: 'Description (optional)',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.description),\n                ),\n                maxLines: 3,\n              ),\n              const SizedBox(height: 24),\n              const Text(\n                'Recurrence',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),\n              ),\n              const SizedBox(height: 8),\n              DropdownButtonFormField<String>(\n                value: _recurring,\n                decoration: InputDecoration(\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                ),\n                items: ['None', 'Daily'].map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),\n                onChanged: (val) => setState(() => _recurring = val!),\n              ),\n              const SizedBox(height: 24),\n              if (!isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dueDate == null ? 'Set Due Date & Time' : DateFormat('MMM dd, yyyy hh:mm a').format(_dueDate!)),\n                    trailing: const Icon(Icons.calendar_today, color: Colors.blueAccent),\n                    onTap: _pickDueDate,\n                  ),\n                ),\n              if (!isDaily) const SizedBox(height: 8),\n              if (!isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_reminderTime == null ? 'Set Reminder (optional)' : DateFormat('MMM dd, yyyy hh:mm a').format(_reminderTime!)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickReminderTime,\n                  ),\n                ),\n              if (isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyDueTime == null ? 'Set Daily Due Time' : _dailyDueTime!.format(context)),\n                    trailing: const Icon(Icons.access_time, color: Colors.blueAccent),\n                    onTap: _pickDailyDueTime,\n                  ),\n                ),\n              if (isDaily) const SizedBox(height: 8),\n              if (isDaily)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyReminderTime == null ? 'Set Daily Reminder (optional)' : _dailyReminderTime!.format(context)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickDailyReminderTime,\n                  ),\n                ),\n              const SizedBox(height: 32),\n              ElevatedButton(\n                onPressed: () {\n                  if (_taskController.text.trim().isEmpty) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Task name cannot be empty')),\n                    );\n                    return;\n                  }\n                  if (isDaily && _dailyDueTime == null) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Daily due time required')),\n                    );\n                    return;\n                  }\n                  final map = <String, dynamic>{\n                    'task': _taskController.text.trim(),\n                    'description': _descController.text.trim(),\n                    'recurring': _recurring,\n                  };\n                  if (isDaily) {\n                    map['dailyDueTime'] = _dailyDueTime != null \n                      ? {'hour': _dailyDueTime!.hour, 'min': _dailyDueTime!.minute} \n                      : null;\n                    map['dailyReminderTime'] = _dailyReminderTime != null \n                      ? {'hour': _dailyReminderTime!.hour, 'min': _dailyReminderTime!.minute} \n                      : null;\n                  } else {\n                    map['dueDate'] = _dueDate;\n                    map['reminderTime'] = _reminderTime;\n                  }\n                  Navigator.pop(context, map);\n                },\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.blueAccent,\n                  padding: const EdgeInsets.symmetric(vertical: 16),\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  minimumSize: const Size(double.infinity, 50),\n                ),\n                child: const Text('Save', style: TextStyle(fontSize: 18, color: Colors.white)),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _taskController.dispose();\n    _descController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "ai_chat_page.dart": {
          "_text": "// lib/user/home/ai_chat_page.dart\nimport 'dart:convert';\nimport 'dart:developer';\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter_animate/flutter_animate.dart';\nimport 'package:flutter_gemini/flutter_gemini.dart';\nimport 'package:intl/intl.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\n\nclass AIChatPage extends StatefulWidget {\n  const AIChatPage({super.key});\n\n  @override\n  State<AIChatPage> createState() => _AIChatPageState();\n}\n\nclass _AIChatPageState extends State<AIChatPage> {\n  final TextEditingController _controller = TextEditingController();\n  final String currentUserId = FirebaseAuth.instance.currentUser!.uid;\n  final String _chatStorageKey = 'dementia_ai_chat_history';\n  final List<String> _userInputHistory = [];\n  final _firestore = FirebaseFirestore.instance;\n  final _gemini = Gemini.instance;\n  late SharedPreferences _prefs;\n\n  List<Map<String, String>> _chatHistory = [];\n  Map<String, dynamic>? _userData;\n  int _remainingTasks = 0;\n  int _completedTasks = 0;\n  String _systemPrompt = '';\n  bool _isLoading = false;\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    _initializeStorage();\n    _fetchUserData();\n  }\n\n  Future<void> _initializeStorage() async {\n    _prefs = await SharedPreferences.getInstance();\n    _loadChatHistory();\n  }\n\n  Future<void> _loadChatHistory() async {\n    try {\n      final String? chatHistoryJson = _prefs.getString(_chatStorageKey);\n      if (chatHistoryJson != null) {\n        final List<dynamic> decodedList = json.decode(chatHistoryJson);\n        if (mounted) {\n          setState(() {\n            _chatHistory = decodedList\n                .map((item) => Map<String, String>.from(item))\n                .toList();\n          });\n        }\n      }\n    } catch (e) {\n      log('Error loading chat history: $e');\n    }\n  }\n\n  Future<void> _saveChatHistory() async {\n    try {\n      final String chatHistoryJson = json.encode(_chatHistory);\n      await _prefs.setString(_chatStorageKey, chatHistoryJson);\n    } catch (e) {\n      log('Error saving chat history: $e');\n    }\n  }\n\n  void _addMessageToHistory(Map<String, String> message) {\n    if (message['role'] != 'error') {\n      if (mounted) {\n        setState(() {\n          _chatHistory.add(message);\n        });\n      }\n      _saveChatHistory();\n    } else {\n      if (mounted) {\n        setState(() {\n          _chatHistory.add(message);\n        });\n        Future.delayed(const Duration(seconds: 5), () {\n          if (mounted) {\n            setState(() {\n              _chatHistory.removeWhere((msg) =>\n                  msg['role'] == 'error' &&\n                  msg['message'] == message['message']);\n            });\n          }\n        });\n      }\n    }\n  }\n\n  Future<void> _fetchUserData() async {\n  try {\n    if (mounted) setState(() => _isLoading = true);\n\n    final uid = currentUserId;\n\n    // Load user data\n    final userDoc = await _firestore.collection('user').doc(uid).get();\n    if (userDoc.exists && mounted) {\n      setState(() {\n        _userData = userDoc.data();\n      });\n    }\n\n    // Load today's tasks\n    final today = DateTime.now();\n    final todayStart = Timestamp.fromDate(\n      DateTime(today.year, today.month, today.day),\n    );\n    final todayEnd = Timestamp.fromDate(\n      DateTime(today.year, today.month, today.day, 23, 59, 59),\n    );\n\n    final tasksSnap = await _firestore\n        .collection('user')\n        .doc(uid)\n        .collection('to_dos')\n        .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n        .where('dueDate', isLessThanOrEqualTo: todayEnd)\n        .get();\n\n    final incompleteTasks = tasksSnap.docs\n        .where((doc) => doc.data()['completed'] == false)\n        .map((doc) {\n      final data = doc.data();\n      final dueTime = data['dueDate'] != null\n          ? DateFormat('hh:mm a').format((data['dueDate'] as Timestamp).toDate())\n          : 'Unknown time';\n      return '- ${data['task']} (Due: $dueTime)';\n    }).toList();\n\n    if (mounted) {\n      setState(() {\n        _remainingTasks = incompleteTasks.length;\n        _completedTasks = tasksSnap.docs.length - incompleteTasks.length;\n\n        // Build system prompt\n        _systemPrompt = '''\nYou are a compassionate AI assistant named \"Dementia Helper\" for a person with dementia.\n- Provide gentle reminders about tasks.\n- Remind about incomplete tasks with names and due times.\n- Offer emotional support and guidance.\n- Keep responses concise, calm, and positive.\n\nUser Info:\n- Name: ${_userData?['fullName'] ?? 'User'}\n- Age: ${_calculateAge(_userData?['dob']) ?? 'Unknown'}\n- Today's date: ${DateFormat('MMMM dd, yyyy').format(DateTime.now())}\n\nToday's incomplete tasks:\n${incompleteTasks.isEmpty ? 'No pending tasks' : incompleteTasks.join('\\n')}\n\nSummary:\n- Remaining tasks: $_remainingTasks\n- Completed tasks: $_completedTasks\n\nAlways start conversations with a warm greeting and address the user by name if important. If the user mentions tasks, reference the summary above. Encourage completion of remaining tasks gently. If asked about past events, suggest checking the diary. Never overwhelm with too much information.\n''';\n\n        // Initial AI greeting\n        if (_chatHistory.isEmpty) {\n          _addMessageToHistory({\n            'role': 'model',\n            'message':\n                'Hello ${_userData?['fullName'] ?? 'there'}! You have $_remainingTasks tasks left for today. I\\'m your Dementia Helper. How can I assist you?',\n          });\n        }\n      });\n    }\n  } catch (e) {\n    log('Error fetching user data: $e');\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Error loading data: $e')),\n      );\n    }\n  } finally {\n    if (mounted) setState(() => _isLoading = false);\n  }\n}\n\n\n  int? _calculateAge(Timestamp? dob) {\n    if (dob == null) return null;\n    final birthDate = dob.toDate();\n    final today = DateTime.now();\n    int age = today.year - birthDate.year;\n    if (today.month < birthDate.month ||\n        (today.month == birthDate.month && today.day < birthDate.day)) {\n      age--;\n    }\n    return age;\n  }\n\n  Future<void> clearChatHistory() async {\n    try {\n      await _prefs.remove(_chatStorageKey);\n      if (mounted) {\n        setState(() {\n          _chatHistory = [];\n          _addMessageToHistory({\n            'role': 'model',\n            'message':\n                'Hello ${_userData?['fullName'] ?? 'there'}! I\\'m your Dementia Helper. How can I assist you today? You have $_remainingTasks tasks left for today.',\n          });\n        });\n      }\n    } catch (e) {\n      log('Error clearing chat history: $e');\n    }\n  }\n\n  Future<void> _showClearChatDialog() async {\n    return showDialog<void>(\n      context: context,\n      builder: (BuildContext context) {\n        return AlertDialog(\n          backgroundColor: Colors.white,\n          title: const Text('Clear Chat History'),\n          content: const Text(\n            'Are you sure you want to clear all chat history? This action cannot be undone.',\n          ),\n          actions: <Widget>[\n            TextButton(\n              child: const Text('Cancel'),\n              onPressed: () {\n                Navigator.of(context).pop();\n              },\n            ),\n            TextButton(\n              child: const Text(\n                'Clear',\n                style: TextStyle(color: Colors.red),\n              ),\n              onPressed: () {\n                clearChatHistory();\n                Navigator.of(context).pop();\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(\n                    content: Text('Chat history cleared'),\n                    duration: Duration(seconds: 2),\n                  ),\n                );\n              },\n            ),\n          ],\n        );\n      },\n    );\n  }\n\n  void _sendMessage(String userMessage) async {\n    if (userMessage.trim().isEmpty) return;\n\n    _userInputHistory.add(userMessage);\n    if (_userInputHistory.length > 5) {\n      _userInputHistory.removeAt(0);\n    }\n\n    _addMessageToHistory({'role': 'user', 'message': userMessage});\n\n    if (mounted) {\n      setState(() {\n        _isLoading = true;\n      });\n    }\n\n    try {\n      final conversation = [\n        Content(parts: [Part.text(_systemPrompt)], role: 'user'),\n        ..._chatHistory.map(\n          (msg) => Content(\n            parts: [Part.text(msg['message']!)],\n            role: msg['role'],\n          ),\n        ),\n        Content(parts: [Part.text(userMessage)], role: 'user'),\n      ];\n      final response = await _gemini.chat(conversation);\n      if (mounted) {\n        setState(() {\n          _addMessageToHistory({\n            'role': 'model',\n            'message': response?.output ?? 'No response received',\n          });\n        });\n      }\n    } catch (e) {\n      log('Error in chat: $e');\n      if (mounted) {\n        setState(() {\n          _addMessageToHistory({\n            'role': 'error',\n            'message':\n                'Response not loading. Please try again or check your internet connection.',\n          });\n        });\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          _isLoading = false;\n        });\n      }\n    }\n  }\n\n  Widget _buildMessageBubble(String message, String role,\n      {bool isLoading = false}) {\n    bool isUser = role == 'user';\n    return Align(\n      alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,\n      child: Container(\n        margin: const EdgeInsets.symmetric(vertical: 8.0, horizontal: 12.0),\n        padding: const EdgeInsets.symmetric(vertical: 15.0, horizontal: 18.0),\n        decoration: BoxDecoration(\n          color: isUser ? Colors.blueAccent : Colors.grey[200],\n          borderRadius: BorderRadius.only(\n            topLeft: const Radius.circular(20.0),\n            topRight: const Radius.circular(20.0),\n            bottomLeft: isUser ? const Radius.circular(20.0) : Radius.zero,\n            bottomRight: isUser ? Radius.zero : const Radius.circular(20.0),\n          ),\n          boxShadow: [\n            BoxShadow(\n              color: Colors.black.withOpacity(0.1),\n              offset: const Offset(0, 2),\n              blurRadius: 4.0,\n            ),\n          ],\n        ),\n        child: isLoading\n            ? const LoadingAnimation()\n            : Text(\n                message,\n                style: TextStyle(\n                  fontSize: 16.0,\n                  color: isUser ? Colors.white : Colors.black87,\n                  fontWeight: FontWeight.w400,\n                  height: 1.4,\n                ),\n              ),\n      ),\n    );\n  }\n\n  Widget _buildChatList() {\n    return ListView.builder(\n      itemCount: _chatHistory.length + (_isLoading ? 1 : 0),\n      padding: const EdgeInsets.symmetric(vertical: 8.0),\n      itemBuilder: (context, index) {\n        if (index == _chatHistory.length && _isLoading) {\n          return _buildMessageBubble('', 'model', isLoading: true);\n        }\n        final message = _chatHistory[index];\n        return _buildMessageBubble(message['message']!, message['role']!)\n            .animate()\n            .fadeIn(duration: 300.ms)\n            .slideX(begin: message['role'] == 'user' ? 0.2 : -0.2);\n      },\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.white,\n      appBar: AppBar(\n        backgroundColor: Colors.blueAccent,\n        iconTheme: const IconThemeData(color: Colors.white),\n        title: Row(\n          children: [\n            const CircleAvatar(\n              backgroundImage: AssetImage('assets/aiIcon.png'),\n              backgroundColor: Colors.blueAccent,\n              radius: 30,\n            ),\n            const SizedBox(width: 10),\n            const Text(\n              'Dementia Helper',\n              style: TextStyle(fontSize: 18, color: Colors.white),\n            ),\n          ],\n        ),\n        actions: [\n          if (_chatHistory.isNotEmpty)\n            IconButton(\n              icon: const Icon(Icons.delete_outline),\n              onPressed: _showClearChatDialog,\n              tooltip: 'Clear chat history',\n            ),\n        ],\n      ),\n      body: SafeArea(\n        child: Column(\n          children: [\n            Expanded(\n              child: _isLoading && _chatHistory.isEmpty\n                  ? const Center(child: LoadingAnimation())\n                  : _chatHistory.isEmpty\n                      ? const Center(\n                          child: Text(\n                            'Start a conversation with Dementia Helper',\n                            style:\n                                TextStyle(fontSize: 16, color: Colors.black54),\n                          ),\n                        )\n                      : _buildChatList(),\n            ),\n            const Divider(height: 1),\n            Container(\n              color: Colors.grey[200],\n              child: Padding(\n                padding: const EdgeInsets.all(8.0),\n                child: Row(\n                  children: [\n                    Expanded(\n                      child: Padding(\n                        padding: const EdgeInsets.symmetric(horizontal: 10),\n                        child: TextField(\n                          controller: _controller,\n                          decoration: InputDecoration(\n                            hintText: 'Type a message...',\n                            hintStyle: const TextStyle(\n                                color: Colors.black54, fontSize: 16),\n                            filled: true,\n                            fillColor: Colors.white,\n                            contentPadding: const EdgeInsets.symmetric(\n                                vertical: 16, horizontal: 16),\n                            border: OutlineInputBorder(\n                              borderRadius: BorderRadius.circular(30),\n                              borderSide: BorderSide.none,\n                            ),\n                            focusedBorder: OutlineInputBorder(\n                              borderRadius: BorderRadius.circular(30),\n                              borderSide: BorderSide.none,\n                            ),\n                            enabledBorder: OutlineInputBorder(\n                              borderRadius: BorderRadius.circular(30),\n                              borderSide: BorderSide.none,\n                            ),\n                          ),\n                          minLines: 1,\n                          maxLines: 5,\n                          onSubmitted: (_) {\n                            final message = _controller.text;\n                            _controller.clear();\n                            _sendMessage(message);\n                          },\n                          style: const TextStyle(color: Colors.black87),\n                        ),\n                      ),\n                    ),\n                    Padding(\n                      padding: const EdgeInsets.only(left: 4),\n                      child: IconButton(\n                        icon: const Icon(\n                          Icons.send,\n                          color: Colors.blueAccent,\n                        ),\n                        onPressed: () {\n                          final message = _controller.text;\n                          _controller.clear();\n                          _sendMessage(message);\n                        },\n                        splashColor: Colors.blueAccent.withOpacity(0.3),\n                        splashRadius: 25,\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass LoadingAnimation extends StatelessWidget {\n  const LoadingAnimation({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    return const SizedBox(\n      width: 20,\n      height: 20,\n      child: CircularProgressIndicator(\n        strokeWidth: 2.0,\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        },
        "edit_task_page.dart": {
          "_text": "// lib/user/home/edit_task_page.dart\n// lib/user/home/edit_task_page.dart\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\n\nclass EditTaskPage extends StatefulWidget {\n  final String taskName;\n  final String description;\n  final DateTime? dueDate;\n  final DateTime? reminderTime;\n  final bool isTemplate;\n  final Map<String, dynamic>? dailyDueTime;\n  final Map<String, dynamic>? dailyReminderTime;\n\n  const EditTaskPage({\n    super.key,\n    required this.taskName,\n    required this.description,\n    this.dueDate,\n    this.reminderTime,\n    this.isTemplate = false,\n    this.dailyDueTime,\n    this.dailyReminderTime,\n  });\n\n  @override\n  State<EditTaskPage> createState() => _EditTaskPageState();\n}\n\nclass _EditTaskPageState extends State<EditTaskPage> {\n  late TextEditingController _taskController;\n  late TextEditingController _descController;\n  DateTime? _dueDate;\n  DateTime? _reminderTime;\n  TimeOfDay? _dailyDueTime;\n  TimeOfDay? _dailyReminderTime;\n\n  @override\n  void initState() {\n    super.initState();\n    _taskController = TextEditingController(text: widget.taskName);\n    _descController = TextEditingController(text: widget.description);\n    _dueDate = widget.dueDate;\n    _reminderTime = widget.reminderTime;\n    if (widget.dailyDueTime != null) {\n      _dailyDueTime = TimeOfDay(hour: widget.dailyDueTime!['hour'], minute: widget.dailyDueTime!['min']);\n    }\n    if (widget.dailyReminderTime != null) {\n      _dailyReminderTime = TimeOfDay(hour: widget.dailyReminderTime!['hour'], minute: widget.dailyReminderTime!['min']);\n    }\n  }\n\n  Future<void> _pickDueDate() async {\n    final picked = await showDatePicker(\n      context: context,\n      initialDate: _dueDate ?? DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (picked != null && mounted) {\n      final time = await showTimePicker(\n        context: context,\n        initialTime: _dueDate != null ? TimeOfDay.fromDateTime(_dueDate!) : TimeOfDay.now(),\n      );\n      if (time != null && mounted) {\n        setState(() {\n          _dueDate = DateTime(\n            picked.year,\n            picked.month,\n            picked.day,\n            time.hour,\n            time.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickReminderTime() async {\n    final pickedDate = await showDatePicker(\n      context: context,\n      initialDate: _reminderTime ?? DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime(2100),\n    );\n    if (pickedDate != null && mounted) {\n      final pickedTime = await showTimePicker(\n        context: context,\n        initialTime: _reminderTime != null ? TimeOfDay.fromDateTime(_reminderTime!) : TimeOfDay.now(),\n      );\n      if (pickedTime != null && mounted) {\n        setState(() {\n          _reminderTime = DateTime(\n            pickedDate.year,\n            pickedDate.month,\n            pickedDate.day,\n            pickedTime.hour,\n            pickedTime.minute,\n          );\n        });\n      }\n    }\n  }\n\n  Future<void> _pickDailyDueTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyDueTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyDueTime = picked);\n  }\n\n  Future<void> _pickDailyReminderTime() async {\n    final picked = await showTimePicker(\n      context: context,\n      initialTime: _dailyReminderTime ?? TimeOfDay.now(),\n    );\n    if (picked != null && mounted) setState(() => _dailyReminderTime = picked);\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isTemplate = widget.isTemplate;\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(isTemplate ? 'Edit Template' : 'Edit Task'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\n                'Edit Task Details',\n                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 24),\n              TextField(\n                controller: _taskController,\n                decoration: InputDecoration(\n                  labelText: 'Task Name',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.task),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: _descController,\n                decoration: InputDecoration(\n                  labelText: 'Description (optional)',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.description),\n                ),\n                maxLines: 3,\n              ),\n              const SizedBox(height: 24),\n              if (!isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dueDate == null ? 'Set Due Date & Time' : DateFormat('MMM dd, yyyy hh:mm a').format(_dueDate!)),\n                    trailing: const Icon(Icons.calendar_today, color: Colors.blueAccent),\n                    onTap: _pickDueDate,\n                  ),\n                ),\n              if (!isTemplate) const SizedBox(height: 8),\n              if (!isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_reminderTime == null ? 'Set Reminder (optional)' : DateFormat('MMM dd, yyyy hh:mm a').format(_reminderTime!)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickReminderTime,\n                  ),\n                ),\n              if (isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyDueTime == null ? 'Set Daily Due Time' : _dailyDueTime!.format(context)),\n                    trailing: const Icon(Icons.access_time, color: Colors.blueAccent),\n                    onTap: _pickDailyDueTime,\n                  ),\n                ),\n              if (isTemplate) const SizedBox(height: 8),\n              if (isTemplate)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: ListTile(\n                    title: Text(_dailyReminderTime == null ? 'Set Daily Reminder (optional)' : _dailyReminderTime!.format(context)),\n                    trailing: const Icon(Icons.alarm, color: Colors.orange),\n                    onTap: _pickDailyReminderTime,\n                  ),\n                ),\n              const SizedBox(height: 32),\n              ElevatedButton(\n                onPressed: () {\n                  if (_taskController.text.trim().isEmpty) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Task name cannot be empty')),\n                    );\n                    return;\n                  }\n                  if (isTemplate && _dailyDueTime == null) {\n                    ScaffoldMessenger.of(context).showSnackBar(\n                      const SnackBar(content: Text('Daily due time required')),\n                    );\n                    return;\n                  }\n                  final map = <String, dynamic>{\n                    'task': _taskController.text.trim(),\n                    'description': _descController.text.trim(),\n                  };\n                  if (isTemplate) {\n                    map['dailyDueTime'] = _dailyDueTime != null \n                      ? {'hour': _dailyDueTime!.hour, 'min': _dailyDueTime!.minute} \n                      : null;\n                    map['dailyReminderTime'] = _dailyReminderTime != null \n                      ? {'hour': _dailyReminderTime!.hour, 'min': _dailyReminderTime!.minute} \n                      : null;\n                  } else {\n                    map['dueDate'] = _dueDate;\n                    map['reminderTime'] = _reminderTime;\n                  }\n                  Navigator.pop(context, map);\n                },\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.blueAccent,\n                  padding: const EdgeInsets.symmetric(vertical: 16),\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  minimumSize: const Size(double.infinity, 50),\n                ),\n                child: const Text('Save Changes', style: TextStyle(fontSize: 18, color: Colors.white)),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _taskController.dispose();\n    _descController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "home_screen.dart": {
          "_text": "// lib/user/home/home_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport 'package:logger/logger.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport '../notifications/notifications_screen.dart';\nimport '../../utils/notification_helper.dart';\nimport 'add_task_page.dart';\nimport 'ai_chat_page.dart';\nimport 'edit_task_page.dart';\n\nfinal logger = Logger();\n\nclass HomeScreen extends StatefulWidget {\n  const HomeScreen({super.key});\n\n  @override\n  State<HomeScreen> createState() => _HomeScreenState();\n}\n\nclass _HomeScreenState extends State<HomeScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  String _selectedTab = 'Today';\n\n  @override\n  void initState() {\n    super.initState();\n    _checkBanned();\n    _generateDailyTasks();\n  }\n\n  Future<void> _checkBanned() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n    try {\n      final doc = await _firestore.collection('user').doc(uid).get();\n      if (doc.data()?['isBanned'] == true) {\n        await _auth.signOut();\n        if (mounted) {\n          Navigator.pushReplacementNamed(context, '/welcome');\n        }\n      }\n    } catch (e) {\n      logger.e('Error checking banned status: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error checking user status: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _generateDailyTasks() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n\n    final prefs = await SharedPreferences.getInstance();\n    final todayStr = DateFormat('yyyy-MM-dd').format(DateTime.now());\n    final lastGenerate = prefs.getString('last_generate_date');\n    if (lastGenerate == todayStr) return;\n\n    try {\n      final recurringSnap = await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('recurring_tasks')\n          .get();\n      for (var rec in recurringSnap.docs) {\n        final data = rec.data();\n        final dailyDue = data['dailyDueTime'];\n        if (dailyDue == null) continue;\n\n        final today = DateTime.now();\n        final dueDate = DateTime(\n            today.year, today.month, today.day, dailyDue['hour'], dailyDue['min']);\n        final dueTs = Timestamp.fromDate(dueDate);\n\n        final reminder = data['dailyReminderTime'];\n        Timestamp? reminderTs;\n        if (reminder != null) {\n          final remDate = DateTime(today.year, today.month, today.day,\n              reminder['hour'], reminder['min']);\n          reminderTs = Timestamp.fromDate(remDate);\n        }\n\n        final existing = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('to_dos')\n            .where('recurringId', isEqualTo: rec.id)\n            .where('dueDate', isEqualTo: dueTs)\n            .get();\n\n        if (existing.docs.isEmpty) {\n          await _firestore.collection('user').doc(uid).collection('to_dos').add({\n            'task': data['task'],\n            'description': data['description'],\n            'completed': false,\n            'createdAt': Timestamp.now(),\n            'dueDate': dueTs,\n            'reminderTime': reminderTs,\n            'recurringId': rec.id,\n            'createdBy': 'system',\n          });\n\n          if (reminderTs != null && reminderTs.toDate().isAfter(DateTime.now())) {\n            final userPlayerIds = await _getUserPlayerIds();\n            final caretakerPlayerIds = await _getCaretakerPlayerIds();\n            final all = [...userPlayerIds, ...caretakerPlayerIds];\n            await scheduleNotification(\n                all, 'Daily Task Reminder: ${data['task']}', reminderTs.toDate());\n          }\n        }\n      }\n      await prefs.setString('last_generate_date', todayStr);\n    } catch (e) {\n      logger.e('Error generating daily tasks: $e');\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error generating tasks: $e')),\n        );\n      }\n    }\n  }\n\n  Stream<QuerySnapshot<Map<String, dynamic>>> _getTasksStream() {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return Stream.empty();\n\n    final coll = _firestore.collection('user').doc(uid).collection('to_dos');\n\n    final todayStart = Timestamp.fromDate(\n        DateTime.now().subtract(const Duration(days: 1)).add(const Duration(hours: 24)));\n    final todayEnd = Timestamp.fromDate(DateTime.now().add(const Duration(days: 1)));\n\n    if (_selectedTab == 'Recurring') {\n      return _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('recurring_tasks')\n          .orderBy('createdAt', descending: true)\n          .snapshots();\n    } else if (_selectedTab == 'Today') {\n      return coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n          .where('dueDate', isLessThan: todayEnd)\n          .orderBy('dueDate')\n          .limit(50)\n          .snapshots();\n    } else if (_selectedTab == 'Upcoming') {\n      return coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayEnd)\n          .orderBy('dueDate')\n          .limit(50)\n          .snapshots();\n    } else if (_selectedTab == 'Completed') {\n      return coll.where('completed', isEqualTo: true).snapshots();\n    } else if (_selectedTab == 'All') {\n      return coll.orderBy('dueDate', descending: true).limit(50).snapshots();\n    } else {\n      return Stream.empty();\n    }\n  }\n\n  Future<int> _getRemainingToday() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return 0;\n\n    final coll = _firestore.collection('user').doc(uid).collection('to_dos');\n    final todayStart = Timestamp.fromDate(\n        DateTime.now().subtract(const Duration(days: 1)).add(const Duration(hours: 24)));\n    final todayEnd = Timestamp.fromDate(DateTime.now().add(const Duration(days: 1)));\n\n    try {\n      // Workaround: Simplified query to avoid composite index requirement\n      final snap = await coll\n          .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n          .where('dueDate', isLessThan: todayEnd)\n          .get();\n      // Filter completed tasks in code\n      final incompleteTasks = snap.docs\n          .where((doc) => doc.data()['completed'] == false)\n          .length;\n      return incompleteTasks;\n    } catch (e) {\n      logger.e('Error getting remaining today: $e');\n      if (e.toString().contains('requires an index') && mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: const Text(\n              'Database setup in progress. Please try again in a few minutes or contact support.',\n            ),\n            duration: const Duration(seconds: 5),\n            action: SnackBarAction(\n              label: 'Retry',\n              onPressed: () {\n                if (mounted) setState(() {});\n              },\n            ),\n          ),\n        );\n      } else if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error fetching tasks: $e')),\n        );\n      }\n      return 0;\n    }\n  }\n\n  Future<void> _deleteTask(String id, bool isTemplate) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n    final confirm = await showDialog<bool>(\n      context: context,\n      builder: (_) => AlertDialog(\n        title: const Text('Delete Task'),\n        content: const Text('Are you sure you want to delete this task?'),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Cancel'),\n          ),\n          ElevatedButton(\n            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),\n            onPressed: () => Navigator.pop(context, true),\n            child: const Text('Delete'),\n          ),\n        ],\n      ),\n    );\n    if (confirm == true && mounted) {\n      try {\n        final coll = isTemplate ? 'recurring_tasks' : 'to_dos';\n        await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection(coll)\n            .doc(id)\n            .delete();\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context)\n              .showSnackBar(SnackBar(content: Text('Error deleting: $e')));\n        }\n      }\n    }\n  }\n\n  Future<void> _toggleTaskStatus(String id, bool current) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null || !mounted) return;\n    try {\n      await _firestore\n          .collection('user')\n          .doc(uid)\n          .collection('to_dos')\n          .doc(id)\n          .update({'completed': !current});\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context)\n            .showSnackBar(SnackBar(content: Text('Error updating task: $e')));\n      }\n    }\n  }\n\n  Future<List<String>> _getCaretakerPlayerIds() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return [];\n\n    final userDoc = await _firestore.collection('user').doc(uid).get();\n    final connectionId = userDoc.data()?['currentConnectionId'];\n    if (connectionId == null) return [];\n\n    final connectionDoc =\n        await _firestore.collection('connections').doc(connectionId).get();\n    final caretakerUid = connectionDoc.data()?['caretaker_uid'];\n    if (caretakerUid == null) return [];\n\n    final caretakerDoc =\n        await _firestore.collection('caretaker').doc(caretakerUid).get();\n    return List<String>.from(caretakerDoc.data()?['playerIds'] ?? []);\n  }\n\n  Future<List<String>> _getUserPlayerIds() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return [];\n    final userDoc = await _firestore.collection('user').doc(uid).get();\n    return List<String>.from(userDoc.data()?['playerIds'] ?? []);\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: Column(\n        children: [\n          Container(\n            decoration: const BoxDecoration(\n              gradient: LinearGradient(\n                colors: [Colors.blueAccent, Colors.blue],\n                begin: Alignment.topLeft,\n                end: Alignment.bottomRight,\n              ),\n              borderRadius: BorderRadius.vertical(bottom: Radius.circular(20)),\n            ),\n            padding: EdgeInsets.only(\n              top: MediaQuery.of(context).padding.top + 16,\n              bottom: 16,\n              left: 16,\n              right: 16,\n            ),\n            child: Row(\n              mainAxisAlignment: MainAxisAlignment.spaceBetween,\n              children: [\n                const Text(\n                  'Dementia Tasks',\n                  style: TextStyle(\n                    fontSize: 24,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.white,\n                  ),\n                ),\n                IconButton(\n                  icon: const Icon(Icons.notifications, color: Colors.white),\n                  onPressed: () {\n                    if (mounted) {\n                      Navigator.push(\n                        context,\n                        MaterialPageRoute(\n                          builder: (_) => const NotificationsScreen(),\n                        ),\n                      );\n                    }\n                  },\n                ),\n              ],\n            ),\n          ),\n          FutureBuilder<int>(\n            future: _getRemainingToday(),\n            builder: (context, snap) {\n              return Card(\n                margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n                elevation: 4,\n                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n                child: Container(\n                  decoration: BoxDecoration(\n                    gradient: const LinearGradient(\n                      colors: [Colors.greenAccent, Colors.green],\n                      begin: Alignment.topLeft,\n                      end: Alignment.bottomRight,\n                    ),\n                    borderRadius: BorderRadius.circular(16),\n                  ),\n                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n                  child: Row(\n                    mainAxisAlignment: MainAxisAlignment.center,\n                    children: [\n                      Text(\n                        snap.connectionState == ConnectionState.waiting\n                            ? '0'\n                            : (snap.data ?? 0).toString().padLeft(3, '0'),\n                        style: const TextStyle(\n                          fontSize: 36,\n                          fontWeight: FontWeight.bold,\n                          color: Colors.white,\n                        ),\n                      ),\n                      const SizedBox(width: 8),\n                      const Text(\n                        'Remaining Today',\n                        style: TextStyle(\n                          fontSize: 16,\n                          color: Colors.white,\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              );\n            },\n          ),\n          SingleChildScrollView(\n            scrollDirection: Axis.horizontal,\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n            child: Row(\n              children: [\n                _filterChip('Today'),\n                const SizedBox(width: 8),\n                _filterChip('Upcoming'),\n                const SizedBox(width: 8),\n                _filterChip('Completed'),\n                const SizedBox(width: 8),\n                _filterChip('All'),\n                const SizedBox(width: 8),\n                _filterChip('Recurring'),\n              ],\n            ),\n          ),\n          Expanded(\n            child: StreamBuilder<QuerySnapshot<Map<String, dynamic>>>(\n              stream: _getTasksStream(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  return const Center(child: CircularProgressIndicator());\n                }\n\n                if (snapshot.hasError) {\n                  logger.e('Task stream error: ${snapshot.error}');\n                  return Center(\n                    child: Padding(\n                      padding: const EdgeInsets.all(24),\n                      child: Column(\n                        mainAxisAlignment: MainAxisAlignment.center,\n                        children: [\n                          const Icon(Icons.error, size: 64, color: Colors.red),\n                          const SizedBox(height: 16),\n                          Text(\n                            snapshot.error.toString().contains('requires an index')\n                                ? 'Database setup in progress. Please try again in a few minutes or contact support.'\n                                : 'Failed to load tasks: ${snapshot.error}',\n                            textAlign: TextAlign.center,\n                            style: const TextStyle(fontSize: 16),\n                          ),\n                          const SizedBox(height: 16),\n                          ElevatedButton.icon(\n                            icon: const Icon(Icons.refresh),\n                            label: const Text('Retry'),\n                            onPressed: () {\n                              if (mounted) setState(() {});\n                            },\n                          ),\n                        ],\n                      ),\n                    ),\n                  );\n                }\n\n                var docs = snapshot.data?.docs ?? [];\n                if (_selectedTab == 'Completed') {\n                  docs.sort((a, b) {\n                    final aDate = (a.data()['dueDate'] as Timestamp?) ?? Timestamp(0, 0);\n                    final bDate = (b.data()['dueDate'] as Timestamp?) ?? Timestamp(0, 0);\n                    int cmp = bDate.compareTo(aDate);\n                    if (cmp == 0) {\n                      return b.id.compareTo(a.id);\n                    }\n                    return cmp;\n                  });\n                  docs = docs.take(50).toList();\n                }\n\n                if (docs.isEmpty) {\n                  return _emptyState();\n                }\n\n                return RefreshIndicator(\n                  onRefresh: () async {\n                    if (mounted) setState(() {});\n                  },\n                  child: ListView.builder(\n                    padding: const EdgeInsets.all(16),\n                    itemCount: docs.length,\n                    itemBuilder: (context, index) {\n                      final doc = docs[index];\n                      final task = doc.data();\n                      final id = doc.id;\n                      final isTemplate = _selectedTab == 'Recurring';\n                      final completed = isTemplate ? false : (task['completed'] as bool? ?? false);\n                      final description = task['description'] as String? ?? '';\n                      final dueDate = task['dueDate'] as Timestamp?;\n                      final reminderTime = task['reminderTime'] as Timestamp?;\n                      final Map<String, dynamic>? dailyDueTime = isTemplate ? task['dailyDueTime'] as Map<String, dynamic>? : null;\n                      final Map<String, dynamic>? dailyReminderTime = isTemplate ? task['dailyReminderTime'] as Map<String, dynamic>? : null;\n\n                      return Card(\n                        elevation: 4,\n                        margin: const EdgeInsets.only(bottom: 16),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),\n                        color: completed ? Colors.grey[200] : Colors.white,\n                        child: ListTile(\n                          contentPadding: const EdgeInsets.all(16),\n                          leading: isTemplate\n                              ? const Icon(Icons.repeat, color: Colors.blue, size: 32)\n                              : Icon(\n                                  completed\n                                      ? Icons.check_circle\n                                      : Icons.radio_button_unchecked,\n                                  color: completed ? Colors.green : Colors.red,\n                                  size: 32,\n                                ),\n                          title: Text(\n                            task['task'] as String? ?? 'Untitled',\n                            style: TextStyle(\n                              fontSize: 18,\n                              fontWeight: FontWeight.bold,\n                              decoration:\n                                  completed ? TextDecoration.lineThrough : null,\n                            ),\n                          ),\n                          subtitle: Column(\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            children: [\n                              if (description.isNotEmpty)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    description,\n                                    style: const TextStyle(color: Colors.black54),\n                                  ),\n                                ),\n                              if (!isTemplate && dueDate != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Due: ${DateFormat('MMM dd, yyyy hh:mm a').format(dueDate.toDate())}',\n                                    style: const TextStyle(color: Colors.blueGrey),\n                                  ),\n                                ),\n                              if (!isTemplate && reminderTime != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Reminder: ${DateFormat('MMM dd, yyyy hh:mm a').format(reminderTime.toDate())}',\n                                    style: const TextStyle(color: Colors.orange),\n                                  ),\n                                ),\n                              if (isTemplate && dailyDueTime != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Daily Due: ${dailyDueTime['hour'].toString().padLeft(2, '0')}:${dailyDueTime['min'].toString().padLeft(2, '0')}',\n                                    style: const TextStyle(color: Colors.blueGrey),\n                                  ),\n                                ),\n                              if (isTemplate && dailyReminderTime != null)\n                                Padding(\n                                  padding: const EdgeInsets.only(top: 4),\n                                  child: Text(\n                                    'Daily Reminder: ${dailyReminderTime['hour'].toString().padLeft(2, '0')}:${dailyReminderTime['min'].toString().padLeft(2, '0')}',\n                                    style: const TextStyle(color: Colors.orange),\n                                  ),\n                                ),\n                            ],\n                          ),\n                          trailing: Row(\n                            mainAxisSize: MainAxisSize.min,\n                            children: [\n                              IconButton(\n                                icon: const Icon(Icons.edit, color: Colors.blue),\n                                onPressed: () async {\n                                  if (!mounted) return;\n                                  final Map<String, dynamic>? updated = await Navigator.push<Map<String, dynamic>>(\n                                    context,\n                                    MaterialPageRoute(\n                                      builder: (_) => EditTaskPage(\n                                        taskName: task['task'] as String? ?? '',\n                                        description: description,\n                                        dueDate: dueDate?.toDate(),\n                                        reminderTime: reminderTime?.toDate(),\n                                        isTemplate: isTemplate,\n                                        dailyDueTime: dailyDueTime,\n                                        dailyReminderTime: dailyReminderTime,\n                                      ),\n                                    ),\n                                  );\n                                  if (updated != null && mounted) {\n                                    final uid = _auth.currentUser?.uid;\n                                    if (uid != null) {\n                                      try {\n                                        final coll = isTemplate ? 'recurring_tasks' : 'to_dos';\n                                        await _firestore\n                                            .collection('user')\n                                            .doc(uid)\n                                            .collection(coll)\n                                            .doc(id)\n                                            .update({\n                                              'task': updated['task'],\n                                              'description': updated['description'],\n                                              if (isTemplate)\n                                                'dailyDueTime': updated['dailyDueTime'],\n                                              if (isTemplate)\n                                                'dailyReminderTime': updated['dailyReminderTime'],\n                                              if (!isTemplate)\n                                                'dueDate': updated['dueDate'] != null\n                                                    ? Timestamp.fromDate(updated['dueDate'] as DateTime)\n                                                    : null,\n                                              if (!isTemplate)\n                                                'reminderTime': updated['reminderTime'] != null\n                                                    ? Timestamp.fromDate(updated['reminderTime'] as DateTime)\n                                                    : null,\n                                            });\n\n                                        if (!isTemplate && updated['reminderTime'] != null) {\n                                          final userPlayerIds = await _getUserPlayerIds();\n                                          final caretakerPlayerIds = await _getCaretakerPlayerIds();\n                                          final allPlayerIds = [...userPlayerIds, ...caretakerPlayerIds];\n\n                                          await scheduleNotification(\n                                            allPlayerIds,\n                                            'Task Reminder: ${updated['task']}',\n                                            updated['reminderTime'] as DateTime,\n                                          );\n                                        }\n                                      } catch (e) {\n                                        if (mounted) {\n                                          ScaffoldMessenger.of(context).showSnackBar(\n                                            SnackBar(content: Text('Error updating: $e')),\n                                          );\n                                        }\n                                      }\n                                    }\n                                  }\n                                },\n                              ),\n                              IconButton(\n                                icon: const Icon(Icons.delete, color: Colors.red),\n                                onPressed: () => _deleteTask(id, isTemplate),\n                              ),\n                            ],\n                          ),\n                          onTap: isTemplate ? null : () => _toggleTaskStatus(id, completed),\n                        ),\n                      );\n                    },\n                  ),\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n      floatingActionButton: Column(\n        mainAxisAlignment: MainAxisAlignment.end,\n        children: [\n          FloatingActionButton(\n            onPressed: () {\n              Navigator.push(\n                context,\n                MaterialPageRoute(builder: (context) => const AIChatPage()),\n              );\n            },\n            backgroundColor: Colors.blue, // Blue background\n            heroTag: 'ai_chat',\n            child: ClipOval(\n              child: Image.asset(\n                'assets/aiIcon.png',\n                width: 50,\n                height: 50,\n                fit: BoxFit.cover,\n              ),\n            ),\n          ),\n          const SizedBox(height: 16),\n          FloatingActionButton.extended(\n            onPressed: () async {\n              if (!mounted) return;\n              final newTask = await Navigator.push(\n                context,\n                MaterialPageRoute(builder: (_) => AddTaskPage(isTemplate: _selectedTab == 'Recurring')),\n              );\n              if (newTask != null && mounted) {\n                final uid = _auth.currentUser?.uid;\n                if (uid != null) {\n                  try {\n                    final isTemplate = newTask['recurring'] == 'Daily';\n                    final coll = isTemplate ? 'recurring_tasks' : 'to_dos';\n                    await _firestore.collection('user').doc(uid).collection(coll).add({\n                      'task': newTask['task'],\n                      'description': newTask['description'],\n                      if (!isTemplate) 'completed': false,\n                      'createdAt': Timestamp.now(),\n                      if (!isTemplate)\n                        'dueDate': newTask['dueDate'] != null\n                            ? Timestamp.fromDate(newTask['dueDate'] as DateTime)\n                            : null,\n                      if (!isTemplate)\n                        'reminderTime': newTask['reminderTime'] != null\n                            ? Timestamp.fromDate(newTask['reminderTime'] as DateTime)\n                            : null,\n                      if (isTemplate) 'dailyDueTime': newTask['dailyDueTime'],\n                      if (isTemplate) 'dailyReminderTime': newTask['dailyReminderTime'],\n                      'createdBy': 'user',\n                    });\n\n                    if (!isTemplate && newTask['reminderTime'] != null) {\n                      final userPlayerIds = await _getUserPlayerIds();\n                      final caretakerPlayerIds = await _getCaretakerPlayerIds();\n                      final allPlayerIds = [...userPlayerIds, ...caretakerPlayerIds];\n\n                      await scheduleNotification(\n                        allPlayerIds,\n                        'New Task Reminder: ${newTask['task']}',\n                        newTask['reminderTime'] as DateTime,\n                      );\n                    }\n\n                    if (isTemplate) {\n                      await _generateDailyTasks();\n                    }\n                  } catch (e) {\n                    if (mounted) {\n                      ScaffoldMessenger.of(context).showSnackBar(\n                        SnackBar(content: Text('Error adding: $e')),\n                      );\n                    }\n                  }\n                }\n              }\n            },\n            backgroundColor: Colors.orange,\n            icon: const Icon(Icons.add, color: Colors.white),\n            label: const Text('Add', style: TextStyle(color: Colors.white)),\n            heroTag: 'add_task',\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _filterChip(String label) {\n    return ChoiceChip(\n      label: Text(label, style: const TextStyle(fontSize: 14)),\n      selected: _selectedTab == label,\n      onSelected: (selected) {\n        if (selected && mounted) {\n          setState(() => _selectedTab = label);\n        }\n      },\n      selectedColor: Colors.blueAccent,\n      backgroundColor: Colors.grey[300],\n      labelStyle: TextStyle(\n          color: _selectedTab == label ? Colors.white : Colors.black),\n    );\n  }\n\n  Widget _emptyState() {\n    return const Center(\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          Icon(Icons.inbox, size: 64, color: Colors.grey),\n          SizedBox(height: 16),\n          Text(\n            'No items yet. Add one!',\n            style: TextStyle(fontSize: 18, color: Colors.grey),\n          ),\n        ],\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "notifications": {
        "notifications_screen.dart": {
          "_text": "// lib/user/notifications/notifications_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport 'package:url_launcher/url_launcher.dart';\n\nclass NotificationsScreen extends StatefulWidget {\n  const NotificationsScreen({super.key});\n\n  @override\n  State<NotificationsScreen> createState() => _NotificationsScreenState();\n}\n\nclass _NotificationsScreenState extends State<NotificationsScreen> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n\n  Stream<QuerySnapshot> _getNotifications() {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return Stream.empty();\n    return _firestore.collection('user').doc(uid).collection('notifications').orderBy('createdAt', descending: true).snapshots();\n  }\n\n  Future<void> _markRead(String id) async {\n    final uid = _auth.currentUser?.uid;\n    if (uid != null) {\n      await _firestore.collection('user').doc(uid).collection('notifications').doc(id).update({'isRead': true});\n    }\n  }\n\n  Future<String> _fetchCaretakerName(String caretakerUid) async {\n    try {\n      final doc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n      return doc.data()?['fullName'] as String? ?? 'Caretaker Not Found';\n    } catch (e) {\n      return 'Error fetching name';\n    }\n  }\n\n  Future<void> _handleCall(String caretakerUid) async {\n    try {\n      final caretakerDoc = await _firestore.collection('caretaker').doc(caretakerUid).get();\n      final phone = caretakerDoc.data()?['phoneNo'] as String?;\n\n      if (phone != null && phone.isNotEmpty) {\n        final url = Uri.parse('tel:$phone');\n        if (await canLaunchUrl(url)) {\n          await launchUrl(url);\n        } else {\n          if (mounted) {\n            ScaffoldMessenger.of(context).showSnackBar(\n              const SnackBar(content: Text('Could not launch phone app.')),\n            );\n          }\n        }\n      } else {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('Caretaker phone number not available.')),\n          );\n        }\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error getting phone number: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleUnbindAccept(String notificationId, String caretakerUid, String connectionId) async {\n    final userUid = _auth.currentUser?.uid;\n    if (userUid == null) return;\n\n    try {\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'unbound',\n      });\n\n      // Update both profiles\n      await _firestore.collection('user').doc(userUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      await _firestore.collection('caretaker').doc(caretakerUid).update({\n        'isConnected': false,\n        'currentConnectionId': null,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('user')\n          .doc(userUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Connection unbound successfully')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to unbind connection: $e')),\n        );\n      }\n    }\n  }\n\n  Future<void> _handleUnbindDecline(String notificationId, String connectionId) async {\n    final userUid = _auth.currentUser?.uid;\n    if (userUid == null) return;\n\n    try {\n      // Revert unbind request\n      await _firestore.collection('connections').doc(connectionId).update({\n        'status': 'accepted',\n        'requestedBy': null,\n      });\n\n      // Delete the notification\n      await _firestore\n          .collection('user')\n          .doc(userUid)\n          .collection('notifications')\n          .doc(notificationId)\n          .delete();\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Unbind request declined')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Failed to decline unbind: $e')),\n        );\n      }\n    }\n  }\n\n  Widget _buildNotificationCard(DocumentSnapshot doc) {\n    final data = doc.data() as Map<String, dynamic>;\n    final type = data['type'] as String? ?? 'general';\n    final isRead = data['isRead'] as bool? ?? false;\n    final senderUid = data['from'] as String?;\n    final notificationMessage = data['message'] as String? ?? 'No message.';\n    final connectionId = data['connectionId'] as String?;\n\n    TextStyle textStyle = const TextStyle(fontWeight: FontWeight.normal);\n    Color cardColor = Colors.white;\n    IconData icon = Icons.info;\n\n    if (type == 'unbind_request') {\n      textStyle = const TextStyle(\n        fontWeight: FontWeight.bold,\n        color: Colors.orange,\n      );\n      cardColor = Colors.orange.shade50;\n      icon = Icons.link_off;\n    } else if (!isRead) {\n      cardColor = Colors.yellow.shade100;\n    }\n\n    return Card(\n      elevation: 3,\n      margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      color: cardColor,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n      child: Padding(\n        padding: const EdgeInsets.all(12.0),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            ListTile(\n              leading: Icon(icon, color: Colors.blueAccent),\n              title: (type == 'unbind_request' && senderUid != null)\n                  ? FutureBuilder<String>(\n                      future: _fetchCaretakerName(senderUid),\n                      builder: (context, snapshot) {\n                        String caretakerName = snapshot.data ?? 'Loading Caretaker...';\n                        String displayMessage = 'Unbind request from $caretakerName.';\n                        return Text(displayMessage, style: textStyle);\n                      },\n                    )\n                  : Text(notificationMessage, style: textStyle),\n              subtitle: Text(\n                'Received: ${DateFormat('MMM dd, hh:mm a').format((data['createdAt'] as Timestamp).toDate())}',\n                style: const TextStyle(fontSize: 12, color: Colors.grey),\n              ),\n              contentPadding: EdgeInsets.zero,\n              onTap: () => _markRead(doc.id),\n            ),\n\n            if (type == 'unbind_request' && senderUid != null && connectionId != null)\n              Padding(\n                padding: const EdgeInsets.only(top: 8.0),\n                child: Row(\n                  mainAxisAlignment: MainAxisAlignment.end,\n                  children: [\n                    Expanded(\n                      flex: 1,\n                      child: OutlinedButton.icon(\n                        icon: const Icon(Icons.phone, size: 18, color: Colors.green),\n                        label: const Text('Call', style: TextStyle(fontSize: 13, color: Colors.green)),\n                        onPressed: () => _handleCall(senderUid),\n                        style: OutlinedButton.styleFrom(\n                          padding: const EdgeInsets.symmetric(horizontal: 0),\n                          side: const BorderSide(color: Colors.green),\n                        ),\n                      ),\n                    ),\n                    const SizedBox(width: 8),\n                    Expanded(\n                      flex: 2,\n                      child: ElevatedButton.icon(\n                        icon: const Icon(Icons.check, size: 18, color: Colors.white),\n                        label: const Text('Accept', style: TextStyle(fontSize: 13, color: Colors.white)),\n                        onPressed: () => _handleUnbindAccept(doc.id, senderUid, connectionId),\n                        style: ElevatedButton.styleFrom(\n                          backgroundColor: Colors.orange,\n                          padding: const EdgeInsets.symmetric(horizontal: 0),\n                        ),\n                      ),\n                    ),\n                    const SizedBox(width: 8),\n                    Expanded(\n                      flex: 2,\n                      child: ElevatedButton.icon(\n                        icon: const Icon(Icons.close, size: 18, color: Colors.white),\n                        label: const Text('Decline', style: TextStyle(fontSize: 13, color: Colors.white)),\n                        onPressed: () => _handleUnbindDecline(doc.id, connectionId),\n                        style: ElevatedButton.styleFrom(\n                          backgroundColor: Colors.red,\n                          padding: const EdgeInsets.symmetric(horizontal: 0),\n                        ),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Notifications'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: StreamBuilder<QuerySnapshot>(\n          stream: _getNotifications(),\n          builder: (context, snapshot) {\n            if (snapshot.hasError) {\n              return Center(\n                child: Text('Error: ${snapshot.error}', style: const TextStyle(color: Colors.red)),\n              );\n            }\n            if (!snapshot.hasData) {\n              return const Center(child: CircularProgressIndicator(color: Colors.blueAccent));\n            }\n            final notifs = snapshot.data!.docs;\n            if (notifs.isEmpty) {\n              return const Center(\n                child: Column(\n                  mainAxisAlignment: MainAxisAlignment.center,\n                  children: [\n                    Icon(Icons.notifications_off, size: 64, color: Colors.grey),\n                    SizedBox(height: 16),\n                    Text(\n                      'No notifications yet',\n                      style: TextStyle(fontSize: 18, color: Colors.grey),\n                    ),\n                  ],\n                ),\n              );\n            }\n            return ListView.builder(\n              padding: const EdgeInsets.all(16.0),\n              itemCount: notifs.length,\n              itemBuilder: (context, index) {\n                return _buildNotificationCard(notifs[index]);\n              },\n            );\n          },\n        ),\n      ),\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "profile": {
        "edit_profile_screen.dart": {
          "_text": "// lib/user/profile/edit_profile_screen.dart\nimport 'dart:io';\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:cloudinary_public/cloudinary_public.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:intl/intl.dart';\nimport 'package:permission_handler/permission_handler.dart';\n\nclass EditProfileScreen extends StatefulWidget {\n  final Map<String, dynamic> userData;\n  const EditProfileScreen({super.key, required this.userData});\n\n  @override\n  State<EditProfileScreen> createState() => _EditProfileScreenState();\n}\n\nclass _EditProfileScreenState extends State<EditProfileScreen> {\n  late TextEditingController _fullNameController;\n  late TextEditingController _usernameController;\n  late TextEditingController _bioController;\n  late TextEditingController _phoneController;\n  late TextEditingController _localityController;\n  late TextEditingController _cityController;\n  late TextEditingController _stateController;\n  DateTime? _dob;\n  String? _gender;\n  String _profileImageUrl = '';\n  File? _newProfileImage;\n  final _picker = ImagePicker();\n  final cloudinary = CloudinaryPublic('dts8hgf4f', 'user_image');\n  bool _isSaving = false;\n  List<Map<String, dynamic>> _emergencyContacts = [];\n\n  @override\n  void initState() {\n    super.initState();\n    _fullNameController = TextEditingController(text: widget.userData['fullName']);\n    _usernameController = TextEditingController(text: widget.userData['username']);\n    _bioController = TextEditingController(text: widget.userData['bio']);\n    _phoneController = TextEditingController(text: widget.userData['phoneNo']);\n    _localityController = TextEditingController(text: widget.userData['locality']);\n    _cityController = TextEditingController(text: widget.userData['city']);\n    _stateController = TextEditingController(text: widget.userData['state']);\n    _dob = widget.userData['dob']?.toDate();\n    \n    // Handle gender case conversion\n    final genderFromData = widget.userData['gender'];\n    if (genderFromData is String) {\n      _gender = genderFromData.toLowerCase();\n    } else {\n      _gender = 'male'; // default\n    }\n    \n    _profileImageUrl = widget.userData['profileImageUrl'] ?? '';\n    _emergencyContacts = List<Map<String, dynamic>>.from(widget.userData['emergencyContacts'] ?? []);\n  }\n\n  Future<void> _pickImage() async {\n    if (await Permission.photos.request().isGranted) {\n      final picked = await _picker.pickImage(source: ImageSource.gallery);\n      if (picked != null && mounted) {\n        setState(() => _newProfileImage = File(picked.path));\n      }\n    }\n  }\n\n  Future<String?> _uploadImage() async {\n    if (_newProfileImage == null) return _profileImageUrl;\n    try {\n      final response = await cloudinary.uploadFile(CloudinaryFile.fromFile(_newProfileImage!.path));\n      return response.secureUrl;\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Upload failed: $e')));\n      }\n      return _profileImageUrl;\n    }\n  }\n\n  Future<void> _saveChanges() async {\n    if (_isSaving || !mounted) return;\n    setState(() => _isSaving = true);\n    final url = await _uploadImage();\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid != null && mounted) {\n      try {\n        await FirebaseFirestore.instance.collection('user').doc(uid).update({\n          'fullName': _fullNameController.text.trim(),\n          'username': _usernameController.text.trim(),\n          'bio': _bioController.text.trim(),\n          'phoneNo': _phoneController.text.trim(),\n          'profileImageUrl': url,\n          'locality': _localityController.text.trim(),\n          'city': _cityController.text.trim(),\n          'state': _stateController.text.trim(),\n          'dob': _dob != null ? Timestamp.fromDate(_dob!) : null,\n          'gender': _gender?.toLowerCase(), // Ensure lowercase when saving\n          'emergencyContacts': _emergencyContacts,\n        });\n        if (mounted) Navigator.pop(context, true);\n      } catch (e) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Save failed: $e')));\n        }\n      }\n    }\n    if (mounted) setState(() => _isSaving = false);\n  }\n\n  Future<void> _pickDob() async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: _dob ?? DateTime(2000),\n      firstDate: DateTime(1900),\n      lastDate: DateTime.now(),\n      builder: (context, child) {\n        return Theme(\n          data: ThemeData.light().copyWith(\n            colorScheme: const ColorScheme.light(\n              primary: Colors.blueAccent,\n              onPrimary: Colors.white,\n              onSurface: Colors.black,\n            ),\n          ),\n          child: child!,\n        );\n      },\n    );\n    if (picked != null && picked != _dob) {\n      setState(() {\n        _dob = picked;\n      });\n    }\n  }\n\n  void _addEmergencyContact() {\n    _showContactDialog();\n  }\n\n  void _editEmergencyContact(int index) {\n    _showContactDialog(index: index);\n  }\n\n  void _deleteEmergencyContact(int index) {\n    setState(() {\n      _emergencyContacts.removeAt(index);\n    });\n  }\n\n  void _showContactDialog({int? index}) {\n    final isEdit = index != null;\n    final nameController = TextEditingController(text: isEdit ? _emergencyContacts[index]['name'] : '');\n    final relationController = TextEditingController(text: isEdit ? _emergencyContacts[index]['relation'] : '');\n    final phoneController = TextEditingController(text: isEdit ? _emergencyContacts[index]['number'] : '');\n\n    showDialog(\n      context: context,\n      builder: (context) {\n        return AlertDialog(\n          title: Text(isEdit ? 'Edit Contact' : 'Add Contact'),\n          content: SingleChildScrollView(\n            child: Column(\n              mainAxisSize: MainAxisSize.min,\n              children: [\n                TextField(controller: nameController, decoration: const InputDecoration(labelText: 'Name')),\n                TextField(controller: relationController, decoration: const InputDecoration(labelText: 'Relation')),\n                TextField(controller: phoneController, decoration: const InputDecoration(labelText: 'Phone')),\n              ],\n            ),\n          ),\n          actions: [\n            TextButton(\n              onPressed: () => Navigator.pop(context),\n              child: const Text('Cancel'),\n            ),\n            ElevatedButton(\n              onPressed: () {\n                final name = nameController.text.trim();\n                final relation = relationController.text.trim();\n                final phone = phoneController.text.trim();\n                if (name.isNotEmpty && relation.isNotEmpty && phone.isNotEmpty) {\n                  final contact = {'name': name, 'relation': relation, 'number': phone};\n                  setState(() {\n                    if (isEdit) {\n                      _emergencyContacts[index] = contact;\n                    } else {\n                      _emergencyContacts.add(contact);\n                    }\n                  });\n                  Navigator.pop(context);\n                }\n              },\n              child: Text(isEdit ? 'Update' : 'Add'),\n            ),\n          ],\n        );\n      },\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Edit Profile'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView(\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\n                'Profile Picture',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 8),\n              Center(\n                child: GestureDetector(\n                  onTap: _pickImage,\n                  child: Stack(\n                    children: [\n                      CircleAvatar(\n                        radius: 60,\n                        backgroundImage: _newProfileImage != null\n                            ? FileImage(_newProfileImage!)\n                            : (_profileImageUrl.isNotEmpty ? NetworkImage(_profileImageUrl) : null),\n                        child: (_newProfileImage == null && _profileImageUrl.isEmpty)\n                            ? const Icon(Icons.person, size: 60, color: Colors.blueAccent)\n                            : null,\n                      ),\n                      Positioned(\n                        bottom: 0,\n                        right: 0,\n                        child: CircleAvatar(\n                          backgroundColor: Colors.blueAccent,\n                          radius: 20,\n                          child: const Icon(Icons.camera_alt, color: Colors.white, size: 20),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ),\n              const SizedBox(height: 24),\n              const Text(\n                'Personal Details',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 8),\n              _buildTextField(_fullNameController, 'Full Name', Icons.person),\n              _buildTextField(_usernameController, 'Username', Icons.alternate_email),\n              _buildTextField(_bioController, 'Bio', Icons.info, maxLines: 3),\n              _buildTextField(_phoneController, 'Phone Number', Icons.phone, keyboardType: TextInputType.phone),\n              Card(\n                elevation: 2,\n                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                child: ListTile(\n                  title: Text(_dob == null ? 'Select DOB' : DateFormat('yyyy-MM-dd').format(_dob!)),\n                  trailing: const Icon(Icons.calendar_today, color: Colors.blueAccent),\n                  onTap: _pickDob,\n                ),\n              ),\n              const SizedBox(height: 8),\n              DropdownButtonFormField<String>(\n                value: _gender, // Now this will match exactly with lowercase values\n                hint: const Text('Select Gender'),\n                decoration: InputDecoration(\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                ),\n                items: [\n                  DropdownMenuItem(value: 'male', child: const Text('Male')),\n                  DropdownMenuItem(value: 'female', child: const Text('Female')),\n                  DropdownMenuItem(value: 'other', child: const Text('Other')),\n                ],\n                onChanged: (value) => setState(() => _gender = value),\n              ),\n              const SizedBox(height: 24),\n              const Text(\n                'Location',\n                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n              ),\n              const SizedBox(height: 8),\n              _buildTextField(_localityController, 'Locality', Icons.location_on),\n              _buildTextField(_cityController, 'City', Icons.location_city),\n              _buildTextField(_stateController, 'State', Icons.map),\n              const SizedBox(height: 24),\n              Row(\n                mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                children: [\n                  const Text(\n                    'Emergency Contacts',\n                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600, color: Colors.blueAccent),\n                  ),\n                  IconButton(\n                    icon: const Icon(Icons.add_circle, color: Colors.blueAccent),\n                    onPressed: _addEmergencyContact,\n                  ),\n                ],\n              ),\n              const SizedBox(height: 8),\n              if (_emergencyContacts.isEmpty)\n                Card(\n                  elevation: 2,\n                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                  child: const Padding(\n                    padding: EdgeInsets.all(16.0),\n                    child: Center(\n                      child: Text(\n                        'No emergency contacts added',\n                        style: TextStyle(color: Colors.grey),\n                      ),\n                    ),\n                  ),\n                )\n              else\n                Column(\n                  children: _emergencyContacts.asMap().entries.map((entry) {\n                    int idx = entry.key;\n                    Map<String, dynamic> contact = entry.value;\n                    return Card(\n                      elevation: 2,\n                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                      child: ListTile(\n                        leading: const Icon(Icons.emergency, color: Colors.red),\n                        title: Text(contact['name'] ?? ''),\n                        subtitle: Text(\n                          'Relation: ${contact['relation'] ?? ''}\\\\nPhone: ${contact['number'] ?? ''}',\n                        ),\n                        trailing: Row(\n                          mainAxisSize: MainAxisSize.min,\n                          children: [\n                            IconButton(\n                              icon: const Icon(Icons.edit, color: Colors.blue),\n                              onPressed: () => _editEmergencyContact(idx),\n                            ),\n                            IconButton(\n                              icon: const Icon(Icons.delete, color: Colors.red),\n                              onPressed: () => _deleteEmergencyContact(idx),\n                            ),\n                          ],\n                        ),\n                      ),\n                    );\n                  }).toList(),\n                ),\n              const SizedBox(height: 32),\n              _isSaving\n                  ? const Center(child: CircularProgressIndicator(color: Colors.blueAccent))\n                  : ElevatedButton(\n                      onPressed: _saveChanges,\n                      style: ElevatedButton.styleFrom(\n                        backgroundColor: Colors.blueAccent,\n                        padding: const EdgeInsets.symmetric(vertical: 16),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                        minimumSize: const Size(double.infinity, 50),\n                      ),\n                      child: const Text('Save Changes', style: TextStyle(fontSize: 18, color: Colors.white)),\n                    ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildTextField(TextEditingController controller, String label, IconData icon, {int maxLines = 1, TextInputType? keyboardType}) {\n    return Padding(\n      padding: const EdgeInsets.only(bottom: 16),\n      child: TextField(\n        controller: controller,\n        decoration: InputDecoration(\n          labelText: label,\n          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n          filled: true,\n          fillColor: Colors.white,\n          prefixIcon: Icon(icon, color: Colors.blueAccent),\n        ),\n        maxLines: maxLines,\n        keyboardType: keyboardType,\n      ),\n    );\n  }\n\n  @override\n  void dispose() {\n    _fullNameController.dispose();\n    _usernameController.dispose();\n    _bioController.dispose();\n    _phoneController.dispose();\n    _localityController.dispose();\n    _cityController.dispose();\n    _stateController.dispose();\n    super.dispose();\n  }\n}",
          "_encoding": "utf-8"
        },
        "settings_screen.dart": {
          "_text": "// lib/user/profile/settings_screen.dart\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport '../../report_page.dart';\nimport '../../welcome_page.dart';\n\nclass SettingsScreen extends StatelessWidget {\n  const SettingsScreen({super.key});\n\n  Future<void> _logout(BuildContext context) async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid != null) {\n      final playerId = OneSignal.User.pushSubscription.id;\n      if (playerId != null) {\n        await FirebaseFirestore.instance.collection('user').doc(uid).update({\n          'playerIds': FieldValue.arrayRemove([playerId]),\n        });\n      }\n    }\n    await FirebaseAuth.instance.signOut();\n    final prefs = await SharedPreferences.getInstance();\n    await prefs.remove('lastRole'); // Clear role on logout\n    Navigator.pushReplacement(\n      context,\n      MaterialPageRoute(builder: (context) => const WelcomePage()),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Settings'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withOpacity(0.1), Colors.white],\n          ),\n        ),\n        child: ListView(\n          padding: const EdgeInsets.all(16.0),\n          children: [\n            const Text(\n              'Account',\n              style: TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.w600,\n                color: Colors.blueAccent,\n              ),\n            ),\n            const SizedBox(height: 8),\n            Card(\n              elevation: 2,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(12),\n              ),\n              child: ListTile(\n                leading: const Icon(Icons.logout, color: Colors.red),\n                title: const Text('Logout'),\n                onTap: () => _logout(context),\n              ),\n            ),\n            const SizedBox(height: 24),\n\n            const Text(\n              'Preferences',\n              style: TextStyle(\n                fontSize: 18,\n                fontWeight: FontWeight.w600,\n                color: Colors.blueAccent,\n              ),\n            ),\n            const SizedBox(height: 8),\n\n            /// 🔹 Added Report Option\n            Card(\n              elevation: 2,\n              shape: RoundedRectangleBorder(\n                borderRadius: BorderRadius.circular(12),\n              ),\n              child: ListTile(\n                leading: const Icon(Icons.report, color: Colors.orange),\n                title: const Text('Report'),\n                onTap: () => Navigator.push(\n                  context,\n                  MaterialPageRoute(\n                    builder: (context) =>\n                        const ReportPage(reporterRole: 'user'),\n                  ),\n                ),\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\n",
          "_encoding": "utf-8"
        },
        "user_profile.dart": {
          "_text": "// lib/user/profile/user_profile.dart\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:intl/intl.dart';\nimport 'package:url_launcher/url_launcher.dart';\nimport 'edit_profile_screen.dart';\nimport 'settings_screen.dart';\n\nclass UserProfile extends StatefulWidget {\n  const UserProfile({super.key});\n\n  @override\n  State<UserProfile> createState() => _UserProfileState();\n}\n\nclass _UserProfileState extends State<UserProfile> {\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  Map<String, dynamic>? _userData;\n  bool _isLoading = true;\n  bool _hasError = false;\n  int _remainingTasks = 0;\n  int _completedTasks = 0;\n  int _totalTasks = 0;\n  List<QueryDocumentSnapshot> _albums = [];\n\n  @override\n  void initState() {\n    super.initState();\n    _loadUserData();\n  }\n\n  Future<void> _loadUserData() async {\n    if (!mounted) return;\n    setState(() {\n      _isLoading = true;\n      _hasError = false;\n    });\n\n    try {\n      final uid = _auth.currentUser?.uid;\n      if (uid != null) {\n        // Load user data\n        final doc = await _firestore.collection('user').doc(uid).get();\n        if (doc.exists && mounted) {\n          setState(() {\n            _userData = doc.data();\n          });\n        } else {\n          throw Exception('User document not found');\n        }\n\n        // Load albums\n        final albumSnap = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('album')\n            .orderBy('createdAt', descending: true)\n            .get();\n        if (mounted) {\n          setState(() {\n            _albums = albumSnap.docs;\n          });\n        }\n\n        // Load today's tasks counts\n        final today = DateTime.now();\n        final todayStart = Timestamp.fromDate(\n          DateTime(today.year, today.month, today.day),\n        );\n        final todayEnd = Timestamp.fromDate(\n          DateTime(today.year, today.month, today.day, 23, 59, 59),\n        );\n\n        final tasksSnap = await _firestore\n            .collection('user')\n            .doc(uid)\n            .collection('to_dos')\n            .where('dueDate', isGreaterThanOrEqualTo: todayStart)\n            .where('dueDate', isLessThanOrEqualTo: todayEnd)\n            .get();\n\n        if (mounted) {\n          final incomplete = tasksSnap.docs\n              .where((doc) => doc.data()['completed'] == false)\n              .length;\n          final total = tasksSnap.docs.length;\n          final completed = total - incomplete;\n\n          setState(() {\n            _remainingTasks = incomplete;\n            _completedTasks = completed;\n            _totalTasks = total;\n            _isLoading = false;\n          });\n        }\n      } else {\n        throw Exception('No user logged in');\n      }\n    } catch (e) {\n      if (mounted) {\n        setState(() {\n          _isLoading = false;\n          _hasError = true;\n        });\n      }\n    }\n  }\n\n  Future<void> _callNumber(String number) async {\n    final uri = Uri(scheme: 'tel', path: number);\n    if (await canLaunchUrl(uri)) {\n      await launchUrl(uri);\n    } else if (!mounted) return;\n    ScaffoldMessenger.of(context).showSnackBar(\n      SnackBar(content: Text('Could not launch dialer for $number')),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.white,\n      appBar: AppBar(\n        title: Text(\n          _userData?['username'] ?? \"Profile\",\n          style: const TextStyle(\n            color: Colors.white,\n            fontWeight: FontWeight.bold,\n            fontSize: 20,\n          ),\n        ),\n        backgroundColor: Colors.blue, // ✅ Changed from white to blue\n        elevation: 0,\n        iconTheme: const IconThemeData(color: Colors.white), // ✅ Makes back icon white\n      ),\n\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : _hasError || _userData == null\n              ? const Center(\n                  child: Text(\n                    \"Error loading profile\",\n                    style: TextStyle(color: Colors.red),\n                  ),\n                )\n              : RefreshIndicator(\n                  onRefresh: _loadUserData,\n                  child: DefaultTabController(\n                    length: 2,\n                    child: SingleChildScrollView(\n                      physics: const AlwaysScrollableScrollPhysics(),\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          const SizedBox(height: 16),\n\n                          /// Header with avatar + stats\n                          Row(\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            children: [\n                              const SizedBox(width: 16),\n                              CircleAvatar(\n                                radius: 45,\n                                backgroundColor: Colors.grey[300],\n                                backgroundImage: (_userData!['profileImageUrl'] !=\n                                            null &&\n                                        _userData!['profileImageUrl']\n                                            .toString()\n                                            .isNotEmpty)\n                                    ? NetworkImage(\n                                        _userData!['profileImageUrl'])\n                                    : null,\n                                child: (_userData!['profileImageUrl'] == null ||\n                                        _userData!['profileImageUrl']\n                                            .toString()\n                                            .isEmpty)\n                                    ? const Icon(Icons.person,\n                                        size: 50, color: Colors.grey)\n                                    : null,\n                              ),\n                              const SizedBox(width: 24),\n                              Expanded(\n                                child: Row(\n                                  mainAxisAlignment:\n                                      MainAxisAlignment.spaceEvenly,\n                                  children: [\n                                    _buildStat(\"Remaining\", _remainingTasks.toString()),\n                                    _buildStat(\"Completed\", _completedTasks.toString()),\n                                    _buildStat(\"Total\", _totalTasks.toString()),\n                                  ],\n                                ),\n                              ),\n                              const SizedBox(width: 16),\n                            ],\n                          ),\n\n                          const SizedBox(height: 12),\n\n                          Padding(\n                            padding:\n                                const EdgeInsets.symmetric(horizontal: 16.0),\n                            child: Column(\n                              crossAxisAlignment: CrossAxisAlignment.start,\n                              children: [\n                                Text(\n                                  _userData!['fullName'] ?? \"No Name\",\n                                  style: const TextStyle(\n                                      fontWeight: FontWeight.bold, fontSize: 18),\n                                ),\n                                const SizedBox(height: 4),\n                                Text(\n                                  _userData!['bio'] ?? \"No bio yet\",\n                                  style: const TextStyle(fontSize: 14),\n                                ),\n                                const SizedBox(height: 6),\n                                if (_userData!['email'] != null)\n                                  Text(\n                                    _userData!['email'],\n                                    style: const TextStyle(\n                                        fontSize: 14, color: Colors.blueGrey),\n                                  ),\n                                if (_userData!['phoneNo'] != null)\n                                  Text(\n                                    _userData!['phoneNo'],\n                                    style: const TextStyle(\n                                        fontSize: 14, color: Colors.blueGrey),\n                                  ),\n                              ],\n                            ),\n                          ),\n\n\n                          Padding(\n                            padding: const EdgeInsets.symmetric(horizontal: 16.0),\n                            child: Column(\n                              crossAxisAlignment: CrossAxisAlignment.start,\n                              children: [\n                                if (_userData!['dob'] != null || _userData!['gender'] != null)\n                                  Padding(\n                                    padding: const EdgeInsets.symmetric(vertical: 1.0),\n                                    child: Row(\n                                      children: [\n                                        if (_userData!['dob'] != null)\n                                          Expanded(\n                                            child: _buildInfoRow(\n                                              \"Birthday\",\n                                              DateFormat('yyyy-MM-dd')\n                                                  .format(_userData!['dob'].toDate()),\n                                            ),\n                                          ),\n                                        if (_userData!['gender'] != null)\n                                          Expanded(\n                                            child: _buildInfoRow(\"Gender\", _userData!['gender']),\n                                          ),\n                                      ],\n                                    ),\n                                  ),\n                                if (_userData!['locality'] != null ||\n                                    _userData!['city'] != null ||\n                                    _userData!['state'] != null)\n                                  Padding(\n                                    padding: const EdgeInsets.symmetric(vertical: 1.0), \n                                    child: _buildInfoRow(\n                                      \"Location\",\n                                      [\n                                        _userData!['locality'],\n                                        _userData!['city'],\n                                        _userData!['state']\n                                      ]\n                                          .where((e) => e != null && e.toString().isNotEmpty)\n                                          .join(\", \"),\n                                    ),\n                                  ),\n                              ],\n                            ),\n                          ),\n\n\n                          const SizedBox(height: 20),\n\n                          /// Buttons\n                          Row(\n                            mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                            children: [\n                              Expanded(\n                                child: Padding(\n                                  padding: const EdgeInsets.symmetric(horizontal: 8),\n                                  child: ElevatedButton(\n                                    onPressed: () async {\n                                      if (_userData != null) {\n                                        final updated = await Navigator.push(\n                                          context,\n                                          MaterialPageRoute(\n                                            builder: (context) => EditProfileScreen(userData: _userData ?? {}),\n                                          ),\n                                        );\n                                        if (updated == true) {\n                                          _loadUserData();\n                                        }\n                                      }\n                                    },\n                                    style: ElevatedButton.styleFrom(\n                                      backgroundColor: Colors.blue, // ✅ Button background color\n                                      foregroundColor: Colors.white, // ✅ Text color\n                                      shape: RoundedRectangleBorder(\n                                        borderRadius: BorderRadius.circular(8),\n                                      ),\n                                      padding: const EdgeInsets.symmetric(vertical: 12),\n                                    ),\n                                    child: const Text(\"Edit Profile\"),\n                                  ),\n                                ),\n                              ),\n                              Expanded(\n                                child: Padding(\n                                  padding: const EdgeInsets.symmetric(horizontal: 8),\n                                  child: ElevatedButton(\n                                    onPressed: () {\n                                      Navigator.push(\n                                        context,\n                                        MaterialPageRoute(builder: (_) => const SettingsScreen()),\n                                      );\n                                    },\n                                    style: ElevatedButton.styleFrom(\n                                      backgroundColor: Colors.blue, // ✅ Button background color\n                                      foregroundColor: Colors.white, // ✅ Text color\n                                      shape: RoundedRectangleBorder(\n                                        borderRadius: BorderRadius.circular(8),\n                                      ),\n                                      padding: const EdgeInsets.symmetric(vertical: 12),\n                                    ),\n                                    child: const Text(\"Settings\"),\n                                  ),\n                                ),\n                              ),\n                            ],\n                          ),\n\n                          const SizedBox(height: 20),\n                          const Divider(thickness: 1),\n                          const SizedBox(height: 20),\n\n                          const TabBar(\n                            tabs: [\n                              Tab(icon: Icon(Icons.photo_album)),\n                              Tab(icon: Icon(Icons.contacts)),\n                            ],\n                            indicatorColor: Colors.blueAccent,\n                            labelColor: Colors.blueAccent,\n                            unselectedLabelColor: Colors.grey,\n                          ),\n\n                          SizedBox(\n                            height: 300,\n                            child: TabBarView(\n                              children: [\n                                _buildAlbumTab(),\n                                _buildEmergencyTab(),\n                              ],\n                            ),\n                          ),\n\n                          const SizedBox(height: 40),\n                        ],\n                      ),\n                    ),\n                  ),\n                ),\n    );\n  }\n\n  Widget _buildStat(String label, String count) {\n    return Column(\n      children: [\n        Text(\n          count,\n          style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18),\n        ),\n        const SizedBox(height: 4),\n        Text(label, style: const TextStyle(fontSize: 14, color: Colors.black54)),\n      ],\n    );\n  }\n\n  Widget _buildInfoRow(String title, String value) {\n    return Padding(\n      padding: const EdgeInsets.symmetric(vertical: 6.0),\n      child: Row(\n        children: [\n          Text(\n            \"$title: \",\n            style: const TextStyle(\n                fontWeight: FontWeight.bold, color: Colors.black87),\n          ),\n          Expanded(\n            child: Text(value, style: const TextStyle(color: Colors.black87)),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Widget _buildAlbumTab() {\n    if (_albums.isEmpty) {\n      return const Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            Icon(Icons.photo_album_outlined, size: 64, color: Colors.grey),\n            SizedBox(height: 16),\n            Text(\n              'No memories yet. Add one!',\n              style: TextStyle(fontSize: 18, color: Colors.grey),\n            ),\n          ],\n        ),\n      );\n    }\n\n    return GridView.builder(\n      padding: const EdgeInsets.all(16),\n      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n        crossAxisCount: 3,\n        childAspectRatio: 1,\n        crossAxisSpacing: 4,\n        mainAxisSpacing: 4,\n      ),\n      itemCount: _albums.length,\n      itemBuilder: (context, index) {\n        final album = _albums[index].data() as Map<String, dynamic>;\n        return GestureDetector(\n          onTap: () => Navigator.push(\n            context,\n            MaterialPageRoute(\n              builder: (context) => FullImageScreen(imageUrl: album['imageUrl']),\n            ),\n          ),\n          child: ClipRRect(\n            borderRadius: BorderRadius.circular(8),\n            child: Image.network(\n              album['imageUrl'],\n              fit: BoxFit.cover,\n              errorBuilder: (context, error, stackTrace) {\n                return const Center(child: Icon(Icons.error));\n              },\n            ),\n          ),\n        );\n      },\n    );\n  }\n\n  Widget _buildEmergencyTab() {\n    final contacts = _userData!['emergencyContacts'] as List? ?? [];\n    if (contacts.isEmpty) {\n      return const Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            Icon(Icons.contacts_outlined, size: 64, color: Colors.grey),\n            SizedBox(height: 16),\n            Text(\n              'No emergency contacts',\n              style: TextStyle(fontSize: 18, color: Colors.grey),\n            ),\n          ],\n        ),\n      );\n    }\n\n    return ListView.builder(\n      padding: const EdgeInsets.all(16),\n      itemCount: contacts.length,\n      itemBuilder: (context, index) {\n        final contact = contacts[index] as Map<String, dynamic>;\n        return Card(\n          elevation: 2,\n          margin: const EdgeInsets.only(bottom: 16),\n          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n          child: ListTile(\n            leading: const Icon(Icons.person, color: Colors.blueAccent),\n            title: Text(contact['name'] ?? 'Unknown'),\n            subtitle: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text('Relation: ${contact['relation'] ?? 'None'}'),\n                Text('Phone: ${contact['number'] ?? 'None'}'),\n              ],\n            ),\n            trailing: IconButton(\n              icon: const Icon(Icons.phone, color: Colors.green),\n              onPressed: () {\n                final number = contact['number'] as String?;\n                if (number != null && number.isNotEmpty) {\n                  _callNumber(number);\n                }\n              },\n            ),\n          ),\n        );\n      },\n    );\n  }\n}\n\nclass FullImageScreen extends StatelessWidget {\n  final String imageUrl;\n  const FullImageScreen({super.key, required this.imageUrl});\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      backgroundColor: Colors.black,\n      body: GestureDetector(\n        onTap: () => Navigator.pop(context),\n        child: Center(\n          child: Image.network(imageUrl),\n        ),\n      ),\n      floatingActionButton: FloatingActionButton(\n        mini: true,\n        onPressed: () => Navigator.pop(context),\n        child: const Icon(Icons.close),\n      ),\n      floatingActionButtonLocation: FloatingActionButtonLocation.endTop,\n    );\n  }\n}",
          "_encoding": "utf-8"
        }
      },
      "location_service.dart": {
        "_text": "// lib/user/location_service.dart (Fully Fixed)\nimport 'dart:async';\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:geolocator/geolocator.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:permission_handler/permission_handler.dart';\nimport 'package:flutter/material.dart';\n\nclass PatientLocationService {\n  final _firestore = FirebaseFirestore.instance;\n  final _auth = FirebaseAuth.instance;\n  Timer? _updateTimer;\n  bool _isSharing = false;\n\n  // Check if location services are enabled\n  Future<bool> _checkLocationService() async {\n    try {\n      return await Geolocator.isLocationServiceEnabled();\n    } catch (e) {\n      debugPrint('Error checking location service: $e');\n      return false;\n    }\n  }\n\n  // Request location permissions\n  Future<bool> _requestLocationPermission(BuildContext context) async {\n    try {\n      // Check current permission status first\n      LocationPermission permission = await Geolocator.checkPermission();\n      \n      if (permission == LocationPermission.deniedForever) {\n        if (context.mounted) {\n          await _showPermissionDialog(\n            context,\n            'Location Permission Permanently Denied',\n            'Location permission has been permanently denied. Please enable it in app settings to share your location.',\n          );\n        }\n        return false;\n      }\n\n      if (permission == LocationPermission.denied) {\n        permission = await Geolocator.requestPermission();\n        \n        if (permission == LocationPermission.denied) {\n          if (context.mounted) {\n            ScaffoldMessenger.of(context).showSnackBar(\n              const SnackBar(content: Text('Location permission is required to share location')),\n            );\n          }\n          return false;\n        }\n        \n        if (permission == LocationPermission.deniedForever) {\n          if (context.mounted) {\n            await _showPermissionDialog(\n              context,\n              'Location Permission Denied',\n              'Location permission has been denied. Please enable it in app settings to share your location.',\n            );\n          }\n          return false;\n        }\n      }\n\n      return permission == LocationPermission.always || \n             permission == LocationPermission.whileInUse;\n    } catch (e) {\n      debugPrint('Error requesting location permission: $e');\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error requesting location permission: $e')),\n        );\n      }\n      return false;\n    }\n  }\n\n  // Show permission dialog\n  Future<void> _showPermissionDialog(BuildContext context, String title, String content) async {\n    return showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: Text(title),\n        content: Text(content),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('Cancel'),\n          ),\n          TextButton(\n            onPressed: () async {\n              Navigator.pop(context);\n              await openAppSettings();\n            },\n            child: const Text('Open Settings'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  // Start sharing location\n  Future<void> startSharingLocation(BuildContext context) async {\n    if (_isSharing) {\n      debugPrint('Location sharing already active');\n      return;\n    }\n\n    try {\n      // Check if location services are enabled\n      final serviceEnabled = await _checkLocationService();\n      if (!serviceEnabled) {\n        if (context.mounted) {\n          await showDialog(\n            context: context,\n            builder: (context) => AlertDialog(\n              title: const Text('Location Services Disabled'),\n              content: const Text('Please enable location services to share your location.'),\n              actions: [\n                TextButton(\n                  onPressed: () => Navigator.pop(context),\n                  child: const Text('Cancel'),\n                ),\n                TextButton(\n                  onPressed: () async {\n                    Navigator.pop(context);\n                    await Geolocator.openLocationSettings();\n                  },\n                  child: const Text('Open Settings'),\n                ),\n              ],\n            ),\n          );\n        }\n        return;\n      }\n\n      // Request location permission\n      final hasPermission = await _requestLocationPermission(context);\n      if (!hasPermission) {\n        return;\n      }\n\n      // Start location sharing with initial update and periodic timer\n      _isSharing = true;\n      \n      // Initial location update on start\n      await _getAndUpdateLocation(context);\n      \n      // Set up periodic updates every 30 minutes\n      _updateTimer = Timer.periodic(const Duration(minutes: 30), (_) {\n        _getAndUpdateLocation(context);\n      });\n\n      debugPrint('Location sharing started successfully with periodic updates');\n\n    } catch (e) {\n      debugPrint('Error starting location sharing: $e');\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error starting location sharing: $e')),\n        );\n      }\n      _isSharing = false;\n    }\n  }\n\n  // Get current location and update in Firestore\n  Future<void> _getAndUpdateLocation(BuildContext context) async {\n    try {\n      final position = await Geolocator.getCurrentPosition(\n        desiredAccuracy: LocationAccuracy.best,\n        timeLimit: const Duration(seconds: 30),\n      );\n      await _updateLocationInFirestore(position);\n    } catch (e) {\n      debugPrint('Error getting location: $e');\n      _handleLocationError(e, context);\n    }\n  }\n\n  // Update location in Firestore\n  Future<void> _updateLocationInFirestore(Position position) async {\n    try {\n      final uid = _auth.currentUser?.uid;\n      if (uid == null) {\n        debugPrint('No user logged in');\n        return;\n      }\n\n      await _firestore.collection(\"user\").doc(uid).update({\n        \"currentLat\": position.latitude,\n        \"currentLng\": position.longitude,\n        \"locationTimestamp\": FieldValue.serverTimestamp(),\n      });\n      \n      debugPrint('Location updated: ${position.latitude}, ${position.longitude}');\n    } catch (e) {\n      debugPrint(\"Error updating location in Firestore: $e\");\n    }\n  }\n\n  // Handle location errors\n  void _handleLocationError(dynamic error, BuildContext context) {\n    debugPrint('Location error: $error');\n    \n    if (error is LocationServiceDisabledException) {\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Location services have been disabled')),\n        );\n      }\n    } else {\n      if (context.mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Location error: ${error.toString()}')),\n        );\n      }\n    }\n  }\n\n  // Stop sharing location\n  Future<void> stopSharingLocation() async {\n    try {\n      _updateTimer?.cancel();\n      _updateTimer = null;\n      _isSharing = false;\n      debugPrint('Location sharing stopped');\n    } catch (e) {\n      debugPrint('Error stopping location sharing: $e');\n    }\n  }\n\n  // Check if location is being shared\n  bool get isSharing => _isSharing;\n\n  // Dispose resources\n  void dispose() {\n    _updateTimer?.cancel();\n    _updateTimer = null;\n    _isSharing = false;\n  }\n}",
        "_encoding": "utf-8"
      },
      "user_bottom_nav.dart": {
        "_text": "// lib/user/user_bottom_nav.dart\nimport 'dart:async';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'diary_album/diary_album_screen.dart';\nimport 'family/family_screen.dart';\nimport 'home/home_screen.dart';\nimport 'caretaker/caretaker_screen.dart';\nimport 'profile/user_profile.dart';\nimport 'location_service.dart';\n\nclass UserBottomNav extends StatefulWidget {\n  const UserBottomNav({super.key});\n\n  @override\n  State<UserBottomNav> createState() => _UserBottomNavState();\n}\n\nclass _UserBottomNavState extends State<UserBottomNav> {\n  int _selectedIndex = 2;\n  final PatientLocationService _locationService = PatientLocationService();\n  StreamSubscription<DocumentSnapshot>? _connectionSubscription;\n  bool _isConnected = false;\n\n  final List<Widget> _pages = [\n    const FamilyScreen(),\n    const CaretakerScreen(),\n    const HomeScreen(),\n    const DiaryAlbumScreen(),\n    const UserProfile(),\n  ];\n\n  Future<void> _checkBanned() async {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) return;\n\n    final doc = await FirebaseFirestore.instance.collection('user').doc(uid).get();\n\n    if (doc.data()?['isBanned'] == true) {\n      if (!mounted) return;\n      showDialog(\n        context: context,\n        builder: (_) => AlertDialog(\n          title: const Text('Account Banned'),\n          content: const Text('Your account has been banned.'),\n          actions: [\n            TextButton(\n              onPressed: () async {\n                await _cleanup();\n                await FirebaseAuth.instance.signOut();\n                if (!mounted) return;\n                Navigator.pushReplacementNamed(context, '/welcome');\n              },\n              child: const Text('Logout'),\n            ),\n          ],\n        ),\n      );\n    }\n  }\n\n  void _startConnectionListener() {\n    final uid = FirebaseAuth.instance.currentUser?.uid;\n    if (uid == null) return;\n\n    _connectionSubscription = FirebaseFirestore.instance\n        .collection('user')\n        .doc(uid)\n        .snapshots()\n        .listen((snapshot) {\n      if (snapshot.exists) {\n        final data = snapshot.data();\n        final newConnectionStatus = data?['isConnected'] == true;\n\n        if (newConnectionStatus != _isConnected) {\n          setState(() => _isConnected = newConnectionStatus);\n\n          if (newConnectionStatus) {\n            _startLocationSharing();\n          } else {\n            _stopLocationSharing();\n          }\n        }\n      }\n    }, onError: (error) {\n      debugPrint('Connection listener error: $error');\n    });\n  }\n\n  Future<void> _startLocationSharing() async {\n    try {\n      await _locationService.startSharingLocation(context);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Location sharing started')),\n        );\n      }\n    } catch (e) {\n      debugPrint('Error starting location sharing: $e');\n    }\n  }\n\n  Future<void> _stopLocationSharing() async {\n    try {\n      await _locationService.stopSharingLocation();\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Location sharing stopped')),\n        );\n      }\n    } catch (e) {\n      debugPrint('Error stopping location sharing: $e');\n    }\n  }\n\n  Future<void> _cleanup() async {\n    await _stopLocationSharing();\n    _locationService.dispose();\n    await _connectionSubscription?.cancel();\n    _connectionSubscription = null;\n  }\n\n  @override\n  void initState() {\n    super.initState();\n    _checkBanned();\n    _startConnectionListener();\n  }\n\n  @override\n  void dispose() {\n    _cleanup();\n    super.dispose();\n  }\n\n  Widget _buildAnimatedIcon(IconData icon, int index, String label) {\n    final bool isSelected = _selectedIndex == index;\n\n    return AnimatedContainer(\n      duration: const Duration(milliseconds: 200),\n      curve: Curves.easeOut,\n      padding: EdgeInsets.only(top: isSelected ? 2 : 8, bottom: isSelected ? 0 : 8),\n      child: Column(\n        mainAxisSize: MainAxisSize.min,\n        children: [\n          AnimatedScale(\n            scale: isSelected ? 1.2 : 1.1,\n            duration: const Duration(milliseconds: 250),\n            curve: Curves.easeOutBack,\n            child: Icon(\n              icon,\n              color: isSelected ? Colors.blueAccent : Colors.grey[600],\n            ),\n          ),\n          AnimatedSize(\n            duration: const Duration(milliseconds: 200),\n            curve: Curves.easeOut,\n            child: isSelected\n                ? Padding(\n                    padding: const EdgeInsets.only(top: 3),\n                    child: Text(\n                      label,\n                      style: const TextStyle(\n                        fontSize: 11,\n                        fontWeight: FontWeight.w600,\n                        color: Colors.blueAccent,\n                      ),\n                    ),\n                  )\n                : const SizedBox.shrink(),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: _pages[_selectedIndex],\n      bottomNavigationBar: Container(\n        decoration: const BoxDecoration(\n          color: Colors.white,\n          boxShadow: [BoxShadow(blurRadius: 6, color: Colors.black12)],\n        ),\n        child: BottomNavigationBar(\n          currentIndex: _selectedIndex,\n          onTap: (index) => setState(() => _selectedIndex = index),\n          type: BottomNavigationBarType.fixed,\n          backgroundColor: Colors.white,\n          elevation: 0,\n          showSelectedLabels: false,\n          showUnselectedLabels: false,\n          items: [\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.group, 0, 'Family'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.medical_services, 1, 'Care'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.home_rounded, 2, 'Home'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.book_outlined, 3, 'Diary'),\n              label: '',\n            ),\n            BottomNavigationBarItem(\n              icon: _buildAnimatedIcon(Icons.person_rounded, 4, 'Profile'),\n              label: '',\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n",
        "_encoding": "utf-8"
      }
    },
    "utils": {
      "notification_helper.dart": {
        "_text": "// lib/utils/notification_helper.dart\nimport 'package:http/http.dart' as http;\nimport 'dart:convert';\nimport 'package:intl/intl.dart';\n\nFuture<void> sendNotification(List<String> playerIds, String content) async {\n  if (playerIds.isEmpty) return;\n\n  const appId = '73673a14-2de9-44c4-a9c5-dd531da39b59';\n  const apiKey = 'os_v2_app_onttufbn5fcmjkof3vjr3i43lfxi2bnfivyeki4nrswqzdu7bsf4qk7wh67lkpwfs6acdpnjaemq7kdj6pbtwrgrver3yacqwjqnf4y';\n\n  try {\n    final response = await http.post(\n      Uri.parse('https://onesignal.com/api/v1/notifications'),\n      headers: {\n        'Content-Type': 'application/json; charset=utf-8',\n        'Authorization': 'Basic $apiKey',\n      },\n      body: jsonEncode({\n        'app_id': appId,\n        'include_player_ids': playerIds,\n        'contents': {'en': content},\n        'priority': 10,\n      }),\n    ).timeout(const Duration(seconds: 10));\n\n    if (response.statusCode != 200) {\n      print('Failed to send notification: ${response.statusCode} - ${response.body}');\n    } else {\n      print('Notification sent successfully: ${response.body}');\n    }\n  } catch (e) {\n    print('Error sending notification: $e');\n  }\n}\n\nFuture<void> scheduleNotification(List<String> playerIds, String content, DateTime scheduledTime) async {\n  if (playerIds.isEmpty) return;\n\n  const appId = '73673a14-2de9-44c4-a9c5-dd531da39b59';\n  const apiKey = 'os_v2_app_onttufbn5fcmjkof3vjr3i43lfxi2bnfivyeki4nrswqzdu7bsf4qk7wh67lkpwfs6acdpnjaemq7kdj6pbtwrgrver3yacqwjqnf4y';\n\n  final formattedTime = DateFormat('yyyy-MM-dd HH:mm:ss').format(scheduledTime.toUtc()) + ' UTC';\n\n  try {\n    final response = await http.post(\n      Uri.parse('https://onesignal.com/api/v1/notifications'),\n      headers: {\n        'Content-Type': 'application/json; charset=utf-8',\n        'Authorization': 'Basic $apiKey',\n      },\n      body: jsonEncode({\n        'app_id': appId,\n        'include_player_ids': playerIds,\n        'contents': {'en': content},\n        'send_after': formattedTime,\n        'priority': 10,\n      }),\n    ).timeout(const Duration(seconds: 10));\n\n    if (response.statusCode != 200) {\n      print('Failed to schedule notification: ${response.statusCode} - ${response.body}');\n    } else {\n      print('Notification scheduled successfully: ${response.body}');\n    }\n  } catch (e) {\n    print('Error scheduling notification: $e');\n  }\n}\n",
        "_encoding": "utf-8"
      }
    },
    "firebase_options.dart": {
      "_text": "// File generated by FlutterFire CLI.\n// ignore_for_file: type=lint\nimport 'package:firebase_core/firebase_core.dart' show FirebaseOptions;\nimport 'package:flutter/foundation.dart'\n    show defaultTargetPlatform, kIsWeb, TargetPlatform;\n\n/// Default [FirebaseOptions] for use with your Firebase apps.\n///\n/// Example:\n/// ```dart\n/// import 'firebase_options.dart';\n/// // ...\n/// await Firebase.initializeApp(\n///   options: DefaultFirebaseOptions.currentPlatform,\n/// );\n/// ```\nclass DefaultFirebaseOptions {\n  static FirebaseOptions get currentPlatform {\n    if (kIsWeb) {\n      throw UnsupportedError(\n        'DefaultFirebaseOptions have not been configured for web - '\n        'you can reconfigure this by running the FlutterFire CLI again.',\n      );\n    }\n    switch (defaultTargetPlatform) {\n      case TargetPlatform.android:\n        return android;\n      case TargetPlatform.iOS:\n        return ios;\n      case TargetPlatform.macOS:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions have not been configured for macos - '\n          'you can reconfigure this by running the FlutterFire CLI again.',\n        );\n      case TargetPlatform.windows:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions have not been configured for windows - '\n          'you can reconfigure this by running the FlutterFire CLI again.',\n        );\n      case TargetPlatform.linux:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions have not been configured for linux - '\n          'you can reconfigure this by running the FlutterFire CLI again.',\n        );\n      default:\n        throw UnsupportedError(\n          'DefaultFirebaseOptions are not supported for this platform.',\n        );\n    }\n  }\n\n  static const FirebaseOptions android = FirebaseOptions(\n    apiKey: 'AIzaSyD24yA69_RtcP-ad4cVST3ykwfEEpWScGw',\n    appId: '1:54955106735:android:ed95e1b17fba45b566cf5a',\n    messagingSenderId: '54955106735',\n    projectId: 'dementia-app-2025',\n    storageBucket: 'dementia-app-2025.firebasestorage.app',\n  );\n\n  static const FirebaseOptions ios = FirebaseOptions(\n    apiKey: 'AIzaSyAznFalyZJzZlofbHOIYUXbGiipNwL7PXU',\n    appId: '1:54955106735:ios:da277fbc63d770d366cf5a',\n    messagingSenderId: '54955106735',\n    projectId: 'dementia-app-2025',\n    storageBucket: 'dementia-app-2025.firebasestorage.app',\n    iosBundleId: 'com.example.dementiaVirtualMemory',\n  );\n}\n",
      "_encoding": "utf-8"
    },
    "forgot_password_page.dart": {
      "_text": "// lib/forgot_password_page.dart\n// lib/forgot_password_page.dart\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\n\nclass ForgotPasswordPage extends StatefulWidget {\n  const ForgotPasswordPage({super.key});\n\n  @override\n  State<ForgotPasswordPage> createState() => _ForgotPasswordPageState();\n}\n\nclass _ForgotPasswordPageState extends State<ForgotPasswordPage> {\n  final TextEditingController emailController = TextEditingController();\n  final _auth = FirebaseAuth.instance;\n  bool _loading = false;\n\n  Future<void> _resetPassword() async {\n    setState(() => _loading = true);\n    try {\n      await _auth.sendPasswordResetEmail(email: emailController.text.trim());\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Password reset link sent to ${emailController.text}')));\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Failed: $e')));\n      }\n    } finally {\n      setState(() => _loading = false);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      resizeToAvoidBottomInset: true, // Ensure content resizes when keyboard appears\n      appBar: AppBar(\n        title: const Text('Forgot Password'),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n      ),\n      body: Container(\n        decoration: BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [Colors.blueAccent.withValues(alpha: 0.1), Colors.white],\n          ),\n        ),\n        child: SingleChildScrollView( // Add SingleChildScrollView to handle keyboard overflow\n          padding: const EdgeInsets.all(24.0),\n          child: Column(\n            mainAxisAlignment: MainAxisAlignment.center,\n            children: [\n              const Text(\n                'Enter your email to reset your password',\n                style: TextStyle(fontSize: 18, color: Colors.blueAccent),\n                textAlign: TextAlign.center,\n              ),\n              const SizedBox(height: 24),\n              TextField(\n                controller: emailController,\n                decoration: InputDecoration(\n                  labelText: 'Email',\n                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),\n                  filled: true,\n                  fillColor: Colors.white,\n                  prefixIcon: const Icon(Icons.email, color: Colors.blueAccent),\n                ),\n              ),\n              const SizedBox(height: 32),\n              _loading\n                  ? const CircularProgressIndicator(color: Colors.blueAccent)\n                  : ElevatedButton(\n                      onPressed: _resetPassword,\n                      style: ElevatedButton.styleFrom(\n                        backgroundColor: Colors.blueAccent,\n                        padding: const EdgeInsets.symmetric(vertical: 16),\n                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n                        minimumSize: const Size(double.infinity, 50),\n                      ),\n                      child: const Text('Send Reset Link', style: TextStyle(fontSize: 18, color: Colors.white)),\n                    ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "login_page.dart": {
      "_text": "// lib/login_page.dart\n\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport 'admin/admin_bottom_nav.dart';\nimport 'careTaker/caretaker_bottom_nav.dart';\nimport 'register_page.dart';\nimport 'forgot_password_page.dart';\nimport 'user/user_bottom_nav.dart';\n\nclass LoginPage extends StatefulWidget {\n  final String role;\n  const LoginPage({Key? key, required this.role}) : super(key: key);\n\n  @override\n  State<LoginPage> createState() => _LoginPageState();\n}\n\nclass _LoginPageState extends State<LoginPage> {\n  final TextEditingController emailController = TextEditingController();\n  final TextEditingController passwordController = TextEditingController();\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  bool _loading = false;\n  bool _obscurePassword = true;\n\n  final _formKey = GlobalKey<FormState>();\n\n  @override\n  void dispose() {\n    emailController.dispose();\n    passwordController.dispose();\n    super.dispose();\n  }\n\n  Future<void> _login() async {\n    if (!_formKey.currentState!.validate()) return;\n    \n    setState(() => _loading = true);\n\n    try {\n      final credential = await _auth.signInWithEmailAndPassword(\n        email: emailController.text.trim(),\n        password: passwordController.text.trim(),\n      );\n      final uid = credential.user?.uid;\n      final email = credential.user?.email;\n\n      if (uid == null) {\n        if (mounted) {\n          _showErrorDialog('Login failed', 'Missing user ID. Please try again.');\n        }\n        return;\n      }\n\n      try {\n        await OneSignal.login(uid);\n      } catch (e) {\n        debugPrint('OneSignal login failed during login: $e');\n      }\n\n      DocumentSnapshot<Map<String, dynamic>> docByUid = await _firestore\n          .collection(widget.role)\n          .doc(uid)\n          .get();\n\n      Map<String, dynamic>? data;\n      DocumentReference<Map<String, dynamic>>? docRef;\n\n      if (docByUid.exists && docByUid.data() != null) {\n        data = docByUid.data();\n        docRef = _firestore.collection(widget.role).doc(uid);\n      } else {\n        // Fallback: try finding the document by email (useful for admin docs created manually)\n        if (email != null && email.isNotEmpty) {\n          final query = await _firestore\n              .collection(widget.role)\n              .where('email', isEqualTo: email)\n              .limit(1)\n              .get();\n\n          if (query.docs.isNotEmpty) {\n            final qdoc = query.docs.first;\n            data = qdoc.data();\n            docRef = qdoc.reference;\n\n            // Optional: store uid into that document to help future lookups\n            try {\n              await qdoc.reference.update({'uid': uid});\n            } catch (_) {\n              // ignore update errors\n            }\n          }\n        }\n      }\n\n      if (data == null || docRef == null) {\n        await _auth.signOut();\n        if (mounted) {\n          _showErrorDialog(\n            'Invalid Role', \n            'This account is not registered as a ${widget.role}. Please login with the correct role or contact support.'\n          );\n        }\n        return;\n      }\n\n      // Ban check\n      if (data['isBanned'] == true) {\n        await _auth.signOut();\n        if (mounted) {\n          _showErrorDialog(\n            'Account Banned',\n            'Your ${widget.role} account has been suspended by the Administrator. Please contact support for more information.'\n          );\n        }\n        return;\n      }\n\n      // Add OneSignal player id to the found document\n      try {\n        final playerId = OneSignal.User.pushSubscription.id;\n        if (playerId != null && playerId.isNotEmpty) {\n          await docRef.update({\n            'playerIds': FieldValue.arrayUnion([playerId]),\n          });\n        }\n      } catch (_) {\n        // If OneSignal call fails, ignore - don't block login\n      }\n\n      // Save role for auto-login\n      final prefs = await SharedPreferences.getInstance();\n      await prefs.setString('lastRole', widget.role);\n\n      if (mounted) {\n        _showSuccessDialog('Welcome Back!', 'Successfully logged in as ${widget.role}');\n        \n        // Navigate to the appropriate home screen and prevent going back\n        Widget targetScreen = const SizedBox();\n        \n        if (widget.role == 'user') {\n          targetScreen = const UserBottomNav();\n        } else if (widget.role == 'caretaker') {\n          targetScreen = const CareTaker();\n        } else {\n          targetScreen = const AdminBottomNav();\n        }\n        \n        // Use pushAndRemoveUntil to prevent going back to login\n        Navigator.pushAndRemoveUntil(\n          context,\n          MaterialPageRoute(builder: (context) => targetScreen),\n          (route) => false, // Remove all previous routes\n        );\n      }\n    } on FirebaseAuthException catch (e) {\n      if (mounted) {\n        String message = 'An error occurred during login.';\n        String title = 'Login Failed';\n        \n        switch (e.code) {\n          case 'user-not-found':\n            title = 'Account Not Found';\n            message = 'No account found with this email address. Please check your email or register for a new account.';\n            break;\n          case 'wrong-password':\n            title = 'Incorrect Password';\n            message = 'The password you entered is incorrect. Please try again or use \\\"Forgot Password\\\" to reset it.';\n            break;\n          case 'invalid-email':\n            title = 'Invalid Email';\n            message = 'The email address is not valid. Please check and try again.';\n            break;\n          case 'user-disabled':\n            title = 'Account Disabled';\n            message = 'This account has been disabled. Please contact support for assistance.';\n            break;\n          case 'too-many-requests':\n            title = 'Too Many Attempts';\n            message = 'Too many unsuccessful login attempts. Please try again later or reset your password.';\n            break;\n          default:\n            message = e.message ?? 'An unexpected error occurred. Please try again.';\n        }\n        \n        _showErrorDialog(title, message);\n      }\n    } catch (e) {\n      if (mounted) {\n        _showErrorDialog(\n          'Login Error',\n          'An unexpected error occurred. Please check your internet connection and try again.'\n        );\n      }\n    } finally {\n      setState(() => _loading = false);\n    }\n  }\n\n  void _showErrorDialog(String title, String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: Row(\n          children: [\n            Icon(Icons.error_outline, color: Colors.red.shade600),\n            const SizedBox(width: 8),\n            Text(title),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showSuccessDialog(String title, String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: Row(\n          children: [\n            Icon(Icons.check_circle, color: Colors.green.shade600),\n            const SizedBox(width: 8),\n            Text(title),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('Continue'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _goToRegister() {\n    Navigator.pushReplacement(\n      context,\n      MaterialPageRoute(builder: (context) => RegisterPage(role: widget.role)),\n    );\n  }\n\n  void _forgotPassword() {\n    Navigator.push(\n      context,\n      MaterialPageRoute(builder: (context) => const ForgotPasswordPage()),\n    );\n  }\n\n  String? _validateEmail(String? value) {\n    if (value == null || value.isEmpty) {\n      return 'Please enter your email address';\n    }\n    if (!RegExp(r'^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$').hasMatch(value)) {\n      return 'Please enter a valid email address';\n    }\n    return null;\n  }\n\n  String? _validatePassword(String? value) {\n    if (value == null || value.isEmpty) {\n      return 'Please enter your password';\n    }\n    if (value.length < 6) {\n      return 'Password must be at least 6 characters long';\n    }\n    return null;\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final isAdmin = widget.role == 'admin';\n    final roleDisplayName = widget.role == 'caretaker' ? 'Caregiver' : widget.role;\n    \n    return Scaffold(\n      resizeToAvoidBottomInset: true,\n      body: Container(\n        decoration: const BoxDecoration(\n          gradient: LinearGradient(\n            colors: [\n              Colors.blueAccent,\n              Color(0xFF1976D2),\n              Color(0xFF0D47A1),\n            ],\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n          ),\n        ),\n        child: SafeArea(\n          child: Center(\n            child: SingleChildScrollView(\n              padding: const EdgeInsets.all(24.0),\n              child: Column(\n                crossAxisAlignment: CrossAxisAlignment.center,\n                children: [\n                  // Logo and Welcome Section\n                  Container(\n                    padding: const EdgeInsets.all(20),\n                    decoration: BoxDecoration(\n                      color: Colors.white.withOpacity(0.1),\n                      shape: BoxShape.circle,\n                    ),\n                    child: Icon(\n                      Icons.health_and_safety_outlined,\n                      size: 80,\n                      color: Colors.white,\n                    ),\n                  ),\n                  const SizedBox(height: 24),\n                  \n                  Text(\n                    'DVMA',\n                    style: TextStyle(\n                      fontSize: 32,\n                      fontWeight: FontWeight.bold,\n                      color: Colors.white,\n                      letterSpacing: 1.5,\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  \n                  Text(\n                    'Dementia Virtual Memory Assistant',\n                    style: TextStyle(\n                      fontSize: 14,\n                      color: Colors.white.withOpacity(0.8),\n                      fontWeight: FontWeight.w300,\n                    ),\n                  ),\n                  const SizedBox(height: 32),\n\n                  // Login Card\n                  Container(\n                    width: double.infinity,\n                    padding: const EdgeInsets.all(32),\n                    decoration: BoxDecoration(\n                      color: Colors.white,\n                      borderRadius: BorderRadius.circular(24),\n                      boxShadow: [\n                        BoxShadow(\n                          color: Colors.black.withOpacity(0.1),\n                          blurRadius: 20,\n                          offset: const Offset(0, 10),\n                        ),\n                      ],\n                    ),\n                    child: Form(\n                      key: _formKey,\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          // Header\n                          Row(\n                            children: [\n                              Container(\n                                padding: const EdgeInsets.all(8),\n                                decoration: BoxDecoration(\n                                  color: Colors.blueAccent.withOpacity(0.1),\n                                  shape: BoxShape.circle,\n                                ),\n                                child: Icon(\n                                  Icons.lock_outline,\n                                  color: Colors.blueAccent,\n                                  size: 24,\n                                ),\n                              ),\n                              const SizedBox(width: 12),\n                              Expanded(\n                                child: Column(\n                                  crossAxisAlignment: CrossAxisAlignment.start,\n                                  children: [\n                                    Text(\n                                      '$roleDisplayName Login',\n                                      style: const TextStyle(\n                                        fontSize: 24,\n                                        fontWeight: FontWeight.bold,\n                                        color: Colors.blueAccent,\n                                      ),\n                                    ),\n                                    const SizedBox(height: 4),\n                                    Text(\n                                      'Welcome back! Please sign in to continue',\n                                      style: TextStyle(\n                                        fontSize: 14,\n                                        color: Colors.grey.shade600,\n                                      ),\n                                    ),\n                                  ],\n                                ),\n                              ),\n                            ],\n                          ),\n                          const SizedBox(height: 32),\n\n                          // Email Field\n                          Text(\n                            'Email Address',\n                            style: TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w500,\n                              color: Colors.grey.shade700,\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n                          TextFormField(\n                            controller: emailController,\n                            keyboardType: TextInputType.emailAddress,\n                            validator: _validateEmail,\n                            style: TextStyle(\n                              fontSize: 16,\n                              color: Colors.grey.shade800,\n                            ),\n                            decoration: InputDecoration(\n                              hintText: 'Enter your email address',\n                              border: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              enabledBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              focusedBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: const BorderSide(color: Colors.blueAccent, width: 2),\n                              ),\n                              errorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400),\n                              ),\n                              focusedErrorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400, width: 2),\n                              ),\n                              filled: true,\n                              fillColor: Colors.grey.shade50,\n                              prefixIcon: Icon(\n                                Icons.email_outlined,\n                                color: Colors.blueAccent,\n                              ),\n                              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),\n                            ),\n                          ),\n                          const SizedBox(height: 20),\n\n                          // Password Field\n                          Text(\n                            'Password',\n                            style: TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w500,\n                              color: Colors.grey.shade700,\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n                          TextFormField(\n                            controller: passwordController,\n                            obscureText: _obscurePassword,\n                            validator: _validatePassword,\n                            style: TextStyle(\n                              fontSize: 16,\n                              color: Colors.grey.shade800,\n                            ),\n                            decoration: InputDecoration(\n                              hintText: 'Enter your password',\n                              border: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              enabledBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.grey.shade300),\n                              ),\n                              focusedBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: const BorderSide(color: Colors.blueAccent, width: 2),\n                              ),\n                              errorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400),\n                              ),\n                              focusedErrorBorder: OutlineInputBorder(\n                                borderRadius: BorderRadius.circular(12),\n                                borderSide: BorderSide(color: Colors.red.shade400, width: 2),\n                              ),\n                              filled: true,\n                              fillColor: Colors.grey.shade50,\n                              prefixIcon: Icon(\n                                Icons.lock_outline,\n                                color: Colors.blueAccent,\n                              ),\n                              suffixIcon: IconButton(\n                                icon: Icon(\n                                  _obscurePassword ? Icons.visibility_off_outlined : Icons.visibility_outlined,\n                                  color: Colors.grey.shade500,\n                                ),\n                                onPressed: () {\n                                  setState(() => _obscurePassword = !_obscurePassword);\n                                },\n                              ),\n                              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),\n                            ),\n                          ),\n                          const SizedBox(height: 8),\n\n                          // Forgot Password\n                          Align(\n                            alignment: Alignment.centerRight,\n                            child: TextButton(\n                              onPressed: _forgotPassword,\n                              style: TextButton.styleFrom(\n                                padding: EdgeInsets.zero,\n                                tapTargetSize: MaterialTapTargetSize.shrinkWrap,\n                              ),\n                              child: Text(\n                                'Forgot Password?',\n                                style: TextStyle(\n                                  color: Colors.blueAccent,\n                                  fontWeight: FontWeight.w500,\n                                ),\n                              ),\n                            ),\n                          ),\n                          const SizedBox(height: 24),\n\n                          // Login Button\n                          _loading\n                              ? Container(\n                                  height: 56,\n                                  decoration: BoxDecoration(\n                                    color: Colors.blueAccent,\n                                    borderRadius: BorderRadius.circular(12),\n                                  ),\n                                  child: const Center(\n                                    child: SizedBox(\n                                      width: 20,\n                                      height: 20,\n                                      child: CircularProgressIndicator(\n                                        strokeWidth: 2,\n                                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),\n                                      ),\n                                    ),\n                                  ),\n                                )\n                              : ElevatedButton(\n                                  onPressed: _login,\n                                  style: ElevatedButton.styleFrom(\n                                    backgroundColor: Colors.blueAccent,\n                                    padding: const EdgeInsets.symmetric(vertical: 16),\n                                    shape: RoundedRectangleBorder(\n                                      borderRadius: BorderRadius.circular(12),\n                                    ),\n                                    elevation: 2,\n                                    minimumSize: const Size(double.infinity, 56),\n                                  ),\n                                  child: Row(\n                                    mainAxisAlignment: MainAxisAlignment.center,\n                                    children: [\n                                      Text(\n                                        'Sign In as $roleDisplayName',\n                                        style: const TextStyle(\n                                          fontSize: 16,\n                                          fontWeight: FontWeight.w600,\n                                          color: Colors.white,\n                                        ),\n                                      ),\n                                      const SizedBox(width: 8),\n                                      Icon(Icons.arrow_forward, size: 20),\n                                    ],\n                                  ),\n                                ),\n                          const SizedBox(height: 16),\n\n                          // Register Link\n                          if (!isAdmin)\n                            Row(\n                              mainAxisAlignment: MainAxisAlignment.center,\n                              children: [\n                                Text(\n                                  \"Don't have an account?\",\n                                  style: TextStyle(\n                                    color: Colors.grey.shade600,\n                                  ),\n                                ),\n                                const SizedBox(width: 4),\n                                TextButton(\n                                  onPressed: _goToRegister,\n                                  style: TextButton.styleFrom(\n                                    padding: EdgeInsets.zero,\n                                    tapTargetSize: MaterialTapTargetSize.shrinkWrap,\n                                  ),\n                                  child: Text(\n                                    'Sign up here',\n                                    style: TextStyle(\n                                      color: Colors.blueAccent,\n                                      fontWeight: FontWeight.w600,\n                                    ),\n                                  ),\n                                ),\n                              ],\n                            ),\n                        ],\n                      ),\n                    ),\n                  ),\n\n                  // Footer\n                  const SizedBox(height: 32),\n                  Text(\n                    'Secure Login • Protected by Firebase',\n                    style: TextStyle(\n                      fontSize: 12,\n                      color: Colors.white.withOpacity(0.7),\n                    ),\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "main.dart": {
      "_text": "import 'package:firebase_auth/firebase_auth.dart';\nimport 'package:firebase_core/firebase_core.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter_dotenv/flutter_dotenv.dart';\nimport 'package:flutter_gemini/flutter_gemini.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:shared_preferences/shared_preferences.dart';\nimport 'firebase_options.dart';\nimport 'welcome_page.dart';\nimport 'user/user_bottom_nav.dart';\nimport 'careTaker/caretaker_bottom_nav.dart';\nimport 'admin/admin_bottom_nav.dart';\n\nvoid main() async {\n  WidgetsFlutterBinding.ensureInitialized();\n  \n  await dotenv.load(fileName: \".env\");\n  \n  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);\n  \n  final oneSignalAppId = \"73673a14-2de9-44c4-a9c5-dd531da39b59\"; \n     OneSignal.initialize(oneSignalAppId);\n     OneSignal.Notifications.requestPermission(true);\n\n  final geminiApiKey = \"AIzaSyAZ9H-7y_aWH38HSCrOBbshkLmdLTLGvS4\";\n    Gemini.init(apiKey: geminiApiKey);\n\n  final prefs = await SharedPreferences.getInstance();\n  final user = FirebaseAuth.instance.currentUser;\n  Widget initialScreen = const WelcomePage();\n\n  if (user != null) {\n    try {\n      await OneSignal.login(user.uid);\n    } catch (e) {\n      debugPrint('OneSignal login failed in main: $e');\n    }\n  \n    final role = prefs.getString('lastRole') ?? 'user';\n    if (role == 'user') {\n      initialScreen = const UserBottomNav();\n    } else if (role == 'caretaker') {\n      initialScreen = const CareTaker();\n    } else if (role == 'admin') {\n      initialScreen = const AdminBottomNav();\n    }\n  }\n\n  runApp(MyApp(initialScreen: initialScreen));\n}\n\nclass MyApp extends StatelessWidget {\n  final Widget initialScreen;\n\n  const MyApp({super.key, required this.initialScreen});\n\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'DVMA',\n      debugShowCheckedModeBanner: false,\n      theme: ThemeData(\n        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blueAccent),\n      ),\n      home: initialScreen,\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "register_page.dart": {
      "_text": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:onesignal_flutter/onesignal_flutter.dart';\nimport 'package:image_picker/image_picker.dart';\nimport 'package:flutter_dotenv/flutter_dotenv.dart';\nimport 'dart:convert';\nimport 'package:http/http.dart' as http;\nimport 'package:shared_preferences/shared_preferences.dart';\n\nimport 'careTaker/caretaker_bottom_nav.dart';\nimport 'user/user_bottom_nav.dart';\n\nenum CaregiverType { relative, nurse }\nenum UserGender { male, female, other }\nenum FormSection { personal, address, caretaker, review }\n\nclass RegisterPage extends StatefulWidget {\n  final String role;\n  const RegisterPage({super.key, required this.role});\n\n  @override\n  State<RegisterPage> createState() => _RegisterPageState();\n}\n\nclass _RegisterPageState extends State<RegisterPage> {\n  final TextEditingController nameController = TextEditingController();\n  final TextEditingController usernameController = TextEditingController();\n  final TextEditingController emailController = TextEditingController();\n  final TextEditingController passwordController = TextEditingController();\n  final TextEditingController phoneController = TextEditingController();\n  final TextEditingController bioController = TextEditingController();\n  final TextEditingController localityController = TextEditingController();\n  final TextEditingController cityController = TextEditingController();\n  final TextEditingController stateController = TextEditingController();\n  final TextEditingController experienceYearsController = TextEditingController();\n  final TextEditingController relationController = TextEditingController();\n  final TextEditingController expBioController = TextEditingController();\n  final TextEditingController gradNursingController = TextEditingController();\n\n  final _auth = FirebaseAuth.instance;\n  final _firestore = FirebaseFirestore.instance;\n  bool _loading = false;\n\n  CaregiverType _caregiverType = CaregiverType.relative;\n  UserGender _selectedGender = UserGender.male;\n  DateTime? _selectedDOB;\n  String? _selectedProfileImagePath;\n  String? _selectedCertificatePath;\n\n  FormSection _currentSection = FormSection.personal;\n\n  final ImagePicker _picker = ImagePicker();\n\n  // Default profile image URL\n  static const String defaultProfileImageUrl = \n      'https://res.cloudinary.com/dts8hgf4f/image/upload/v1758882470/user_jvnx80.png';\n\n  @override\n  void dispose() {\n    nameController.dispose();\n    usernameController.dispose();\n    emailController.dispose();\n    passwordController.dispose();\n    phoneController.dispose();\n    experienceYearsController.dispose();\n    relationController.dispose();\n    bioController.dispose();\n    localityController.dispose();\n    cityController.dispose();\n    stateController.dispose();\n    expBioController.dispose();\n    gradNursingController.dispose();\n    super.dispose();\n  }\n\n  void _nextSection() {\n    if (!_validateCurrentSection()) return;\n\n    setState(() {\n      switch (_currentSection) {\n        case FormSection.personal:\n          _currentSection = FormSection.address;\n          break;\n        case FormSection.address:\n          if (widget.role == 'caretaker') {\n            _currentSection = FormSection.caretaker;\n          } else {\n            _currentSection = FormSection.review;\n          }\n          break;\n        case FormSection.caretaker:\n          _currentSection = FormSection.review;\n          break;\n        case FormSection.review:\n          _register();\n          break;\n      }\n    });\n  }\n\n  void _previousSection() {\n    setState(() {\n      switch (_currentSection) {\n        case FormSection.address:\n          _currentSection = FormSection.personal;\n          break;\n        case FormSection.caretaker:\n          _currentSection = FormSection.address;\n          break;\n        case FormSection.review:\n          if (widget.role == 'caretaker') {\n            _currentSection = FormSection.caretaker;\n          } else {\n            _currentSection = FormSection.address;\n          }\n          break;\n        case FormSection.personal:\n          break;\n      }\n    });\n  }\n\n  bool _validateCurrentSection() {\n    switch (_currentSection) {\n      case FormSection.personal:\n        if (nameController.text.trim().isEmpty) {\n          _showErrorDialog('Full Name is required');\n          return false;\n        }\n        if (usernameController.text.trim().isEmpty) {\n          _showErrorDialog('Username is required');\n          return false;\n        }\n        if (emailController.text.trim().isEmpty) {\n          _showErrorDialog('Email is required');\n          return false;\n        }\n        if (!RegExp(r'^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$').hasMatch(emailController.text.trim())) {\n          _showErrorDialog('Please enter a valid email address');\n          return false;\n        }\n        if (passwordController.text.trim().isEmpty) {\n          _showErrorDialog('Password is required');\n          return false;\n        }\n        if (passwordController.text.length < 6) {\n          _showErrorDialog('Password must be at least 6 characters long');\n          return false;\n        }\n        if (phoneController.text.trim().isEmpty) {\n          _showErrorDialog('Phone number is required');\n          return false;\n        }\n        if (_selectedDOB == null) {\n          _showErrorDialog('Date of Birth is required');\n          return false;\n        }\n        return true;\n      case FormSection.address:\n        if (bioController.text.trim().isEmpty) {\n          _showErrorDialog('Bio is required');\n          return false;\n        }\n        if (localityController.text.trim().isEmpty) {\n          _showErrorDialog('Locality is required');\n          return false;\n        }\n        if (cityController.text.trim().isEmpty) {\n          _showErrorDialog('City is required');\n          return false;\n        }\n        if (stateController.text.trim().isEmpty) {\n          _showErrorDialog('State is required');\n          return false;\n        }\n        return true;\n      case FormSection.caretaker:\n        if (_caregiverType == CaregiverType.relative) {\n          if (relationController.text.trim().isEmpty) {\n            _showErrorDialog('Please enter your relation to the patient');\n            return false;\n          }\n        } else if (_caregiverType == CaregiverType.nurse) {\n          if (experienceYearsController.text.trim().isEmpty) {\n            _showErrorDialog('Experience years is required for nurses');\n            return false;\n          }\n          if (expBioController.text.trim().isEmpty) {\n            _showErrorDialog('Experience bio is required for nurses');\n            return false;\n          }\n          if (gradNursingController.text.trim().isEmpty) {\n            _showErrorDialog('Nursing qualification is required for nurses');\n            return false;\n          }\n          // Certificate validation for nurses\n          if (_selectedCertificatePath == null) {\n            _showErrorDialog('Graduation certificate is required for nurse registration');\n            return false;\n          }\n        }\n        return true;\n      case FormSection.review:\n        return true;\n    }\n  }\n\n  void _showErrorDialog(String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Row(\n          children: [\n            Icon(Icons.error_outline, color: Colors.red),\n            SizedBox(width: 8),\n            Text('Validation Error'),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showSuccessDialog(String message) {\n    showDialog(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Row(\n          children: [\n            Icon(Icons.check_circle, color: Colors.green),\n            SizedBox(width: 8),\n            Text('Success'),\n          ],\n        ),\n        content: Text(message),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context),\n            child: const Text('OK'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future<void> _selectDate(BuildContext context) async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: _selectedDOB ?? DateTime(2000),\n      firstDate: DateTime(1900),\n      lastDate: DateTime.now(),\n      builder: (context, child) {\n        return Theme(\n          data: ThemeData.light().copyWith(\n            colorScheme: const ColorScheme.light(\n              primary: Colors.blueAccent,\n              onPrimary: Colors.white,\n              onSurface: Colors.black,\n            ),\n            dialogBackgroundColor: Colors.white,\n          ),\n          child: child!,\n        );\n      },\n    );\n    if (picked != null && picked != _selectedDOB) {\n      setState(() {\n        _selectedDOB = picked;\n      });\n    }\n  }\n\n  void _pickProfileImage() async {\n    final XFile? image = await _picker.pickImage(source: ImageSource.gallery);\n    if (image != null) {\n      setState(() {\n        _selectedProfileImagePath = image.path;\n      });\n    }\n  }\n\n  void _pickCertificate() async {\n    final XFile? image = await _picker.pickImage(source: ImageSource.gallery);\n    if (image != null) {\n      setState(() {\n        _selectedCertificatePath = image.path;\n      });\n    }\n  }\n\n  // Cloudinary upload logic\n  Future<String?> _uploadFile(String? filePath, String preset) async {\n    if (filePath == null) return null;\n\n    final cloudName = dotenv.env['CLOUDINARY_CLOUD_NAME'];\n\n    if (cloudName == null || cloudName.isEmpty) {\n      if (mounted) {\n        _showErrorDialog('Cloudinary configuration error. Please try again later.');\n      }\n      return null;\n    }\n\n    try {\n      final uri = Uri.parse(\n        'https://api.cloudinary.com/v1_1/$cloudName/image/upload',\n      );\n\n      var request = http.MultipartRequest('POST', uri)\n        ..fields['upload_preset'] = preset\n        ..fields['cloud_name'] = cloudName;\n\n      final file = await http.MultipartFile.fromPath('file', filePath);\n      request.files.add(file);\n\n      final streamedResponse = await request.send();\n      final response = await http.Response.fromStream(streamedResponse);\n\n      if (response.statusCode == 200) {\n        final responseData = json.decode(response.body);\n        final secureUrl = responseData['secure_url'];\n\n        if (secureUrl is String && secureUrl.isNotEmpty) return secureUrl;\n        return null;\n      } else {\n        return null;\n      }\n    } catch (e) {\n      return null;\n    }\n  }\n\n  Future<void> _register() async {\n    setState(() => _loading = true);\n    String? profileUrl;\n    String? certificateUrl;\n\n    try {\n      final username = usernameController.text.trim();\n      final email = emailController.text.trim();\n      final phone = phoneController.text.trim();\n\n      // Check for existing username\n      final snapUsername = await _firestore\n          .collection(widget.role)\n          .where('username', isEqualTo: username)\n          .get();\n      if (snapUsername.docs.isNotEmpty) {\n        throw 'Username \"$username\" is already taken. Please choose a different username.';\n      }\n\n      // Check for existing email\n      final snapEmail = await _firestore\n          .collection(widget.role)\n          .where('email', isEqualTo: email)\n          .get();\n      if (snapEmail.docs.isNotEmpty) {\n        throw 'Email \"$email\" is already registered. Please use a different email or try logging in.';\n      }\n\n      // Upload profile image or use default\n      if (_selectedProfileImagePath != null) {\n        profileUrl = await _uploadFile(\n          _selectedProfileImagePath,\n          'care_taker_image',\n        );\n      } else {\n        profileUrl = defaultProfileImageUrl;\n      }\n\n      // Upload certificate for nurses\n      if (widget.role == 'caretaker' && _caregiverType == CaregiverType.nurse) {\n        certificateUrl = await _uploadFile(\n          _selectedCertificatePath,\n          'graduation',\n        );\n        \n        if (certificateUrl == null) {\n          throw 'Failed to upload graduation certificate. Please try again.';\n        }\n      }\n\n      final credential = await _auth.createUserWithEmailAndPassword(\n        email: email,\n        password: passwordController.text.trim(),\n      );\n      final uid = credential.user?.uid;\n\n      if (uid != null) {\n        try {\n          OneSignal.login(uid);\n        } catch (e) {\n          debugPrint('OneSignal login failed during registration: $e');\n        }\n\n        Map<String, dynamic> data = {\n          'uid': uid,\n          'fullName': nameController.text.trim(),\n          'username': username,\n          'email': email,\n          'phoneNo': phone,\n          'createdAt': Timestamp.now(),\n          'gender': _selectedGender.name,\n          'dateOfBirth': Timestamp.fromDate(_selectedDOB!),\n          'bio': bioController.text.trim(),\n          'locality': localityController.text.trim(),\n          'city': cityController.text.trim(),\n          'state': stateController.text.trim(),\n          'profileImageUrl': profileUrl!,\n          'isConnected': false,\n          'currentConnectionId': null,\n          'emergencyContacts': [],\n          'members': [],\n          'reports_sent': [],\n          'playerIds': [],\n          'isBanned': false,\n        };\n\n        if (widget.role == 'caretaker') {\n          data['caregiverType'] = _caregiverType.name;\n\n          if (_caregiverType == CaregiverType.relative) {\n            data['relation'] = relationController.text.trim();\n            data['experienceYears'] = 0;\n            data['experienceBio'] = '';\n            data['graduationOnNursing'] = '';\n            data['graduationCertificateUrl'] = '';\n          } else {\n            data['experienceYears'] =\n                int.tryParse(experienceYearsController.text.trim()) ?? 0;\n            data['relation'] = '';\n            data['experienceBio'] = expBioController.text.trim();\n            data['graduationOnNursing'] = gradNursingController.text.trim();\n            data['graduationCertificateUrl'] = certificateUrl ?? '';\n          }\n\n          data.addAll({'isApprove': false, 'roadmap': []});\n        }\n\n        await _firestore.collection(widget.role).doc(uid).set(data);\n\n        // Add player ID\n        final playerId = OneSignal.User.pushSubscription.id;\n        if (playerId != null) {\n          await _firestore.collection(widget.role).doc(uid).update({\n            'playerIds': FieldValue.arrayUnion([playerId]),\n          });\n        }\n\n        // Save role to shared preferences\n        final prefs = await SharedPreferences.getInstance();\n        await prefs.setString('lastRole', widget.role);\n\n        if (mounted) {\n          _showSuccessDialog('Registration successful! Welcome to DVMA.');\n          \n          Widget targetScreen = const SizedBox(); \n          \n          if (widget.role == 'user') {\n            targetScreen = const UserBottomNav();\n          } else if (widget.role == 'caretaker') {\n            targetScreen = const CareTaker();\n          }\n          \n          Navigator.pushAndRemoveUntil(\n            context,\n            MaterialPageRoute(builder: (context) => targetScreen),\n            (route) => false,\n          );\n        }\n      }\n    } catch (e) {\n      if (mounted) {\n        String message = 'Registration failed. Please try again.';\n        \n        if (e is FirebaseAuthException) {\n          switch (e.code) {\n            case 'email-already-in-use':\n              message = 'This email is already registered. Please use a different email or try logging in.';\n              break;\n            case 'weak-password':\n              message = 'Password is too weak. Please choose a stronger password.';\n              break;\n            case 'invalid-email':\n              message = 'The email address is invalid. Please check and try again.';\n              break;\n            case 'operation-not-allowed':\n              message = 'Email/password accounts are not enabled. Please contact support.';\n              break;\n            default:\n              message = 'Authentication error: ${e.message}';\n          }\n        } else if (e is String) {\n          message = e;\n        }\n        \n        _showErrorDialog(message);\n      }\n    } finally {\n      setState(() => _loading = false);\n    }\n  }\n\n  Widget _buildFilePicker({\n    required String label,\n    required VoidCallback onTap,\n    required bool isSelected,\n    required IconData icon,\n    bool isRequired = false,\n  }) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 16),\n      decoration: BoxDecoration(\n        borderRadius: BorderRadius.circular(12),\n        border: Border.all(\n          color: isSelected ? Colors.green : Colors.grey.shade300,\n          width: isSelected ? 2 : 1,\n        ),\n        color: isSelected ? Colors.green.withOpacity(0.05) : Colors.white,\n      ),\n      child: InkWell(\n        onTap: onTap,\n        borderRadius: BorderRadius.circular(12),\n        child: Padding(\n          padding: const EdgeInsets.all(16),\n          child: Row(\n            children: [\n              Container(\n                padding: const EdgeInsets.all(8),\n                decoration: BoxDecoration(\n                  color: isSelected ? Colors.green : Colors.blueAccent.withOpacity(0.1),\n                  shape: BoxShape.circle,\n                ),\n                child: Icon(\n                  icon,\n                  color: isSelected ? Colors.white : Colors.blueAccent,\n                  size: 20,\n                ),\n              ),\n              const SizedBox(width: 12),\n              Expanded(\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    Text(\n                      isRequired ? '$label *' : label,\n                      style: TextStyle(\n                        fontSize: 16,\n                        fontWeight: FontWeight.w500,\n                        color: Colors.grey.shade700,\n                      ),\n                    ),\n                    const SizedBox(height: 4),\n                    Text(\n                      isSelected ? 'File selected ✓' : 'Tap to select file',\n                      style: TextStyle(\n                        fontSize: 14,\n                        color: isSelected ? Colors.green : Colors.grey.shade500,\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n              Icon(\n                isSelected ? Icons.check_circle : Icons.arrow_forward_ios,\n                color: isSelected ? Colors.green : Colors.grey.shade400,\n                size: 20,\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildRadio(CaregiverType value, String title, String description) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 12),\n      decoration: BoxDecoration(\n        borderRadius: BorderRadius.circular(12),\n        border: Border.all(\n          color: _caregiverType == value ? Colors.blueAccent : Colors.grey.shade300,\n          width: _caregiverType == value ? 2 : 1,\n        ),\n        color: _caregiverType == value ? Colors.blueAccent.withOpacity(0.05) : Colors.white,\n      ),\n      child: ListTile(\n        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),\n        leading: Radio<CaregiverType>(\n          value: value,\n          groupValue: _caregiverType,\n          onChanged: (CaregiverType? selectedValue) {\n            setState(() {\n              _caregiverType = selectedValue!;\n            });\n          },\n          activeColor: Colors.blueAccent,\n        ),\n        title: Text(\n          title,\n          style: TextStyle(\n            fontWeight: FontWeight.w600,\n            color: Colors.grey.shade800,\n          ),\n        ),\n        subtitle: Text(\n          description,\n          style: TextStyle(\n            fontSize: 12,\n            color: Colors.grey.shade600,\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildGenderChip(UserGender value, String title) {\n    final isSelected = _selectedGender == value;\n    return ChoiceChip(\n      label: Text(title),\n      selected: isSelected,\n      onSelected: (selected) {\n        setState(() {\n          _selectedGender = value;\n        });\n      },\n      selectedColor: Colors.blueAccent,\n      labelStyle: TextStyle(\n        color: isSelected ? Colors.white : Colors.grey.shade700,\n        fontWeight: FontWeight.w500,\n      ),\n      backgroundColor: Colors.grey.shade100,\n      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),\n      shape: RoundedRectangleBorder(\n        borderRadius: BorderRadius.circular(20),\n      ),\n    );\n  }\n\n  // Progress indicator\n  Widget _buildProgressIndicator() {\n    final sections = widget.role == 'caretaker'\n        ? ['Personal', 'Address', 'Caretaker', 'Review']\n        : ['Personal', 'Address', 'Review'];\n    \n    final currentIndex = _currentSection.index;\n    final totalSections = sections.length;\n\n    return Column(\n      children: [\n        // Progress bar with percentage\n        Stack(\n          children: [\n            LinearProgressIndicator(\n              value: (currentIndex + 1) / totalSections,\n              backgroundColor: Colors.grey.shade200,\n              color: Colors.blueAccent,\n              borderRadius: BorderRadius.circular(10),\n              minHeight: 8,\n            ),\n            Positioned(\n              right: 0,\n              child: Text(\n                '${((currentIndex + 1) / totalSections * 100).round()}%',\n                style: const TextStyle(\n                  fontSize: 12,\n                  fontWeight: FontWeight.bold,\n                  color: Colors.blueAccent,\n                ),\n              ),\n            ),\n          ],\n        ),\n        const SizedBox(height: 20),\n        // Section labels\n        Row(\n          mainAxisAlignment: MainAxisAlignment.spaceBetween,\n          children: sections.asMap().entries.map((entry) {\n            final index = entry.key;\n            final section = entry.value;\n            final isActive = index <= currentIndex;\n            final isCurrent = index == currentIndex;\n            \n            return Expanded(\n              child: Column(\n                children: [\n                  Container(\n                    width: 36,\n                    height: 36,\n                    decoration: BoxDecoration(\n                      color: isActive ? Colors.blueAccent : Colors.grey.shade300,\n                      shape: BoxShape.circle,\n                      border: isCurrent ? Border.all(color: Colors.blueAccent, width: 3) : null,\n                    ),\n                    child: Center(\n                      child: Icon(\n                        isActive ? Icons.check : Icons.circle,\n                        color: isActive ? Colors.white : Colors.grey.shade600,\n                        size: isActive ? 18 : 16,\n                      ),\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  Text(\n                    section,\n                    textAlign: TextAlign.center,\n                    style: TextStyle(\n                      fontSize: 12,\n                      fontWeight: isCurrent ? FontWeight.bold : FontWeight.normal,\n                      color: isCurrent ? Colors.blueAccent : Colors.grey.shade600,\n                    ),\n                  ),\n                ],\n              ),\n            );\n          }).toList(),\n        ),\n        const SizedBox(height: 24),\n      ],\n    );\n  }\n\n  // Personal Information Section\n  Widget _buildPersonalSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Personal Information',\n          subtitle: 'Tell us about yourself',\n          icon: Icons.person_outline,\n        ),\n        const SizedBox(height: 24),\n        _buildTextField(nameController, 'Full Name', Icons.person),\n        _buildTextField(usernameController, 'Username', Icons.alternate_email),\n        _buildTextField(emailController, 'Email Address', Icons.email_outlined),\n        _buildTextField(\n          passwordController,\n          'Password',\n          Icons.lock_outline,\n          obscureText: true,\n        ),\n        _buildTextField(\n          phoneController,\n          'Phone Number',\n          Icons.phone_iphone,\n          keyboardType: TextInputType.phone,\n        ),\n\n        // Profile Image Upload\n        _buildFilePicker(\n          label: 'Profile Image',\n          onTap: _pickProfileImage,\n          isSelected: _selectedProfileImagePath != null,\n          icon: Icons.camera_alt,\n        ),\n        Padding(\n          padding: const EdgeInsets.only(bottom: 16),\n          child: Row(\n            children: [\n              Icon(Icons.info_outline, color: Colors.blueAccent, size: 16),\n              const SizedBox(width: 8),\n              Expanded(\n                child: Text(\n                  'Optional - Default image will be used if not selected',\n                  style: TextStyle(\n                    fontSize: 12,\n                    color: Colors.grey.shade600,\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n\n        // Gender Selection\n        const SizedBox(height: 8),\n        Text(\n          'Gender *',\n          style: TextStyle(\n            fontSize: 16,\n            fontWeight: FontWeight.w500,\n            color: Colors.grey.shade700,\n          ),\n        ),\n        const SizedBox(height: 12),\n        Row(\n          mainAxisAlignment: MainAxisAlignment.start,\n          children: [\n            _buildGenderChip(UserGender.male, 'Male'),\n            const SizedBox(width: 12),\n            _buildGenderChip(UserGender.female, 'Female'),\n            const SizedBox(width: 12),\n            _buildGenderChip(UserGender.other, 'Other'),\n          ],\n        ),\n\n        // Date of Birth Picker\n        const SizedBox(height: 16),\n        Text(\n          'Date of Birth *',\n          style: TextStyle(\n            fontSize: 16,\n            fontWeight: FontWeight.w500,\n            color: Colors.grey.shade700,\n          ),\n        ),\n        const SizedBox(height: 8),\n        InkWell(\n          onTap: () => _selectDate(context),\n          borderRadius: BorderRadius.circular(12),\n          child: Container(\n            width: double.infinity,\n            padding: const EdgeInsets.all(16),\n            decoration: BoxDecoration(\n              borderRadius: BorderRadius.circular(12),\n              border: Border.all(color: Colors.grey.shade300),\n              color: Colors.white,\n            ),\n            child: Row(\n              children: [\n                Icon(Icons.calendar_today, color: Colors.blueAccent, size: 20),\n                const SizedBox(width: 12),\n                Text(\n                  _selectedDOB == null\n                      ? 'Select your date of birth'\n                      : '${_selectedDOB!.day}/${_selectedDOB!.month}/${_selectedDOB!.year}',\n                  style: TextStyle(\n                    fontSize: 16,\n                    color: _selectedDOB == null ? Colors.grey.shade500 : Colors.grey.shade800,\n                  ),\n                ),\n                const Spacer(),\n                Icon(Icons.arrow_drop_down, color: Colors.grey.shade500),\n              ],\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n\n  // Address Section\n  Widget _buildAddressSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Address Information',\n          subtitle: 'Where are you located?',\n          icon: Icons.location_on_outlined,\n        ),\n        const SizedBox(height: 24),\n        _buildTextField(\n          bioController,\n          'Bio',\n          Icons.description_outlined,\n          maxLines: 3,\n        ),\n        _buildTextField(localityController, 'Locality/Area', Icons.location_on_outlined),\n        _buildTextField(cityController, 'City', Icons.location_city_outlined),\n        _buildTextField(stateController, 'State', Icons.public_outlined),\n      ],\n    );\n  }\n\n  // Caretaker Section\n  Widget _buildCaretakerSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Caretaker Details',\n          subtitle: 'Tell us about your caregiving experience',\n          icon: Icons.medical_services_outlined,\n        ),\n        const SizedBox(height: 24),\n\n        // Caregiver Type Selection\n        Text(\n          'I am registering as a: *',\n          style: TextStyle(\n            fontSize: 16,\n            fontWeight: FontWeight.w500,\n            color: Colors.grey.shade700,\n          ),\n        ),\n        const SizedBox(height: 12),\n        _buildRadio(\n          CaregiverType.relative,\n          'Family Relative',\n          'Caring for a family member or relative',\n        ),\n        _buildRadio(\n          CaregiverType.nurse,\n          'Professional Nurse',\n          'Registered nurse with professional qualifications',\n        ),\n        const SizedBox(height: 16),\n\n        // Conditional Input Fields\n        if (_caregiverType == CaregiverType.relative) ...[\n          _buildTextField(\n            relationController,\n            'Relation to Patient',\n            Icons.family_restroom_outlined,\n          ),\n        ] else ...[\n          _buildTextField(\n            experienceYearsController,\n            'Years of Experience',\n            Icons.work_history_outlined,\n            keyboardType: TextInputType.number,\n          ),\n          _buildTextField(\n            expBioController,\n            'Professional Experience',\n            Icons.description_outlined,\n            maxLines: 3,\n          ),\n          _buildTextField(\n            gradNursingController,\n            'Nursing Qualification',\n            Icons.school_outlined,\n          ),\n          _buildFilePicker(\n            label: 'Graduation Certificate',\n            onTap: _pickCertificate,\n            isSelected: _selectedCertificatePath != null,\n            icon: Icons.assignment_outlined,\n            isRequired: true,\n          ),\n          Padding(\n            padding: const EdgeInsets.only(bottom: 16),\n            child: Row(\n              children: [\n                Icon(Icons.warning_amber_outlined, color: Colors.orange, size: 16),\n                const SizedBox(width: 8),\n                Expanded(\n                  child: Text(\n                    'Graduation certificate is required for nurse registration',\n                    style: TextStyle(\n                      fontSize: 12,\n                      color: Colors.orange.shade700,\n                    ),\n                  ),\n                ),\n              ],\n            ),\n          ),\n        ],\n      ],\n    );\n  }\n\n  // Review Section\n  Widget _buildReviewSection() {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        _buildSectionHeader(\n          title: 'Review Information',\n          subtitle: 'Please verify all details before submitting',\n          icon: Icons.verified_user_outlined,\n        ),\n        const SizedBox(height: 24),\n        \n        // Personal Info Review\n        _buildReviewSectionTitle('Personal Information'),\n        _buildReviewItem('Full Name', nameController.text),\n        _buildReviewItem('Username', usernameController.text),\n        _buildReviewItem('Email', emailController.text),\n        _buildReviewItem('Phone', phoneController.text),\n        _buildReviewItem('Gender', _selectedGender.name.toUpperCase()),\n        _buildReviewItem('Date of Birth', \n          _selectedDOB != null \n            ? '${_selectedDOB!.day}/${_selectedDOB!.month}/${_selectedDOB!.year}'\n            : 'Not selected'\n        ),\n        _buildReviewItem('Profile Image', \n          _selectedProfileImagePath != null ? 'Uploaded' : 'Default image'\n        ),\n        \n        // Address Info Review\n        _buildReviewSectionTitle('Address Information'),\n        _buildReviewItem('Bio', bioController.text),\n        _buildReviewItem('Locality', localityController.text),\n        _buildReviewItem('City', cityController.text),\n        _buildReviewItem('State', stateController.text),\n        \n        // Caretaker Specific Review\n        if (widget.role == 'caretaker') ...[\n          _buildReviewSectionTitle('Caretaker Details'),\n          _buildReviewItem('Caregiver Type', \n            _caregiverType == CaregiverType.relative ? 'Family Relative' : 'Professional Nurse'\n          ),\n          if (_caregiverType == CaregiverType.relative)\n            _buildReviewItem('Relation to Patient', relationController.text),\n          if (_caregiverType == CaregiverType.nurse) ...[\n            _buildReviewItem('Years of Experience', '${experienceYearsController.text} years'),\n            _buildReviewItem('Professional Experience', expBioController.text),\n            _buildReviewItem('Nursing Qualification', gradNursingController.text),\n            _buildReviewItem('Graduation Certificate', \n              _selectedCertificatePath != null ? 'Uploaded ✓' : 'Not uploaded'\n            ),\n          ]\n        ],\n        \n        const SizedBox(height: 24),\n        Container(\n          padding: const EdgeInsets.all(16),\n          decoration: BoxDecoration(\n            color: Colors.blueAccent.withOpacity(0.05),\n            borderRadius: BorderRadius.circular(12),\n            border: Border.all(color: Colors.blueAccent.withOpacity(0.2)),\n          ),\n          child: Row(\n            children: [\n              Icon(Icons.info_outline, color: Colors.blueAccent, size: 20),\n              const SizedBox(width: 12),\n              Expanded(\n                child: Text(\n                  'By submitting, you agree to our Terms of Service and Privacy Policy',\n                  style: TextStyle(\n                    fontSize: 14,\n                    color: Colors.grey.shade700,\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildSectionHeader({required String title, required String subtitle, required IconData icon}) {\n    return Row(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        Container(\n          padding: const EdgeInsets.all(8),\n          decoration: BoxDecoration(\n            color: Colors.blueAccent.withOpacity(0.1),\n            shape: BoxShape.circle,\n          ),\n          child: Icon(icon, color: Colors.blueAccent, size: 24),\n        ),\n        const SizedBox(width: 12),\n        Expanded(\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              Text(\n                title,\n                style: const TextStyle(\n                  fontSize: 22,\n                  fontWeight: FontWeight.bold,\n                  color: Colors.blueAccent,\n                ),\n              ),\n              const SizedBox(height: 4),\n              Text(\n                subtitle,\n                style: TextStyle(\n                  fontSize: 14,\n                  color: Colors.grey.shade600,\n                ),\n              ),\n            ],\n          ),\n        ),\n      ],\n    );\n  }\n\n  Widget _buildReviewSectionTitle(String title) {\n    return Padding(\n      padding: const EdgeInsets.only(top: 16, bottom: 12),\n      child: Text(\n        title,\n        style: const TextStyle(\n          fontSize: 18,\n          fontWeight: FontWeight.w600,\n          color: Colors.blueAccent,\n        ),\n      ),\n    );\n  }\n\n  Widget _buildReviewItem(String label, String value) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 8),\n      padding: const EdgeInsets.all(12),\n      decoration: BoxDecoration(\n        color: Colors.grey.shade50,\n        borderRadius: BorderRadius.circular(8),\n        border: Border.all(color: Colors.grey.shade200),\n      ),\n      child: Row(\n        crossAxisAlignment: CrossAxisAlignment.start,\n        children: [\n          Expanded(\n            flex: 2,\n            child: Text(\n              '$label:',\n              style: const TextStyle(\n                fontWeight: FontWeight.w500,\n                color: Colors.black87,\n              ),\n            ),\n          ),\n          Expanded(\n            flex: 3,\n            child: Text(\n              value.isEmpty ? 'Not provided' : value,\n              style: TextStyle(\n                color: value.isEmpty ? Colors.grey.shade500 : Colors.grey.shade800,\n              ),\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      resizeToAvoidBottomInset: true,\n      appBar: AppBar(\n        title: Text(\n          'Register as ${widget.role == 'caretaker' ? 'Caregiver' : 'User'}',\n          style: const TextStyle(\n            fontWeight: FontWeight.bold,\n            color: Colors.white,\n          ),\n        ),\n        backgroundColor: Colors.blueAccent,\n        elevation: 0,\n        centerTitle: true,\n        iconTheme: const IconThemeData(color: Colors.white),\n      ),\n      body: Container(\n        decoration: const BoxDecoration(\n          gradient: LinearGradient(\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n            colors: [\n              Colors.blueAccent,\n              Color(0xFFE3F2FD),\n              Colors.white,\n            ],\n            stops: [0.0, 0.2, 0.2],\n          ),\n        ),\n        child: Column(\n          children: [\n            // Progress Indicator\n            Container(\n              padding: const EdgeInsets.all(24.0),\n              decoration: BoxDecoration(\n                color: Colors.white,\n                borderRadius: const BorderRadius.only(\n                  bottomLeft: Radius.circular(30),\n                  bottomRight: Radius.circular(30),\n                ),\n                boxShadow: [\n                  BoxShadow(\n                    color: Colors.black.withOpacity(0.1),\n                    blurRadius: 10,\n                    offset: const Offset(0, 2),\n                  ),\n                ],\n              ),\n              child: _buildProgressIndicator(),\n            ),\n\n            // Form Content\n            Expanded(\n              child: Container(\n                margin: const EdgeInsets.all(16),\n                decoration: BoxDecoration(\n                  color: Colors.white,\n                  borderRadius: BorderRadius.circular(20),\n                  boxShadow: [\n                    BoxShadow(\n                      color: Colors.black.withOpacity(0.05),\n                      blurRadius: 20,\n                      offset: const Offset(0, 5),\n                    ),\n                  ],\n                ),\n                child: SingleChildScrollView(\n                  padding: const EdgeInsets.all(24.0),\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      if (_currentSection == FormSection.personal)\n                        _buildPersonalSection(),\n                      if (_currentSection == FormSection.address)\n                        _buildAddressSection(),\n                      if (_currentSection == FormSection.caretaker)\n                        _buildCaretakerSection(),\n                      if (_currentSection == FormSection.review)\n                        _buildReviewSection(),\n\n                      const SizedBox(height: 32),\n                    ],\n                  ),\n                ),\n              ),\n            ),\n\n            // Navigation Buttons\n            Container(\n              padding: const EdgeInsets.all(16.0),\n              decoration: BoxDecoration(\n                color: Colors.white,\n                boxShadow: [\n                  BoxShadow(\n                    color: Colors.black.withOpacity(0.1),\n                    blurRadius: 10,\n                    offset: const Offset(0, -2),\n                  ),\n                ],\n              ),\n              child: Row(\n                children: [\n                  // Back Button\n                  if (_currentSection != FormSection.personal)\n                    Expanded(\n                      child: OutlinedButton(\n                        onPressed: _previousSection,\n                        style: OutlinedButton.styleFrom(\n                          padding: const EdgeInsets.symmetric(vertical: 16),\n                          shape: RoundedRectangleBorder(\n                            borderRadius: BorderRadius.circular(12),\n                          ),\n                          side: BorderSide(color: Colors.blueAccent),\n                        ),\n                        child: const Row(\n                          mainAxisAlignment: MainAxisAlignment.center,\n                          children: [\n                            Icon(Icons.arrow_back_ios, size: 16),\n                            SizedBox(width: 8),\n                            Text(\n                              'Back',\n                              style: TextStyle(\n                                fontSize: 16,\n                                color: Colors.blueAccent,\n                              ),\n                            ),\n                          ],\n                        ),\n                      ),\n                    ),\n                  if (_currentSection != FormSection.personal)\n                    const SizedBox(width: 16),\n\n                  // Next/Submit Button\n                  Expanded(\n                    child: _loading\n                        ? Container(\n                            height: 56,\n                            decoration: BoxDecoration(\n                              color: Colors.blueAccent,\n                              borderRadius: BorderRadius.circular(12),\n                            ),\n                            child: const Center(\n                              child: SizedBox(\n                                width: 20,\n                                height: 20,\n                                child: CircularProgressIndicator(\n                                  strokeWidth: 2,\n                                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),\n                                ),\n                              ),\n                            ),\n                          )\n                        : ElevatedButton(\n                            onPressed: _nextSection,\n                            style: ElevatedButton.styleFrom(\n                              backgroundColor: Colors.blueAccent,\n                              padding: const EdgeInsets.symmetric(vertical: 16),\n                              shape: RoundedRectangleBorder(\n                                borderRadius: BorderRadius.circular(12),\n                              ),\n                              elevation: 2,\n                            ),\n                            child: Row(\n                              mainAxisAlignment: MainAxisAlignment.center,\n                              children: [\n                                Text(\n                                  _currentSection == FormSection.review\n                                      ? 'Complete Registration'\n                                      : 'Continue',\n                                  style: const TextStyle(\n                                    fontSize: 16,\n                                    fontWeight: FontWeight.w600,\n                                    color: Colors.white,\n                                  ),\n                                ),\n                                if (_currentSection != FormSection.review)\n                                  const Row(\n                                    children: [\n                                      SizedBox(width: 8),\n                                      Icon(Icons.arrow_forward_ios, size: 16),\n                                    ],\n                                  ),\n                              ],\n                            ),\n                          ),\n                  ),\n                ],\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildTextField(\n    TextEditingController controller,\n    String label,\n    IconData icon, {\n    bool obscureText = false,\n    TextInputType? keyboardType,\n    int maxLines = 1,\n  }) {\n    return Container(\n      margin: const EdgeInsets.only(bottom: 16),\n      child: TextField(\n        controller: controller,\n        maxLines: maxLines,\n        obscureText: obscureText,\n        keyboardType: keyboardType,\n        style: TextStyle(\n          fontSize: 16,\n          color: Colors.grey.shade800,\n        ),\n        decoration: InputDecoration(\n          labelText: label,\n          labelStyle: TextStyle(\n            color: Colors.grey.shade600,\n          ),\n          border: OutlineInputBorder(\n            borderRadius: BorderRadius.circular(12),\n            borderSide: BorderSide(color: Colors.grey.shade300),\n          ),\n          enabledBorder: OutlineInputBorder(\n            borderRadius: BorderRadius.circular(12),\n            borderSide: BorderSide(color: Colors.grey.shade300),\n          ),\n          focusedBorder: OutlineInputBorder(\n            borderRadius: BorderRadius.circular(12),\n            borderSide: const BorderSide(color: Colors.blueAccent, width: 2),\n          ),\n          filled: true,\n          fillColor: Colors.white,\n          prefixIcon: Icon(\n            icon,\n            color: Colors.blueAccent,\n          ),\n          contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "report_page.dart": {
      "_text": "// lib/report_page.dart (Fixed: Added type checks, mounted guards, fixed map colon)\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\n\nclass ReportPage extends StatefulWidget {\n  final String reporterRole; // 'user' or 'caretaker'\n  const ReportPage({super.key, required this.reporterRole});\n\n  @override\n  State<ReportPage> createState() => _ReportPageState();\n}\n\nclass _ReportPageState extends State<ReportPage> {\n  final TextEditingController _usernameController = TextEditingController();\n  final TextEditingController _titleController = TextEditingController();\n  final TextEditingController _descriptionController = TextEditingController();\n\n  final _firestore = FirebaseFirestore.instance;\n  final _auth = FirebaseAuth.instance;\n\n  bool _isLoading = true;\n  bool _isConnected = false;\n  String? _connectedUsername;\n  bool _reportSpecific = true; // true: report specific user, false: general/app issue\n  bool _userFound = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _loadConnectionInfo();\n  }\n\n  Future<void> _loadConnectionInfo() async {\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) {\n      setState(() => _isLoading = false);\n      return;\n    }\n\n    try {\n      final userDoc = await _firestore.collection(widget.reporterRole).doc(uid).get();\n      final data = userDoc.data();\n      final isConnected = data?['isConnected'] == true;\n      final connectionId = data?['currentConnectionId'] as String?;\n\n      if (isConnected && connectionId != null) {\n        final connectionDoc = await _firestore.collection('connections').doc(connectionId).get();\n        String? connectedUid;\n        if (widget.reporterRole == 'user') {\n          connectedUid = connectionDoc.data()?['caretaker_uid'];\n        } else {\n          connectedUid = connectionDoc.data()?['user_uid'];\n        }\n\n        if (connectedUid != null) {\n          final targetColl = widget.reporterRole == 'user' ? 'caretaker' : 'user';\n          final connectedDoc = await _firestore.collection(targetColl).doc(connectedUid).get();\n          final username = connectedDoc.data()?['username'] as String?;\n\n          if (username != null && mounted) {\n            setState(() {\n              _isConnected = true;\n              _connectedUsername = username;\n              _usernameController.text = username;\n              _userFound = true;\n            });\n          }\n        }\n      }\n    } catch (e) {\n      debugPrint('Error loading connection: $e');\n    } finally {\n      if (mounted) {\n        setState(() => _isLoading = false);\n      }\n    }\n  }\n\n  Future<void> _searchUser() async {\n    if (_usernameController.text.trim().isEmpty) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Please enter a username')),\n        );\n      }\n      return;\n    }\n\n    final coll = widget.reporterRole == 'user' ? 'caretaker' : 'user';\n    final snap = await _firestore\n        .collection(coll)\n        .where('username', isEqualTo: _usernameController.text.trim())\n        .get();\n\n    if (mounted) {\n      setState(() => _userFound = snap.docs.isNotEmpty);\n    }\n\n    if (!_userFound && mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('User not found')),\n      );\n    }\n  }\n\n  Future<void> _submitReport() async {\n    if (_titleController.text.trim().isEmpty) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Title is required')),\n        );\n      }\n      return;\n    }\n    if (_descriptionController.text.trim().isEmpty) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Description is required')),\n        );\n      }\n      return;\n    }\n\n    final uid = _auth.currentUser?.uid;\n    if (uid == null) return;\n\n    String? reportedUid;\n    String? reportedRole;\n\n    if (_reportSpecific) {\n      if (!_userFound) {\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('Please search and verify the user first')),\n          );\n        }\n        return;\n      }\n\n      final coll = widget.reporterRole == 'user' ? 'caretaker' : 'user';\n      final snap = await _firestore\n          .collection(coll)\n          .where('username', isEqualTo: _usernameController.text.trim())\n          .get();\n\n      if (snap.docs.isEmpty) return;\n\n      reportedUid = snap.docs.first.id;\n      reportedRole = coll;\n    } else {\n      // General report: reported_uid null, reported_role 'app'\n      reportedRole = 'app';\n    }\n\n    await _firestore.collection('reports').add({\n      'sender_uid': uid,\n      'sender_role': widget.reporterRole,\n      'reported_uid': reportedUid,\n      'reported_role': reportedRole,\n      'title': _titleController.text.trim(),\n      'description': _descriptionController.text.trim(),\n      'created_at': Timestamp.now(),\n      'seen': false,\n    });\n\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Report submitted successfully')),\n      );\n      Navigator.pop(context);\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final targetRole = widget.reporterRole == 'user' ? 'Caretaker' : 'User';\n\n    if (_isLoading) {\n      return const Scaffold(\n        body: Center(child: CircularProgressIndicator()),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Submit Report'),\n        backgroundColor: Colors.blueAccent,\n      ),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(24.0),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Report Type',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.blueAccent),\n            ),\n            const SizedBox(height: 16),\n            Row(\n              children: [\n                Expanded(\n                  child: ChoiceChip(\n                    label: const Text('Specific User'),\n                    selected: _reportSpecific,\n                    onSelected: (sel) {\n                      if (mounted) {\n                        setState(() => _reportSpecific = sel);\n                      }\n                    },\n                    selectedColor: Colors.blueAccent,\n                  ),\n                ),\n                const SizedBox(width: 8),\n                Expanded(\n                  child: ChoiceChip(\n                    label: const Text('App/General Issue'),\n                    selected: !_reportSpecific,\n                    onSelected: (sel) {\n                      if (mounted) {\n                        setState(() => _reportSpecific = !sel);\n                      }\n                    },\n                    selectedColor: Colors.blueAccent,\n                  ),\n                ),\n              ],\n            ),\n            const SizedBox(height: 24),\n            if (_reportSpecific) ...[\n              Text(\n                'Search $targetRole to Report',\n                style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),\n              ),\n              const SizedBox(height: 8),\n              if (_isConnected && _connectedUsername != null)\n                Padding(\n                  padding: const EdgeInsets.only(bottom: 16),\n                  child: Row(\n                    children: [\n                      const Icon(Icons.info_outline, color: Colors.blueAccent),\n                      const SizedBox(width: 8),\n                      Expanded(\n                        child: Text(\n                          'Connected $targetRole: @$_connectedUsername (prefilled)',\n                          style: TextStyle(color: Colors.grey.shade700),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              TextField(\n                controller: _usernameController,\n                decoration: InputDecoration(\n                  labelText: '$targetRole Username',\n                  suffixIcon: IconButton(\n                    icon: const Icon(Icons.search),\n                    onPressed: _searchUser,\n                  ),\n                ),\n              ),\n              const SizedBox(height: 16),\n              if (_userFound)\n                const Row(\n                  children: [\n                    Icon(Icons.check_circle, color: Colors.green),\n                    SizedBox(width: 8),\n                    Text('User found', style: TextStyle(color: Colors.green)),\n                  ],\n                ),\n            ],\n            const SizedBox(height: 24),\n            TextField(\n              controller: _titleController,\n              decoration: const InputDecoration(labelText: 'Report Title'),\n            ),\n            const SizedBox(height: 16),\n            TextField(\n              controller: _descriptionController,\n              decoration: const InputDecoration(labelText: 'Detailed Description'),\n              maxLines: 4,\n            ),\n            const SizedBox(height: 24),\n            ElevatedButton(\n              onPressed: _submitReport,\n              style: ElevatedButton.styleFrom(\n                backgroundColor: Colors.blueAccent,\n                minimumSize: const Size(double.infinity, 50),\n              ),\n              child: const Text('Submit Report'),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}",
      "_encoding": "utf-8"
    },
    "welcome_page.dart": {
      "_text": "import 'package:flutter/material.dart';\nimport 'package:flutter_animate/flutter_animate.dart';\nimport 'login_page.dart';\n\nclass WelcomePage extends StatelessWidget {\n  const WelcomePage({Key? key}) : super(key: key);\n\n  void _navigateTo(BuildContext context, String role) {\n    Navigator.push(\n      context,\n      MaterialPageRoute(\n        builder: (context) => LoginPage(role: role),\n      ),\n    );\n  }\n\n  void _showAdminDialog(BuildContext context) {\n  showDialog(\n    context: context,\n    builder: (context) => AlertDialog(\n      title: const Text('Admin Login'),\n      content: const Text('Proceed to admin login?'),\n      actions: [\n        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),\n        TextButton(onPressed: () {\n          Navigator.pop(context);\n          _navigateTo(context, 'admin');\n        }, child: const Text('Yes')),\n      ],\n    ),\n  );\n}\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: Container(\n        decoration: const BoxDecoration(\n          gradient: LinearGradient(\n            colors: [Colors.blueAccent, Colors.lightBlue],\n            begin: Alignment.topCenter,\n            end: Alignment.bottomCenter,\n          ),\n        ),\n        child: SafeArea(\n          child: Center(\n            child: Padding(\n              padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 32.0),\n              child: Column(\n                mainAxisAlignment: MainAxisAlignment.center,\n                children: [\n                  GestureDetector(\n                      onLongPress: () => _showAdminDialog(context),\n                      child: const Text(\n                        'Welcome to DVMA',\n                      style: TextStyle(\n                        fontSize: 32,\n                        fontWeight: FontWeight.bold,\n                        color: Colors.white,\n                        letterSpacing: 1.2,\n                        shadows: [\n                          Shadow(\n                            blurRadius: 10.0,\n                            color: Colors.black26,\n                            offset: Offset(2.0, 2.0),\n                          ),\n                        ],\n                      ),\n                      textAlign: TextAlign.center,\n                    ),\n                  ).animate().fadeIn(duration: 800.ms).slideY(begin: -0.2),\n                  const SizedBox(height: 16),\n                  const Text(\n                    'Select your role to continue',\n                    style: TextStyle(\n                      fontSize: 18,\n                      color: Colors.white70,\n                      fontStyle: FontStyle.italic,\n                    ),\n                  ).animate().fadeIn(duration: 1000.ms).slideY(begin: 0.2),\n                  const SizedBox(height: 48),\n                  _buildRoleButton(\n                    context: context,\n                    icon: Icons.person,\n                    label: 'I am a User',\n                    role: 'user',\n                    gradient: const LinearGradient(\n                      colors: [Colors.blue, Colors.blueAccent],\n                    ),\n                  ),\n                  const SizedBox(height: 20),\n                  _buildRoleButton(\n                    context: context,\n                    icon: Icons.volunteer_activism,\n                    label: 'I am a Caretaker',\n                    role: 'caretaker',\n                    gradient: const LinearGradient(\n                      colors: [Colors.green, Colors.greenAccent],\n                    ),\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n\n  Widget _buildRoleButton({\n    required BuildContext context,\n    required IconData icon,\n    required String label,\n    required String role,\n    required LinearGradient gradient,\n  }) {\n    return Card(\n      elevation: 8,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),\n      child: InkWell(\n        onTap: () => _navigateTo(context, role),\n        borderRadius: BorderRadius.circular(12),\n        child: Container(\n          decoration: BoxDecoration(\n            gradient: gradient,\n            borderRadius: BorderRadius.circular(12),\n          ),\n          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),\n          child: Row(\n            children: [\n              Icon(icon, size: 30, color: Colors.white),\n              const SizedBox(width: 16),\n              Expanded(\n                child: Text(\n                  label,\n                  style: const TextStyle(\n                    fontSize: 18,\n                    fontWeight: FontWeight.w600,\n                    color: Colors.white,\n                  ),\n                ),\n              ),\n              const Icon(Icons.arrow_forward, color: Colors.white),\n            ],\n          ),\n        ),\n      ),\n    ).animate().scale(duration: 600.ms, delay: 200.ms, curve: Curves.easeOut);\n  }\n}",
      "_encoding": "utf-8"
    }
  }
}